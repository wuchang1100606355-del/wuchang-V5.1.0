<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>æœ¬æ©Ÿä¸­æ§å°ï¼ˆå…©æ©Ÿäº’å‹•ï¼‰- wuchang.life</title>
  <style>
    :root {
      --screen-mode: 1; /* 1, 2, 3 è¢å¹•æ¨¡å¼ */
      --screen-width-1: 100vw;
      --screen-width-2: 50vw;
      --screen-width-3: 33.333vw;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 0;
      min-height: 100vh;
      overflow-x: auto;
    }
    
    /* å¤šè¢å¹•æ¨¡å¼å®¹å™¨ */
    .multi-screen-container {
      display: flex;
      width: 100%;
      min-height: 100vh;
      transition: all 0.3s ease;
    }
    
    .screen-panel {
      flex: 1;
      min-width: 0;
      padding: 20px;
      overflow-y: auto;
      overflow-x: hidden;
      height: 100vh;
    }
    
    /* å–®è¢å¹•æ¨¡å¼ */
    body[data-screens="1"] .multi-screen-container {
      flex-direction: column;
    }
    body[data-screens="1"] .screen-panel {
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    /* é›™è¢å¹•æ¨¡å¼ */
    body[data-screens="2"] .multi-screen-container {
      flex-direction: row;
    }
    body[data-screens="2"] .screen-panel {
      width: 50%;
      border-right: 2px solid rgba(255,255,255,0.2);
    }
    body[data-screens="2"] .screen-panel:last-child {
      border-right: none;
    }
    
    /* ä¸‰è¢å¹•æ¨¡å¼ */
    body[data-screens="3"] .multi-screen-container {
      flex-direction: row;
    }
    body[data-screens="3"] .screen-panel {
      width: 33.333%;
      border-right: 2px solid rgba(255,255,255,0.2);
    }
    body[data-screens="3"] .screen-panel:last-child {
      border-right: none;
    }
    
    .container {
      max-width: 100%;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      padding: 26px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      min-height: calc(100vh - 40px);
    }
    
    /* è¢å¹•æ¨¡å¼åˆ‡æ›å™¨ */
    .screen-mode-selector {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      background: white;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .screen-mode-selector button {
      padding: 8px 12px;
      border: 2px solid #667eea;
      background: white;
      color: #667eea;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 700;
      font-size: 12px;
      transition: all 0.2s;
    }
    .screen-mode-selector button:hover {
      background: #667eea;
      color: white;
    }
    .screen-mode-selector button.active {
      background: #667eea;
      color: white;
    }
    .screen-mode-selector .fullscreen-btn {
      margin-left: 8px;
      padding: 8px 14px;
      border-left: 2px solid #e9ecef;
      border-radius: 0;
      border-top-left-radius: 6px;
      border-bottom-left-radius: 6px;
    }
    .screen-mode-selector .fullscreen-btn.active {
      background: #28a745;
      border-color: #28a745;
      color: white;
    }
    .screen-mode-selector .fullscreen-btn:hover {
      background: #28a745;
      border-color: #28a745;
      color: white;
    }
    
    /* å…¨è¢å¹•æ¨¡å¼æ¨£å¼ */
    body.fullscreen {
      overflow: hidden;
    }
    body.fullscreen .screen-mode-selector {
      top: 10px;
      right: 10px;
    }
    body.fullscreen .multi-screen-container {
      height: 100vh;
    }
    body.fullscreen .screen-panel {
      height: 100vh;
      padding: 10px;
    }
    body.fullscreen .container {
      min-height: calc(100vh - 20px);
      border-radius: 10px;
    }
    
    /* ç¬¬äºŒå€‹è¢å¹•æ¨£å¼ */
    body[data-screen-index="2"] {
      background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
    }
    
    body[data-screen-index="2"] .screen-mode-selector {
      display: none; /* ç¬¬äºŒå€‹è¢å¹•éš±è—æ§åˆ¶æŒ‰éˆ• */
    }
    h1 { color: #333; text-align: center; margin-bottom: 8px; font-size: 2em; }
    .subtitle { text-align: center; color: #666; margin-bottom: 18px; }

    .banner {
      background: #fff3cd;
      border: 1px solid #ffe69c;
      color: #664d03;
      padding: 12px 14px;
      border-radius: 10px;
      margin-bottom: 18px;
      line-height: 1.4;
    }
    .banner strong { color: #5a3f00; }

    /* å…¨åŸŸï¼šç¶­è­·å±•å»¶é¢¨éšªæç¤ºï¼ˆå·¦ä¸‹è§’ï¼‰ */
    .maint-banner {
      position: fixed;
      left: 14px;
      bottom: 14px;
      z-index: 9999;
      max-width: min(520px, calc(100vw - 28px));
      background: rgba(255, 243, 205, 0.98);
      border: 1px solid #ffe69c;
      color: #664d03;
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
      font-weight: 800;
      line-height: 1.35;
      pointer-events: none; /* ä¸å½±éŸ¿ä»»ä½•æ“ä½œé»æ“Š */
    }
    .maint-banner.hidden { display: none; }
    .maint-banner .small { font-weight: 700; opacity: 0.9; font-size: 0.92em; }

    @keyframes maintPulse {
      0% { opacity: 1; }
      50% { opacity: 0.25; }
      100% { opacity: 1; }
    }
    .maint-banner.warn {
      animation: maintPulse 1.15s ease-in-out infinite;
    }
    @media (prefers-reduced-motion: reduce) {
      .maint-banner.warn { animation: none; }
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 14px;
      margin-bottom: 18px;
    }
    .card {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 14px;
      border: 1px solid #e9ecef;
    }
    .card h2 {
      color: #667eea;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 2px solid #667eea;
      font-size: 1.05em;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin-bottom: 18px;
    }
    .stat {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      padding: 14px;
      border-radius: 12px;
    }
    .stat .label { opacity: 0.9; font-size: 0.9em; }
    .stat .value { font-weight: 700; font-size: 1.05em; margin-top: 6px; word-break: break-all; }
    .pill {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.85em;
    }
    .pill.ok { background: #d1e7dd; color: #0f5132; }
    .pill.bad { background: #f8d7da; color: #842029; }
    .pill.unk { background: #e2e3e5; color: #41464b; }
    .pill.warn { background: #fff3cd; color: #664d03; }

    /* è¨­è¨ˆå•Ÿç”¨ï¼ˆè³‡è¨Šç´€éŒ„/ç•™ç—•ï¼‰æç¤º */
    .design-mode-box {
      background: #fff;
      border: 1px solid #e9ecef;
      border-radius: 12px;
      padding: 12px;
      margin-top: 10px;
    }

    label { display: block; margin: 10px 0 6px; color: #333; font-weight: 700; }
    input, textarea, select {
      width: 100%;
      border: 1px solid #ced4da;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
    }
    textarea { min-height: 140px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    
    /* éŸ¿æ‡‰å¼è¨­è¨ˆï¼šæ ¹æ“šè¢å¹•æ¨¡å¼èª¿æ•´ */
    @media (max-width: 900px) { 
      .row { grid-template-columns: 1fr; }
      body[data-screens="2"] .screen-panel,
      body[data-screens="3"] .screen-panel {
        width: 100% !important;
        border-right: none !important;
      }
      body[data-screens="2"] .multi-screen-container,
      body[data-screens="3"] .multi-screen-container {
        flex-direction: column !important;
      }
    }
    
    /* æ‰‹æ©ŸéŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 768px) {
      body {
        padding: 0;
        font-size: 14px;
      }
      
      .screen-mode-selector {
        top: 10px;
        right: 10px;
        padding: 8px;
        flex-wrap: wrap;
        max-width: calc(100vw - 20px);
      }
      
      .screen-mode-selector button {
        padding: 6px 10px;
        font-size: 11px;
        flex: 1;
        min-width: 60px;
      }
      
      .screen-panel {
        padding: 10px;
        height: 100vh;
      }
      
      .container {
        padding: 15px;
        border-radius: 10px;
        min-height: calc(100vh - 20px);
      }
      
      h1 {
        font-size: 1.5em;
        margin-bottom: 6px;
      }
      
      .subtitle {
        font-size: 0.9em;
        margin-bottom: 12px;
      }
      
      .banner {
        padding: 10px;
        font-size: 0.85em;
        margin-bottom: 12px;
      }
      
      .card {
        padding: 12px;
        margin-bottom: 12px;
      }
      
      .card h2 {
        font-size: 1em;
        margin-bottom: 8px;
      }
      
      .stats {
        grid-template-columns: 1fr;
        gap: 8px;
        margin-bottom: 12px;
      }
      
      .stat {
        padding: 12px;
      }
      
      .grid {
        grid-template-columns: 1fr;
        gap: 10px;
        margin-bottom: 12px;
      }
      
      label {
        font-size: 0.9em;
        margin: 8px 0 4px;
      }
      
      input, textarea, select {
        padding: 8px 10px;
        font-size: 14px;
        border-radius: 8px;
      }
      
      button {
        padding: 10px 12px;
        font-size: 13px;
        border-radius: 8px;
        min-height: 44px; /* è§¸æ§å‹å–„ */
      }
      
      .btns {
        gap: 8px;
        margin-top: 10px;
      }
      
      .chat {
        border-radius: 10px;
      }
      
      .chat-head {
        padding: 10px;
      }
      
      .chat-head .title {
        font-size: 0.95em;
      }
      
      .chat-head .sub {
        font-size: 11px;
      }
      
      .chat-body {
        padding: 10px;
        max-height: 300px;
      }
      
      .chat-foot {
        padding: 10px;
      }
      
      .chat-row {
        gap: 8px;
      }
      
      .chat-row input {
        padding: 10px;
        font-size: 14px;
        min-height: 44px;
      }
      
      .msg {
        margin: 8px 0;
        gap: 8px;
      }
      
      .msg .role {
        width: 50px;
        font-size: 0.85em;
      }
      
      .msg .bubble {
        padding: 8px 10px;
        font-size: 0.9em;
      }
      
      .log {
        padding: 10px;
        font-size: 11px;
        min-height: 150px;
      }
      
      .muted {
        font-size: 0.85em;
      }
      
      .small {
        font-size: 11px;
      }
      
      .smallhint {
        font-size: 11px;
        margin-top: 6px;
      }
      
      /* è§¸æ§å„ªåŒ– */
      button, .chip, .jobitem {
        touch-action: manipulation;
        -webkit-tap-highlight-color: rgba(102, 126, 234, 0.2);
      }
      
      /* éš±è—ä¸å¿…è¦çš„å…ƒç´ åœ¨å°è¢å¹• */
      .maint-banner {
        max-width: calc(100vw - 20px);
        left: 10px;
        bottom: 10px;
        padding: 8px 10px;
        font-size: 0.85em;
      }
    }
    
    /* è¶…å°è¢å¹•ï¼ˆæ‰‹æ©Ÿç›´å‘ï¼‰ */
    @media (max-width: 480px) {
      .screen-mode-selector {
        position: relative;
        top: auto;
        right: auto;
        margin: 10px;
        width: calc(100% - 20px);
      }
      
      .screen-mode-selector button {
        font-size: 10px;
        padding: 5px 8px;
      }
      
      h1 {
        font-size: 1.3em;
      }
      
      .container {
        padding: 12px;
      }
      
      .card {
        padding: 10px;
      }
      
      button {
        font-size: 12px;
        padding: 8px 10px;
      }
    }
    
    /* å¯¬è¢å¹•å„ªåŒ– */
    @media (min-width: 1920px) {
      body[data-screens="2"] .screen-panel {
        width: 50%;
      }
      body[data-screens="3"] .screen-panel {
        width: 33.333%;
      }
    }
    
    /* è¶…å¯¬è¢å¹•ï¼ˆä¸‰è¢å¹•ï¼‰å„ªåŒ– */
    @media (min-width: 3840px) {
      .container {
        max-width: 1280px;
      }
    }

    .btns { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
    button {
      border: 0;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 800;
      cursor: pointer;
      color: white;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    button.secondary {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    .muted { color: #6c757d; font-size: 0.9em; line-height: 1.4; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .log {
      background: #0b1020;
      color: #d7def2;
      border-radius: 12px;
      padding: 12px;
      min-height: 180px;
      white-space: pre-wrap;
      word-break: break-word;
      overflow: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
    }
    .log.human {
      font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
      font-size: 13px;
      line-height: 1.45;
    }
    .toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: #6c757d;
      font-size: 12px;
      user-select: none;
      margin: 8px 0 10px;
    }
    .toggle input { width: auto; }

    /* Little J Chat */
    .chat {
      background: #ffffff;
      border: 1px solid #e9ecef;
      border-radius: 12px;
      overflow: hidden;
    }
    .chat-head {
      padding: 12px 14px;
      background: linear-gradient(135deg, rgba(102,126,234,0.10) 0%, rgba(118,75,162,0.08) 100%);
      border-bottom: 1px solid #e9ecef;
    }
    .chat-head .title { font-weight: 1000; color: #333; }
    .chat-head .sub { color: #6c757d; font-size: 12px; margin-top: 4px; line-height: 1.35; }
    .chat-body {
      padding: 12px;
      max-height: 340px;
      overflow: auto;
      background: #f8f9fa;
    }
    .msg {
      display: flex;
      gap: 10px;
      margin: 10px 0;
      align-items: flex-start;
    }
    .msg .role {
      width: 64px;
      font-weight: 900;
      color: #333;
      flex: 0 0 auto;
    }
    .msg .bubble {
      flex: 1 1 auto;
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 12px;
      padding: 10px 12px;
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.45;
    }
    .msg.user .bubble {
      border-color: rgba(102,126,234,0.25);
      background: rgba(102,126,234,0.06);
    }
    .msg.assistant .bubble {
      border-color: rgba(245,87,108,0.22);
      background: rgba(245,87,108,0.05);
    }
    .chat-foot {
      padding: 12px;
      border-top: 1px solid #e9ecef;
      background: #fff;
    }
    .chat-row {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 10px;
      align-items: center;
    }
    .chat-row input {
      padding: 11px 12px;
      border-radius: 12px;
    }
    .chipbar { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .chip {
      border: 1px solid rgba(0,0,0,0.10);
      background: white;
      border-radius: 999px;
      padding: 6px 10px;
      font-weight: 900;
      font-size: 12px;
      cursor: pointer;
      color: #333;
    }
    .chip:hover { background: rgba(0,0,0,0.03); }
    .smallhint { color: #6c757d; font-size: 12px; margin-top: 8px; line-height: 1.35; }
    .joblist { background: white; border: 1px solid #e9ecef; border-radius: 12px; padding: 10px; max-height: 260px; overflow:auto; }
    .jobitem { padding: 8px 10px; border-radius: 10px; cursor: pointer; border: 1px solid rgba(0,0,0,0.06); background: rgba(255,255,255,0.9); margin-bottom: 8px; }
    .jobitem:hover { background: rgba(102,126,234,0.06); border-color: rgba(102,126,234,0.18); }
    .jobitem .top { display:flex; justify-content: space-between; gap: 10px; align-items:center; }
    .jobitem .id { font-weight: 1000; color: #333; }
    .jobitem .type { font-weight: 900; color: #667eea; font-size: 12px; }
    .jobitem .meta { color:#6c757d; font-size: 12px; margin-top: 4px; line-height:1.35; }
    .jobdetail { width: 100%; min-height: 160px; }
    .small { font-size: 12px; }

    /* Authz modal */
    .authz-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 9999;
    }
    .authz-modal {
      background: #ffffff;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,0.10);
      box-shadow: 0 20px 80px rgba(0,0,0,0.40);
      width: min(980px, 96vw);
      max-height: 86vh;
      overflow: auto;
      padding: 14px;
    }
    .authz-modal .head {
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .authz-modal .title {
      font-weight: 1000;
      color: #333;
      font-size: 1.05em;
    }
    .authz-modal .close {
      background: rgba(0,0,0,0.06);
      color: #333;
      border: 1px solid rgba(0,0,0,0.10);
    }
    .authz-modal .hint {
      color: #6c757d;
      font-size: 12px;
      line-height: 1.35;
      margin-top: 6px;
    }

    /* Central Map Control Center */
    .grid .card.wide { grid-column: 1 / -1; }
    .cc-wrap {
      display: grid;
      grid-template-columns: 320px 1fr 360px;
      gap: 12px;
      align-items: stretch;
    }
    @media (max-width: 1100px) {
      .cc-wrap { grid-template-columns: 1fr; }
    }

    .cc-panel {
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 12px;
      padding: 12px;
    }
    .cc-panel h3 {
      font-size: 1em;
      color: #333;
      margin-bottom: 10px;
    }

    .cc-map {
      position: relative;
      background: radial-gradient(circle at 50% 40%, rgba(102,126,234,0.20), rgba(118,75,162,0.06) 60%, rgba(255,255,255,1) 100%);
      border: 1px solid #e9ecef;
      border-radius: 12px;
      overflow: hidden;
      min-height: 440px;
    }
    .cc-map-inner {
      position: absolute;
      inset: 12px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 10px;
    }
    .cc-zone {
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.08);
      background: rgba(255,255,255,0.85);
      padding: 12px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
    }
    .cc-zone:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.10);
    }
    .cc-zone.active {
      outline: 3px solid rgba(102,126,234,0.55);
      box-shadow: 0 14px 35px rgba(102,126,234,0.22);
    }
    .cc-zone .title { font-weight: 900; color: #333; }
    .cc-zone .desc { color: #6c757d; font-size: 0.9em; margin-top: 6px; line-height: 1.35; }
    .cc-zone .meta { margin-top: 10px; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }

    .cc-ring {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 360px;
      height: 360px;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }
    .cc-ring button {
      pointer-events: auto;
      position: absolute;
      width: 120px;
      border-radius: 999px;
      padding: 8px 10px;
      font-weight: 900;
      font-size: 12px;
      background: linear-gradient(135deg, rgba(240,147,251,0.95) 0%, rgba(245,87,108,0.95) 100%);
      box-shadow: 0 10px 25px rgba(245,87,108,0.25);
    }
    .cc-ring button.active {
      background: linear-gradient(135deg, rgba(102,126,234,0.98) 0%, rgba(118,75,162,0.98) 100%);
      box-shadow: 0 14px 35px rgba(102,126,234,0.28);
    }
    .cc-center-badge {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 170px;
      height: 170px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.08);
      background: rgba(255,255,255,0.92);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 10px;
    }
    .cc-center-badge .big { font-weight: 1000; color: #333; }
    .cc-center-badge .small { color: #6c757d; margin-top: 6px; }

    .cc-tree {
      max-height: 440px;
      overflow: auto;
      padding-right: 6px;
    }
    .cc-tree ul { list-style: none; padding-left: 16px; }
    .cc-tree li { margin: 6px 0; }
    .cc-tree .item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .cc-tree .item:hover { background: rgba(102,126,234,0.10); }
    .cc-tree .item.active { background: rgba(102,126,234,0.18); }
    .cc-dot { width: 10px; height: 10px; border-radius: 999px; background: #adb5bd; }
    .cc-dot.ok { background: #2fb344; }
    .cc-dot.warn { background: #f59f00; }
    .cc-dot.bad { background: #e03131; }
    .cc-dot.offline { background: #495057; }
    .cc-tree .name { font-weight: 800; color: #333; font-size: 13px; }
    .cc-tree .hint { color: #6c757d; font-size: 12px; }

    .cc-kv { display: grid; grid-template-columns: 120px 1fr; gap: 8px 10px; margin-top: 10px; }
    .cc-kv .k { color: #6c757d; font-weight: 800; }
    .cc-kv .v { color: #333; word-break: break-word; }
    .cc-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
    .cc-actions button { padding: 9px 12px; font-size: 12px; }
    .cc-breadcrumb { color: #6c757d; font-size: 12px; line-height: 1.4; }
    .cc-breadcrumb .mono { font-weight: 900; }
  </style>
</head>
<body data-screens="1">
  <!-- è¢å¹•æ¨¡å¼åˆ‡æ›å™¨ -->
  <div class="screen-mode-selector">
    <button data-screens="1" class="active" title="å–®è¢å¹•æ¨¡å¼">1 è¢å¹•</button>
    <button data-screens="2" title="é›™è¢å¹•æ¨¡å¼">2 è¢å¹•</button>
    <button data-screens="3" title="ä¸‰è¢å¹•æ¨¡å¼">3 è¢å¹•</button>
    <button class="fullscreen-btn" id="fullscreenToggle" title="å…¨è¢å¹•æ¨¡å¼">â›¶ å…¨è¢å¹•</button>
    <button class="fullscreen-btn" id="dualScreenBtn" title="åœ¨å…©å€‹è¢å¹•ä¸Šåˆ†åˆ¥æ‰“é–‹å…¨è¢å¹•è¦–çª—">ğŸ–¥ï¸ é›™è¢å¹•å…¨è¢å¹•</button>
  </div>
  
  <div class="multi-screen-container">
    <div class="screen-panel">
      <div class="container">
    <h1>æœ¬æ©Ÿä¸­æ§å°ï¼ˆå…©æ©Ÿäº’å‹•ï¼‰</h1>
    <div class="subtitle">æŠŠã€Œæœ¬æ©Ÿ â†” ä¼ºæœå™¨ã€äº’å‹•ç‹€æ…‹èˆ‡ç¨½æ ¸é›†ä¸­åœ¨åŒä¸€é ï¼ˆç¹ä¸­ï¼‰</div>

    <div class="banner">
      <strong>ç¡¬è¦å‰‡ï¼š</strong>åªè¦å‡ºç¾ã€Œé—œéµç¢ºèªç„¡å›æ‡‰/ç„¡æ³•é©—è­‰ã€ï¼Œ<strong>ä¸å¾—é€²è¡Œé«˜é¢¨éšªä½œæ¥­</strong>ï¼ˆæ¨é€/æ¸…å¿«å–/é‡å»ºç´¢å¼•/éƒ¨ç½²/é‡å•Ÿï¼‰ã€‚æœ¬é é¢æŒ‰éˆ•æœƒæŠŠé€™æ¢è¦å‰‡æ”¾åœ¨ç¬¬ä¸€é †ä½ã€‚
      <div class="small muted" style="margin-top:8px;">æç¤ºï¼šæ­¤é é¢ç”±æœ¬æ©Ÿ `local_control_center.py` æœå‹™æä¾›ï¼ˆåƒ… 127.0.0.1ï¼‰ã€‚</div>
      <div class="row" style="margin-top:10px;">
        <div>
          <label style="margin-top:0;">ç›®å‰èº«åˆ†/ä»‹é¢</label>
          <select id="uiProfile">
            <option value="ops_admin">ç¶­é‹/ç®¡ç†ï¼ˆOps/Adminï¼‰</option>
            <option value="org_association">å”æœƒï¼ˆæ²»ç†/å°å¤–ï¼‰</option>
            <option value="org_fund">åŸºé‡‘æ± ï¼ˆä»ç¾©åº—ï¼‰</option>
            <option value="org_sponsor">è´ŠåŠ©æ–¹ï¼ˆé‡æ–°åº—ï¼‰</option>
            <option value="device_kiosk">è¨­å‚™ç«¯ï¼ˆåªè®€çœ‹æ¿ï¼‰</option>
            <option value="public_readonly">å…¬é–‹è¦–åœ–ï¼ˆåªè®€ï¼‰</option>
          </select>
          <div class="muted small" style="margin-top:6px;">
            èªªæ˜ï¼šä¸åŒèº«åˆ†æœƒçœ‹åˆ°ä¸åŒæ¨¡çµ„ï¼Œä¸¦å¥—ç”¨ä¸åŒå°Jæ¬Šé™ï¼ˆå”¯è®€/å¯å»ºå‘½ä»¤å–®/å¯é›²ç«¯å°è©±ç­‰ï¼‰ã€‚
          </div>
        </div>
        <div>
          <label style="margin-top:0;">èº«åˆ†æ¬Šé™æ‘˜è¦ï¼ˆå”¯è®€ï¼‰</label>
          <input id="uiProfilePolicy" readonly />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label style="margin-top:0;">å¸³è™Ÿè™Ÿç¢¼ï¼ˆæ±ºå®šå¯åšä»€éº¼ï¼‰</label>
          <div class="row" style="grid-template-columns: 1fr 1fr; gap:10px;">
            <input id="accountId" placeholder="ä¾‹å¦‚ï¼š1001 / 2001 / 9000" />
            <input id="accountPin" placeholder="PINï¼ˆå¯é¸ï¼‰" type="password" />
          </div>
          <div class="btns">
            <button id="btnLogin" class="secondary">ç™»å…¥</button>
            <button id="btnLogout" class="secondary">ç™»å‡º</button>
            <button id="btnAuthRefresh" class="secondary">åˆ·æ–°ç‹€æ…‹</button>
          </div>
          <div class="muted small" id="authHint" style="margin-top:6px;"></div>
        </div>
        <div>
          <label style="margin-top:0;">ç›®å‰å¸³è™Ÿç‹€æ…‹</label>
          <input id="authStatus" readonly />
          <div class="muted small" style="margin-top:6px;">
            èªªæ˜ï¼šè‹¥å·²å•Ÿç”¨å¸³è™Ÿæ”¿ç­–ï¼ˆWorkspace å…§çš„ <span class="mono">accounts_policy.json</span>ï¼‰ï¼Œæœªç™»å…¥æœƒè¢«é™åˆ¶å¤šæ•¸æ“ä½œï¼ˆPII/å»ºå–®/å¯«å…¥ç­‰ï¼‰ã€‚
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label style="margin-top:0;">ä¸å¯è­˜åˆ¥å€‹è³‡ï¼ˆä¾å¸³è™Ÿç·¨ç¢¼ï¼Œä¾›ç¿’æ…£åˆ†æ/ç³»çµ±å‡ç´šï¼‰</label>
          <div class="muted small">
            åªå­˜ã€Œæ€§åˆ¥ / å¹´é½¡å€é–“ / ç¿’æ…£æ‘˜è¦ã€ç­‰ä¸å¯è­˜åˆ¥è³‡è¨Šï¼ˆä¸å­˜ç”Ÿæ—¥/é›»è©±/Emailï¼‰ã€‚è³‡æ–™æœƒå¯«å…¥ Google Drive åŒæ­¥å¤¾çš„ç§å¯†æª”æ¡ˆã€‚
          </div>
          <div style="margin-top:10px; background:#fff; border:1px dashed #dee2e6; border-radius:12px; padding:10px;">
            <div class="muted small" style="margin-bottom:6px;">
              <strong>ä½¿ç”¨å‰å¿…é ˆåŒæ„ï¼š</strong>ç³»çµ±æœƒå‘ŠçŸ¥ã€Œç¯„åœ/ç”¨é€”/ä¿å­˜æœŸé™ã€ï¼Œä½ åœ¨æœ¬æ©Ÿä»‹é¢æˆ–è¨­å‚™ç«¯ç¢ºèªåŒæ„å¾Œï¼Œç³»çµ±æ‰æœƒæœ‰ä½¿ç”¨æ¬Šã€‚
            </div>
            <details style="margin-top:8px;">
              <summary class="muted small" style="cursor:pointer;">æŸ¥çœ‹ã€Œç”¨é€”/ç¯„åœ/ä½¿ç”¨æ¬Šåˆ©/ä¸æ”¶é›†é …ç›®ã€ï¼ˆå¿…è®€ï¼‰</summary>
              <pre id="consentPolicyText" class="mono" style="white-space:pre-wrap; background:#f8f9fa; border:1px solid #e9ecef; border-radius:10px; padding:10px; margin-top:8px; max-height: 240px; overflow:auto;"></pre>
            </details>
            <div class="row" style="margin-top:6px;">
              <div>
                <label style="margin-top:0;">åŒæ„ç‹€æ…‹</label>
                <input id="consentStatus" readonly />
              </div>
              <div>
                <label style="margin-top:0;">ä¿å­˜æœŸé™ï¼ˆå¤©ï¼‰</label>
                <input id="consentRetention" readonly />
              </div>
            </div>
            <label class="toggle" style="margin-top:8px;">
              <input type="checkbox" id="consentAck" />
              æˆ‘å·²é–±è®€ä¸¦åŒæ„ä¸Šè¿°ç”¨é€”èˆ‡ç¯„åœï¼ˆå¯éš¨æ™‚æ’¤å›ï¼‰
            </label>
            <div class="btns">
              <button id="btnConsentGrant">åŒæ„ä¸¦å•Ÿç”¨</button>
              <button id="btnConsentRevoke" class="secondary">æ’¤å›åŒæ„</button>
              <button id="btnConsentRefresh" class="secondary">åˆ·æ–°åŒæ„ç‹€æ…‹</button>
            </div>
            <div class="muted small" id="consentHint" style="margin-top:6px;"></div>
          </div>
          <div class="row" style="margin-top:10px;">
            <div>
              <label style="margin-top:0;">æ€§åˆ¥</label>
              <select id="nonidGender">
                <option value="">ï¼ˆæœªå¡«ï¼‰</option>
                <option value="unknown">æœªçŸ¥</option>
                <option value="male">ç”·æ€§</option>
                <option value="female">å¥³æ€§</option>
                <option value="non_binary">éäºŒå…ƒ</option>
                <option value="other">å…¶ä»–</option>
              </select>
            </div>
            <div>
              <label style="margin-top:0;">å¹´é½¡ï¼ˆå€é–“ï¼‰</label>
              <select id="nonidAgeBand">
                <option value="">ï¼ˆæœªå¡«ï¼‰</option>
                <option value="0-12">0â€“12</option>
                <option value="13-17">13â€“17</option>
                <option value="18-24">18â€“24</option>
                <option value="25-34">25â€“34</option>
                <option value="35-44">35â€“44</option>
                <option value="45-54">45â€“54</option>
                <option value="55-64">55â€“64</option>
                <option value="65+">65+</option>
              </select>
            </div>
          </div>
          <div>
            <label>ç¿’æ…£æ‘˜è¦ï¼ˆä¸å¯è­˜åˆ¥ï¼‰</label>
            <textarea id="nonidHabits" class="mono" style="min-height: 72px;" placeholder="ä¾‹å¦‚ï¼šå¸¸ç”¨åŠŸèƒ½ã€åå¥½æ“ä½œæ–¹å¼ã€å¸¸è¦‹å•é¡Œï¼ˆä¸è¦æ”¾å€‹äººé›»è©±/Email/ä½å€/ç”Ÿæ—¥ï¼‰"></textarea>
          </div>
          <div class="btns">
            <button id="btnNonidLoad" class="secondary">è¼‰å…¥ï¼ˆWorkspaceï¼‰</button>
            <button id="btnNonidSave">å„²å­˜ï¼ˆWorkspaceï¼‰</button>
            <button id="btnNonidClear" class="secondary">æ¸…é™¤</button>
          </div>
          <div class="muted small" id="nonidHint" style="margin-top:6px;"></div>
        </div>
      </div>
    </div>

    <div class="stats">
      <div class="stat">
        <div class="label">æœ¬æ©Ÿç‹€æ…‹</div>
        <div class="value"><span id="localStatus" class="pill unk">æœªçŸ¥</span></div>
      </div>
      <div class="stat">
        <div class="label">ä¼ºæœå™¨å¥åº·ï¼ˆhealth URLï¼‰</div>
        <div class="value"><span id="serverStatus" class="pill unk">æœªæª¢æŸ¥</span></div>
      </div>
      <div class="stat">
        <div class="label">DNS / _acme-challengeï¼ˆæ†‘è­‰å‰ç½®ï¼‰</div>
        <div class="value"><span id="dnsStatus" class="pill unk">æœªæª¢æŸ¥</span></div>
      </div>
      <div class="stat">
        <div class="label">ç¨½æ ¸ï¼ˆrisk_action_audit.jsonlï¼‰</div>
        <div class="value"><span id="auditStatus" class="pill unk">æœªè¼‰å…¥</span></div>
      </div>
      <div class="stat">
        <div class="label">ç¨‹åºé©—è­‰ï¼ˆå°J ç¨½æ ¸ï¼‰</div>
        <div class="value"><span id="verifyStatus" class="pill unk">æœªæª¢æŸ¥</span></div>
      </div>
    </div>

    <div class="card wide" data-section="router_monitor">
      <h2>ğŸŒ è·¯ç”±å™¨ç›£æ§ï¼ˆç³»çµ±è³‡æºï¼‰</h2>
      <div class="muted">
        è·¯ç”±å™¨ï¼šASUS RT-BE86U | æœ¬åœ° IP: 192.168.50.84 | å¤–éƒ¨ IP: 220.135.21.74 | DDNS: coffeeLofe.asuscomm.com
      </div>
      
      <div style="margin-top: 16px;">
        <div class="row" style="grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
          <div style="background: #f8f9fa; border-radius: 12px; padding: 16px;">
            <div class="muted small">é€£ç·šè£ç½®æ•¸é‡</div>
            <div style="font-size: 32px; font-weight: bold; color: #667eea; margin-top: 8px;" id="routerDeviceCount">-</div>
            <div class="muted small" style="margin-top: 4px;" id="routerDeviceDetails">è¼‰å…¥ä¸­...</div>
          </div>
          <div style="background: #f8f9fa; border-radius: 12px; padding: 16px;">
            <div class="muted small">ç›®å‰ç¶²è·¯æµé‡</div>
            <div style="font-size: 24px; font-weight: bold; color: #28a745; margin-top: 8px;">
              <span id="routerUploadSpeed">-</span> â†‘ / <span id="routerDownloadSpeed">-</span> â†“
            </div>
            <div class="muted small" style="margin-top: 4px;">Mbps</div>
          </div>
        </div>
        
        <div style="background: #fff; border: 1px solid #e9ecef; border-radius: 12px; padding: 16px; margin-top: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h3 style="margin: 0; font-size: 16px;">ç¶²è·¯æµé‡åœ–ï¼ˆæœ€è¿‘ 30 åˆ†é˜ï¼‰</h3>
            <button id="btnRefreshRouter" class="secondary" style="padding: 6px 12px; font-size: 12px;">åˆ·æ–°</button>
          </div>
          <canvas id="routerTrafficChart" style="max-height: 300px; width: 100%;"></canvas>
        </div>
        
        <div style="margin-top: 16px;">
          <details>
            <summary style="cursor: pointer; color: #667eea; font-weight: 500;">é€£ç·šè£ç½®åˆ—è¡¨</summary>
            <div id="routerDeviceList" style="margin-top: 12px; max-height: 400px; overflow-y: auto;">
              <div class="muted">è¼‰å…¥ä¸­...</div>
            </div>
          </details>
        </div>
        
        <div class="muted small" id="routerStatusHint" style="margin-top: 12px;"></div>
      </div>
    </div>

    <div class="card wide" style="margin-bottom:18px;" data-section="map">
      <h2>ä¸­å¤®å€å¡Šï¼šå¤§å‹åœ°åœ–æ¨¡çµ„ï¼ˆç’°ç‹€åˆ‡æ› / æ¨¹ç‹€å°è¦½ / ç‹€æ…‹æ•¸æ“šï¼‰</h2>
      <div class="muted">
        é€™æ˜¯ã€Œæœ¬æ©Ÿä¸­æ§ã€çš„äº’å‹•è¦–è¦ºå±¤ï¼šå¤–åœˆç”¨ä¾†åˆ‡æ›æ¨¡çµ„ï¼ˆç’°ç‹€ï¼‰ï¼Œå·¦å´ç”¨æ¨¹ç‹€åœ–é»é¸ä¸Šä¸€å±¤/ä¸‹ä¸€å±¤ï¼Œå³å´çœ‹ç‹€æ…‹èˆ‡æ•¸æ“šä¸¦å¯åˆ‡æ›ã€‚
        <strong>æ³¨æ„ï¼š</strong>æ­¤æ¨¡çµ„é è¨­åªåšã€Œç‹€æ…‹é¡¯ç¤ºèˆ‡ç®¡ç†ã€ï¼Œä¸æœƒè‡ªå‹•åŸ·è¡Œé«˜é¢¨éšªå‹•ä½œï¼›ä»»ä½•æ¨é€ä»å—ã€Œç„¡å›æ‡‰ï¼ç¦æ­¢ã€ç¡¬è¦å‰‡ç´„æŸã€‚
      </div>

      <div class="cc-actions" style="margin-top:12px;">
        <label style="margin:0;">
          <span class="muted small">é¡¯ç¤ºæ¨¡å¼</span>
          <select id="ccViewMode" style="max-width:260px;">
            <option value="module">æ¨¡çµ„ç‹€æ…‹ï¼ˆç¯€é»æœ¬èº«ï¼‰</option>
            <option value="platform">å¹³å°ç‹€æ…‹ï¼ˆèšåˆåˆ°ä¸Šä¸€å±¤ï¼‰</option>
          </select>
        </label>
        <button id="ccBtnUp" class="secondary">ä¸Šä¸€å±¤</button>
        <button id="ccBtnDown" class="secondary">ä¸‹ä¸€å±¤</button>
        <button id="ccBtnReset">å›åˆ°å¹³å°ç¸½è¦½</button>
      </div>

      <div class="cc-wrap" style="margin-top:12px;">
        <div class="cc-panel">
          <h3>æ¨¹ç‹€åœ–ï¼ˆé»é¸åˆ‡æ›ï¼‰</h3>
          <div id="ccBreadcrumb" class="cc-breadcrumb">ï¼ˆå°šæœªè¼‰å…¥ï¼‰</div>
          <div id="ccTree" class="cc-tree" style="margin-top:10px;"></div>
        </div>

        <div class="cc-map" id="ccMap">
          <div class="cc-map-inner">
            <div class="cc-zone" data-zone="A">
              <div>
                <div class="title" id="ccZoneATitle">ï¼ˆè¼‰å…¥ä¸­ï¼‰</div>
                <div class="desc" id="ccZoneADesc">â€”</div>
              </div>
              <div class="meta">
                <span class="pill unk" id="ccZoneAState">æœªçŸ¥</span>
                <span class="muted small mono" id="ccZoneAMetric">â€”</span>
              </div>
            </div>
            <div class="cc-zone" data-zone="B">
              <div>
                <div class="title" id="ccZoneBTitle">ï¼ˆè¼‰å…¥ä¸­ï¼‰</div>
                <div class="desc" id="ccZoneBDesc">â€”</div>
              </div>
              <div class="meta">
                <span class="pill unk" id="ccZoneBState">æœªçŸ¥</span>
                <span class="muted small mono" id="ccZoneBMetric">â€”</span>
              </div>
            </div>
            <div class="cc-zone" data-zone="C">
              <div>
                <div class="title" id="ccZoneCTitle">ï¼ˆè¼‰å…¥ä¸­ï¼‰</div>
                <div class="desc" id="ccZoneCDesc">â€”</div>
              </div>
              <div class="meta">
                <span class="pill unk" id="ccZoneCState">æœªçŸ¥</span>
                <span class="muted small mono" id="ccZoneCMetric">â€”</span>
              </div>
            </div>
            <div class="cc-zone" data-zone="D">
              <div>
                <div class="title" id="ccZoneDTitle">ï¼ˆè¼‰å…¥ä¸­ï¼‰</div>
                <div class="desc" id="ccZoneDDesc">â€”</div>
              </div>
              <div class="meta">
                <span class="pill unk" id="ccZoneDState">æœªçŸ¥</span>
                <span class="muted small mono" id="ccZoneDMetric">â€”</span>
              </div>
            </div>
          </div>

          <div class="cc-ring" id="ccRing"></div>

          <div class="cc-center-badge">
            <div class="big" id="ccCenterTitle">å¹³å°ç¸½è¦½</div>
            <div class="small">
              <span id="ccCenterState" class="pill unk">æœªçŸ¥</span>
              <div class="small muted" style="margin-top:6px;">é»å¤–åœˆæˆ–æ¨¹ç‹€åœ–åˆ‡æ›</div>
            </div>
          </div>
        </div>

        <div class="cc-panel">
          <h3>ç‹€æ…‹èˆ‡æ•¸æ“šï¼ˆå¯åˆ‡æ›ï¼‰</h3>
          <div class="row">
            <div>
              <label style="margin-top:0;">ç¯€é»ç‹€æ…‹</label>
              <select id="ccNodeStatus">
                <option value="ok">æ­£å¸¸ï¼ˆOKï¼‰</option>
                <option value="warn">è­¦å‘Šï¼ˆWARNï¼‰</option>
                <option value="bad">ç•°å¸¸ï¼ˆBADï¼‰</option>
                <option value="offline">é›¢ç·šï¼ˆOFFLINEï¼‰</option>
              </select>
            </div>
            <div>
              <label style="margin-top:0;">å¹³å°ç‹€æ…‹ï¼ˆé¡¯ç¤ºï¼‰</label>
              <input id="ccPlatformStatus" readonly />
            </div>
          </div>

          <div class="cc-kv" id="ccDetails"></div>

          <div style="margin-top:12px; background:#fff; border:1px solid #e9ecef; border-radius:12px; padding:12px;">
            <h3 style="margin:0 0 8px; font-size: 1em; color:#333;">ç®¡ç†å“¡è¯ç¹«ï¼ˆå€‹è³‡åˆ†ç´šï¼šå¯è­˜åˆ¥ / ä¸å¯è­˜åˆ¥ï¼‰</h3>
            <div class="muted small">
              å¯è­˜åˆ¥ï¼ˆå§“å/é›»è©±/Emailï¼‰æœƒå¯«å…¥ä½ çš„ Google Drive åŒæ­¥è³‡æ–™å¤¾ï¼ˆ<span class="mono">WUCHANG_WORKSPACE_OUTDIR</span> æˆ– <span class="mono">WUCHANG_PII_OUTDIR</span>ï¼‰çš„ç§å¯†æª”ï¼›
              ä¸å¯è­˜åˆ¥ï¼ˆè§’è‰²/å‚™è¨»ï¼‰å¯ç”¨æ–¼å°å¤–æ‘˜è¦ï¼Œä½†ä»å»ºè­°åªæ”¾å¿…è¦è³‡è¨Šã€‚
            </div>
            <div class="row" style="margin-top:10px;">
              <div>
                <label style="margin-top:0;">å€‹è³‡åˆ†é¡</label>
                <select id="piiClass">
                  <option value="identifiable">å¯è­˜åˆ¥ï¼ˆç§å¯†ï¼‰</option>
                  <option value="non_identifiable">ä¸å¯è­˜åˆ¥ï¼ˆå¯ç”¨æ–¼æ‘˜è¦ï¼‰</option>
                </select>
              </div>
              <div>
                <label style="margin-top:0;">æç¤º</label>
                <input id="piiClassHint" readonly />
              </div>
            </div>
            <div class="row" style="margin-top:10px;">
              <div>
                <label style="margin-top:0;">å§“åï¼ˆå¯è­˜åˆ¥ï¼‰</label>
                <input id="piiName" placeholder="ï¼ˆç§å¯†ï¼‰" />
              </div>
              <div>
                <label style="margin-top:0;">è§’è‰²ï¼ˆä¸å¯è­˜åˆ¥ï¼‰</label>
                <input id="piiRole" placeholder="admin / ops / netops..." />
              </div>
            </div>
            <div class="row">
              <div>
                <label>é›»è©±ï¼ˆå¯è­˜åˆ¥ï¼‰</label>
                <input id="piiPhone" placeholder="ï¼ˆç§å¯†ï¼‰" />
              </div>
              <div>
                <label>Emailï¼ˆå¯è­˜åˆ¥ï¼‰</label>
                <input id="piiEmail" placeholder="ï¼ˆç§å¯†ï¼‰" />
              </div>
            </div>
            <div class="row">
              <div>
                <label>å§“åé®ç½©æ¯”å°ï¼ˆä¾‹å¦‚ï¼šç‹ï¼Šï¼‰</label>
                <input id="piiMatchNameMask" placeholder="ä¾‹å¦‚ï¼šç‹ï¼Š / ç‹xx / ç‹**" />
              </div>
              <div>
                <label>æ‰‹æ©Ÿå¾Œå››ç¢¼</label>
                <input id="piiMatchPhoneLast4" placeholder="ä¾‹å¦‚ï¼š1234" />
              </div>
            </div>
            <div class="btns">
              <button id="btnPiiMatch" class="secondary">éƒ¨åˆ†å€‹è³‡æ¯”å°ï¼ˆä¸é¡¯ç¤ºæ˜æ–‡ï¼‰</button>
            </div>
            <div>
              <label>å‚™è¨»ï¼ˆä¸å¯è­˜åˆ¥ï¼‰</label>
              <textarea id="piiNote" class="mono" style="min-height: 64px;" placeholder="ä¾‹å¦‚ï¼šå€¼ç­æ–¹å¼ã€è¯çµ¡çª—å£é¡å‹ï¼ˆä¸è¦æ”¾å€‹äººé›»è©±/Emailï¼‰"></textarea>
            </div>
            <div class="btns">
              <button id="btnPiiLoad" class="secondary">è¼‰å…¥ï¼ˆWorkspaceï¼‰</button>
              <button id="btnPiiSave">å„²å­˜ï¼ˆWorkspaceï¼‰</button>
              <button id="btnPiiClear" class="secondary">æ¸…é™¤ï¼ˆWorkspaceï¼‰</button>
            </div>
            <div class="muted small" id="piiHint" style="margin-top:8px;"></div>
          </div>

          <div class="cc-actions">
            <button id="ccBtnApplyStatus">å¥—ç”¨ç‹€æ…‹</button>
            <button id="ccBtnRefreshHint" class="secondary">é¡¯ç¤ºè™•ç½®æç¤º</button>
          <button id="ccBtnAgentSuggest" class="secondary">å°Jï¼šè™•ç½®å»ºè­°</button>
          <button id="ccBtnAgentDaily" class="secondary">å°Jï¼šæ¯æ—¥æ‘˜è¦</button>
          <button id="ccBtnWriteWorkspace" class="secondary">å¯«å…¥ Google Workspace</button>
          </div>

        <label class="small muted" style="margin-top:10px;">å°J AI ä»£ç†è¼¸å‡ºï¼ˆæœ¬åœ°ç¤ºç¯„ï¼‰</label>
        <textarea id="ccAgentOut" class="mono" readonly style="min-height: 120px;"></textarea>
        <div class="muted small" style="margin-top:8px;">
          Workspace å¯«å…¥ï¼šå„ªå…ˆå¯«å…¥ <span class="mono">WUCHANG_WORKSPACE_OUTDIR</span> æŒ‡å®šè³‡æ–™å¤¾ï¼ˆå»ºè­°è¨­åœ¨ Google Drive åŒæ­¥è·¯å¾‘ï¼‰ï¼›
          æˆ–è¨­å®š <span class="mono">WUCHANG_WORKSPACE_WEBHOOK_URL</span>ï¼ˆå¯é¸ï¼‰ã€‚
        </div>

          <div class="muted small" style="margin-top:10px;">
            èªªæ˜ï¼šæ­¤å€çš„ã€Œå¥—ç”¨ç‹€æ…‹ã€åªæœƒæ›´æ–°æœ¬é é¢çš„æ¨¡çµ„ç‹€æ…‹æ¨¡å‹ï¼Œç”¨æ–¼æ¼”ç¤º/ç®¡ç†ï¼›ä¸æœƒç›´æ¥è®Šæ›´ DNS æˆ–æœå‹™è¨­å®šã€‚
          </div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card" data-section="design_mode">
        <h2>è¨­è¨ˆå•Ÿç”¨ï¼ˆè³‡è¨Šç´€éŒ„/ç•™ç—•ï¼‰</h2>
        <div class="muted">
          ç›®çš„ï¼šå…ˆä¸æŠŠå®ƒç•¶æˆç¡¬é–˜é–€ï¼›æ”¹æˆã€Œéœ€ä»¥ç¡¬ç·¨ç¢¼è£½ä½œçš„è³‡è¨Šç´€éŒ„ã€èˆ‡ç•™ç—•é–‹é—œã€‚
          æ¯æ¬¡å•Ÿç”¨/é—œé–‰éƒ½æœƒè‡ªå‹•ç”¢ç”Ÿä¸€ä»½ JSON ç´€éŒ„ï¼ˆå¯äº¤æ¥/å¯ç¨½æ ¸ï¼‰ã€‚
        </div>
        <div class="design-mode-box">
          <div class="row">
            <div>
              <label style="margin-top:0;">ç‹€æ…‹</label>
              <div class="value"><span id="designModePill" class="pill unk">æœªçŸ¥</span></div>
            </div>
            <div>
              <label style="margin-top:0;">TTLï¼ˆç§’ï¼‰</label>
              <input id="designModeTtl" value="1200" />
            </div>
          </div>
          <label>åŸå› ï¼ˆå¯é¸ï¼Œç•™ç—•ï¼‰</label>
          <input id="designModeReason" placeholder="ä¾‹å¦‚ï¼šè‡¨æ™‚èª¿æ•´ç¡¬ç·¨ç¢¼/ä¿®å¾©/äº¤æ¥" />
          <div class="btns">
            <button id="btnDesignModeEnable">å•Ÿç”¨ï¼ˆç•™ç—•ï¼‰</button>
            <button id="btnDesignModeDisable" class="secondary">é—œé–‰</button>
            <button id="btnDesignModeRefresh" class="secondary">åˆ·æ–°</button>
            <button id="btnDesignModeRecord" class="secondary">ç”¢ç”Ÿè³‡è¨Šç´€éŒ„</button>
          </div>
          <div class="muted small" id="designModeHint" style="margin-top:8px;"></div>
          <label class="small muted" style="margin-top:10px;">è³‡è¨Šç´€éŒ„ï¼ˆJSONï¼Œæœ€è¿‘ä¸€æ¬¡ï¼‰</label>
          <textarea id="designModeRecord" class="mono" readonly style="min-height: 140px;"></textarea>
        </div>
      </div>

      <div class="card wide" data-section="chat">
        <h2>å°Jï¼šè‡ªç„¶èªè¨€ä¸­æ§ï¼ˆChatGPT ä»£ç† + èªéŸ³å°è©±ï¼‰</h2>
        <div class="muted">
          ä½ å¯ä»¥ç”¨ã€Œè‡ªç„¶èªè¨€ã€å«å°Jåšäº‹ï¼ˆæŸ¥ DNSã€ç”¢ç”Ÿç¶²è·¯å¿«ç…§ã€æŸ¥çœ‹ç¨½æ ¸ã€æ¨é€ rules/kbï¼‰ã€‚<strong>æ¨é€å±¬é«˜é¢¨éšª</strong>ï¼šä¸€å®šæœƒå…ˆè¦æ±‚ä½ èªª/æ‰“ã€Œç¢ºèªæ¨é€ â€¦ã€æ‰æœƒåŸ·è¡Œï¼Œä¸¦ä¸”ä»å—ã€Œç„¡å›æ‡‰ï¼ç¦æ­¢ã€ç¡¬é–˜é–€ä¿è­·ã€‚
        </div>

        <div class="chat" style="margin-top:12px;">
          <div class="chat-head">
            <div class="title">å°J å°è©±</div>
            <div class="sub">
              èªéŸ³åŠŸèƒ½ä½¿ç”¨ç€è¦½å™¨ Web Speech APIï¼ˆEdge/Chrome é€šå¸¸å¯ç”¨ï¼‰ã€‚è‹¥å…¬å¸æ”¿ç­–/æ¬Šé™é™åˆ¶éº¥å…‹é¢¨ï¼Œä»å¯ç”¨æ‰“å­—æ“ä½œã€‚
            </div>
          </div>
          <div class="chat-body" id="ljMessages"></div>
          <div class="chat-foot">
            <div class="toggle" style="margin:0 0 10px;">
              <input type="checkbox" id="ljSpeak" />
              <span>å°J å›è¦†è‡ªå‹•æœ—è®€ï¼ˆèªéŸ³è¼¸å‡ºï¼‰</span>
            </div>
            <div class="row">
              <div>
                <label style="margin-top:0;">å°J æ¨¡å¼</label>
                <select id="ljMode">
                  <option value="command">æœ¬æ©ŸæŒ‡æ®æ¨¡å¼ï¼ˆå®‰å…¨/ä¸å¤–é€ï¼‰</option>
                  <option value="cloud_chat">é›²ç«¯å°è©±æ¨¡å¼ï¼ˆéœ€é‡‘é‘°/å¯èƒ½å¤–é€ï¼‰</option>
                </select>
              </div>
              <div>
                <label style="margin-top:0;">æ¨¡å‹</label>
                <select id="ljModel">
                  <option value="local_rule">æœ¬æ©Ÿè¦å‰‡ï¼ˆæŒ‡æ®/å®‰å…¨ï¼‰</option>
                  <option value="gpt-4o-mini">é›²ç«¯ï¼šgpt-4o-mini</option>
                  <option value="gpt-4o">é›²ç«¯ï¼šgpt-4o</option>
                  <option value="gpt-4.1-mini">é›²ç«¯ï¼šgpt-4.1-mini</option>
                  <option value="custom">é›²ç«¯ï¼šè‡ªè¨‚ï¼ˆçœ‹ç’°å¢ƒè®Šæ•¸ï¼‰</option>
                </select>
              </div>
            </div>
            <div class="btns" style="margin-top:10px;">
              <button id="ljSaveConfig" class="secondary">å„²å­˜å°Jè¨­å®š</button>
              <button id="ljLoadModels" class="secondary">é‡æ–°è¼‰å…¥æ¨¡å‹æ¸…å–®</button>
            </div>
            <div class="muted small" id="ljModelHint" style="margin-top:8px;">
              æç¤ºï¼šé›²ç«¯æ¨¡å¼éœ€è¦è¨­å®š <span class="mono">WUCHANG_LLM_API_KEY</span>ï¼ˆå¯é¸ <span class="mono">WUCHANG_LLM_BASE_URL</span> / <span class="mono">WUCHANG_LLM_MODEL</span>ï¼‰ã€‚æœªè¨­å®šæ™‚ä¸æœƒå¤–é€å…§å®¹ã€‚
            </div>
            <div class="chat-row">
              <input id="ljInput" placeholder="ä¾‹å¦‚ï¼šæª¢æŸ¥ DNS ç›®å‰ç‹€æ…‹ / åšç¶²è·¯å¿«ç…§ / æ¨é€ rules" />
              <button id="ljSend">é€å‡º</button>
              <button id="ljMic" class="secondary">èªéŸ³</button>
            </div>
            <div class="chipbar">
              <button class="chip" data-lj="æª¢æŸ¥ DNS ç›®å‰ç‹€æ…‹">æª¢æŸ¥ DNS</button>
              <button class="chip" data-lj="è¼‰å…¥ DNS é æœŸå€¼">DNS é æœŸå€¼</button>
              <button class="chip" data-lj="åšç¶²è·¯å¿«ç…§ä¸¦å­˜æª”">ç¶²è·¯å¿«ç…§</button>
              <button class="chip" data-lj="æŸ¥çœ‹ç¨½æ ¸ç´€éŒ„">ç¨½æ ¸æ‘˜è¦</button>
              <button class="chip" data-lj="æ¨é€ rules">æ¨é€ rules</button>
              <button class="chip" data-lj="æ¨é€ kb">æ¨é€ kb</button>
              <button class="chip" id="ljClear" type="button">æ¸…ç©ºå°è©±</button>
            </div>
            <div class="smallhint" id="ljVoiceHint"></div>
          </div>
        </div>
      </div>

      <div class="card wide" data-section="personal_ai_binding">
        <h2>ğŸ” å€‹äººèº«ä»½é©—è­‰èˆ‡æœ€é«˜æ¬Šé™ AI ç¶å®š</h2>
        <div class="muted">
          å°‡æœ€é«˜æ¬Šé™ AI ç¶å®šåˆ°æ‚¨çš„å€‹äººèº«ä»½ï¼Œé–‹å•Ÿé©—è­‰å¡«å¯«åŠŸèƒ½ã€‚
        </div>

        <div id="personalBindingStatus" style="margin-top: 12px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
          <div class="muted">è¼‰å…¥ä¸­...</div>
        </div>

        <div id="personalBindingForm" style="display: none; margin-top: 12px;">
          <div class="row">
            <div>
              <label>å§“å *</label>
              <input type="text" id="personalName" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å" />
            </div>
            <div>
              <label>èº«ä»½ ID *</label>
              <input type="text" id="personalId" placeholder="è«‹è¼¸å…¥èº«ä»½è­˜åˆ¥ç¢¼" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>å¯†ç¢¼ *</label>
              <input type="password" id="personalPassword" placeholder="è«‹è¨­å®šå¯†ç¢¼" />
            </div>
            <div>
              <label>ç¢ºèªå¯†ç¢¼ *</label>
              <input type="password" id="personalPasswordConfirm" placeholder="è«‹å†æ¬¡è¼¸å…¥å¯†ç¢¼" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Email</label>
              <input type="email" id="personalEmail" placeholder="é¸å¡«ï¼šæ‚¨çš„ Email" />
            </div>
            <div>
              <label>é›»è©±</label>
              <input type="tel" id="personalPhone" placeholder="é¸å¡«ï¼šæ‚¨çš„é›»è©±" />
            </div>
          </div>
          <div>
            <label>å‚™è¨»</label>
            <textarea id="personalNotes" placeholder="é¸å¡«ï¼šå…¶ä»–èªªæ˜" rows="3"></textarea>
          </div>
          <div class="btns" style="margin-top: 12px;">
            <button id="btnCreateBinding" class="primary">å»ºç«‹å€‹äºº AI ç¶å®š</button>
            <button id="btnCancelBinding" class="secondary">å–æ¶ˆ</button>
          </div>
        </div>

        <div id="personalVerificationForm" style="display: none; margin-top: 12px;">
          <h3 style="margin-bottom: 12px;">èº«ä»½é©—è­‰</h3>
          <div class="row">
            <div>
              <label>èº«ä»½ ID *</label>
              <input type="text" id="verifyPersonalId" placeholder="è«‹è¼¸å…¥èº«ä»½è­˜åˆ¥ç¢¼" />
            </div>
            <div>
              <label>å¯†ç¢¼ *</label>
              <input type="password" id="verifyPassword" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" />
            </div>
          </div>
          <div class="btns" style="margin-top: 12px;">
            <button id="btnVerifyIdentity" class="primary">é©—è­‰èº«ä»½</button>
          </div>
        </div>

        <div id="personalVerificationData" style="display: none; margin-top: 12px;">
          <h3 style="margin-bottom: 12px;">é©—è­‰è³‡æ–™å¡«å¯«</h3>
          <div class="muted" style="margin-bottom: 12px;">
            è«‹å¡«å¯«ä»¥ä¸‹é©—è­‰è³‡æ–™ä»¥å®Œæˆæœ€é«˜æ¬Šé™ AI ç¶å®š
          </div>
          <div>
            <label>é©—è­‰è³‡æ–™ï¼ˆJSON æ ¼å¼ï¼‰</label>
            <textarea id="verificationData" placeholder='{"key": "value"}' rows="10" style="font-family: monospace;"></textarea>
          </div>
          <div class="btns" style="margin-top: 12px;">
            <button id="btnSaveVerification" class="primary">å„²å­˜é©—è­‰è³‡æ–™</button>
          </div>
        </div>

        <div id="biometricVerification" style="display: none; margin-top: 12px;">
          <h3 style="margin-bottom: 12px;">ğŸ” ç”Ÿç‰©ç‰¹å¾µæƒæé©—è­‰</h3>
          <div class="muted" style="margin-bottom: 12px;">
            ä½¿ç”¨ç­†é›»é¡é ­é€²è¡Œç”Ÿç‰©ç‰¹å¾µæƒæï¼Œå°ç…§å…§éƒ¨èº«ä»½è­‰æª”æ¡ˆï¼ˆæ±Ÿæ”¿éš†ï¼‰
          </div>
          
          <div style="margin-bottom: 12px;">
            <label>å§“å *</label>
            <input type="text" id="biometricName" placeholder="è«‹è¼¸å…¥å§“åï¼ˆä¾‹å¦‚ï¼šæ±Ÿæ”¿éš†ï¼‰" value="æ±Ÿæ”¿éš†" />
          </div>
          <div style="margin-bottom: 12px;">
            <label>èº«ä»½è­‰è™Ÿç¢¼ï¼ˆé¸å¡«ï¼‰</label>
            <input type="text" id="biometricIdNumber" placeholder="é¸å¡«ï¼šèº«ä»½è­‰è™Ÿç¢¼" />
          </div>
          
          <div style="margin-bottom: 12px;">
            <label>æœ¬æ©Ÿå”¯ä¸€ç¢¼ï¼ˆMAC åœ°å€ï¼‰</label>
            <div style="display: flex; gap: 8px;">
              <input type="text" id="biometricMacAddress" readonly style="flex: 1;" />
              <button id="btnGetMacAddress" class="secondary">å–å¾— MAC</button>
            </div>
          </div>
          
          <div style="margin-bottom: 12px;">
            <label>ç”Ÿç‰©ç‰¹å¾µæƒæ</label>
            <div style="background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px; padding: 20px; text-align: center;">
              <video id="biometricVideo" autoplay playsinline style="max-width: 100%; max-height: 300px; display: none; border-radius: 8px;"></video>
              <canvas id="biometricCanvas" style="display: none;"></canvas>
              <div id="biometricPlaceholder">
                <div style="font-size: 3em; margin-bottom: 10px;">ğŸ“·</div>
                <div class="muted">é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹æƒæ</div>
              </div>
            </div>
          </div>
          
          <div class="btns" style="margin-top: 12px;">
            <button id="btnStartBiometricScan" class="primary">é–‹å§‹ç”Ÿç‰©ç‰¹å¾µæƒæ</button>
            <button id="btnStopBiometricScan" class="secondary" style="display: none;">åœæ­¢æƒæ</button>
            <button id="btnVerifyBiometric" class="primary" style="display: none;">é©—è­‰ç”Ÿç‰©ç‰¹å¾µ</button>
          </div>
          
          <div id="biometricResult" style="margin-top: 12px; padding: 12px; border-radius: 8px; display: none;"></div>
        </div>
      </div>

      <div class="card wide" data-section="triple_j_conference">
        <h2>ğŸ¤ ä¸‰äººå°è©±æœƒè­°å®¤ï¼šä½¿ç”¨è€… + åœ°ç«¯å° j + é›²ç«¯å° j (JULES)</h2>
        <div class="muted">
          èˆ‡åœ°ç«¯å° jï¼ˆæœ¬åœ° LLMï¼‰å’Œé›²ç«¯å° j (JULES) åŒæ™‚å°è©±ï¼Œå…±åŒè¨è«–å’Œè§£æ±ºå•é¡Œã€‚
          <strong>ç•¶å‰è­°é¡Œï¼šå…¨ç³»çµ±è¨­å®šç‚ºä½•ç„¡æ³•å…¨çƒå¯è¦‹ï¼Ÿå¦‚ä½•æ”¹å–„ï¼Ÿ</strong>
        </div>

        <div class="chat" style="margin-top:12px;">
          <div class="chat-head">
            <div class="title">ä¸‰äººå°è©±æœƒè­°å®¤</div>
            <div class="sub">
              åœ°ç«¯å° jï¼ˆç™½é«®å°å§‘å¨˜ï¼‰è² è²¬æœ¬åœ°åˆ†æå’ŒæŠ€è¡“ç´°ç¯€ï¼Œé›²ç«¯å° j (JULES)ï¼ˆå¯æ„›ç« é­šï¼‰è² è²¬ç­–ç•¥å’Œæ•´é«”è¦åŠƒã€‚
            </div>
          </div>
          <div class="chat-body" id="tripleJMessages" style="max-height: 500px;">
            <div class="msg system">
              <div class="role">ç³»çµ±</div>
              <div class="bubble">
                <strong>æœƒè­°å®¤å·²é–‹å•Ÿ</strong><br/>
                åƒèˆ‡è€…ï¼š<br/>
                â€¢ ä½¿ç”¨è€…ï¼ˆä½ ï¼‰<br/>
                â€¢ åœ°ç«¯å° jï¼ˆæœ¬åœ° LLM åŠ©ç†ï¼‰<br/>
                â€¢ é›²ç«¯å° j (JULES)ï¼ˆé›²ç«¯ AI åŠ©ç†ï¼‰<br/><br/>
                <strong>ç•¶å‰è­°é¡Œï¼šå…¨ç³»çµ±è¨­å®šç‚ºä½•ç„¡æ³•å…¨çƒå¯è¦‹ï¼Ÿå¦‚ä½•æ”¹å–„ï¼Ÿ</strong>
              </div>
            </div>
          </div>
          <div class="chat-foot">
            <div class="chat-row">
              <input id="tripleJInput" placeholder="è¼¸å…¥è¨Šæ¯ï¼Œåœ°ç«¯å° j å’Œé›²ç«¯å° j æœƒåŒæ™‚å›æ‡‰..." />
              <button id="tripleJSend" class="primary">é€å‡º</button>
              <button id="tripleJClear" class="secondary">æ¸…ç©º</button>
            </div>
            <div class="smallhint" style="margin-top:8px;">
              æç¤ºï¼šåœ°ç«¯å° j ä½¿ç”¨æœ¬åœ° LLMï¼ˆOllamaï¼‰ï¼Œé›²ç«¯å° j ä½¿ç”¨é›²ç«¯ LLMï¼ˆéœ€è¨­å®š API Keyï¼‰
            </div>
          </div>
        </div>
      </div>

      <div class="card wide" data-section="jobs">
        <h2>å‘½ä»¤å–®ï¼ˆJobï¼‰æ”¶ä»¶åŒ£ï¼šå¾…é€ / å·²é€ / å°å­˜</h2>
        <div class="muted">
          é€™è£¡æ˜¯ã€Œæ¨é€å‘½ä»¤å–®ã€çš„è½åœ°ä½ç½®ï¼šå°J æœƒæŠŠé«˜é¢¨éšªå‹•ä½œæ”¹æˆå…ˆå»ºç«‹å‘½ä»¤å–®ï¼Œé¿å…æœ¬æ©Ÿç›´æ¥ç¡¬åšã€‚
          æœªä¾†ä¼ºæœå™¨ç«¯åªè¦ç›£çœ‹ job inboxï¼Œå°±èƒ½å®‰å…¨åŸ·è¡Œï¼ˆç™½åå–® + ç¨½æ ¸ + ç„¡å›æ‡‰ï¼ç¦æ­¢ï¼‰ã€‚
        </div>

        <div class="row" style="margin-top:12px;">
          <div>
            <label style="margin-top:0;">ç‹€æ…‹</label>
            <select id="jobState">
              <option value="outbox">å¾…é€ï¼ˆoutboxï¼‰</option>
              <option value="sent">å·²é€ï¼ˆsentï¼‰</option>
              <option value="archive">å°å­˜ï¼ˆarchiveï¼‰</option>
            </select>
            <div class="btns">
              <button id="btnJobRefresh" class="secondary">é‡æ–°æ•´ç†</button>
              <button id="btnJobMarkSent" class="secondary">æ¨™è¨˜ç‚ºå·²é€</button>
              <button id="btnJobArchive" class="secondary">å°å­˜</button>
            </div>
            <div id="jobList" class="joblist" style="margin-top:10px;">ï¼ˆå°šæœªè¼‰å…¥ï¼‰</div>
          </div>
          <div>
            <label style="margin-top:0;">å‘½ä»¤å–®å…§å®¹ï¼ˆJSONï¼‰</label>
            <textarea id="jobDetail" class="mono jobdetail" readonly></textarea>
            <div class="btns">
              <button id="btnJobCopy" class="secondary">è¤‡è£½å‘½ä»¤å–®</button>
              <button id="btnJobWriteWorkspace" class="secondary">å¯«å…¥ Google Workspace</button>
              <button id="btnJobSendHub" class="secondary">é€åˆ°ä¼ºæœå™¨å°Jï¼ˆHubï¼‰</button>
              <button id="btnJobConfirmHub" class="secondary">Hub ç¢ºèªï¼ˆå…è¨±åŸ·è¡Œï¼‰</button>
            </div>
            <div class="muted small" style="margin-top:8px;">
              æç¤ºï¼šæœ¬æ©Ÿ UI æ˜¯äººé¡æ§åˆ¶ç«¯é»ï¼›ä½ å¯ä»¥æŠŠå‘½ä»¤å–®ã€Œé€åˆ°ä¼ºæœå™¨å°J Hubã€ï¼Œå†ç”±ä½ åœ¨æ­¤æŒ‰ã€ŒHub ç¢ºèªã€è®“ä¼ºæœå™¨ç«¯ executor åŸ·è¡Œï¼ˆconfirmed=true æ‰æœƒè·‘ï¼‰ã€‚
            </div>
          </div>
        </div>
      </div>

      <div class="card wide" data-section="authz">
        <h2>æˆæ¬Šè«‹ç¤ºå–®ï¼ˆå¯èª¿å¼æˆæ¬Šï¼šä¸è¶³æ™‚å¯ä¸»å‹•è«‹ç¤ºï¼‰</h2>
        <div class="muted">
          ç•¶å°Jåˆ¤æ–·ã€Œç›®å‰å±¤ç´šä¸è¶³ã€æ™‚ï¼Œæœƒè‡ªå‹•å»ºç«‹æˆæ¬Šè«‹ç¤ºå–®ä¸¦å½ˆå‡ºæˆæ¬Šçª—ã€‚
          ç®¡ç†å“¡å¯åœ¨æ­¤æ ¸å‡†ï¼ˆå¯è¨­å®šæ™‚æ•ˆ TTLï¼‰ï¼Œæˆæ¬Šåˆ°æœŸæœƒè‡ªå‹•å¤±æ•ˆã€‚
        </div>

        <div class="row" style="margin-top:12px;">
          <div>
            <label style="margin-top:0;">ç‹€æ…‹</label>
            <select id="authzState">
              <option value="pending">å¾…æ ¸å‡†ï¼ˆpendingï¼‰</option>
              <option value="approved">å·²æ ¸å‡†ï¼ˆapprovedï¼‰</option>
              <option value="denied">å·²æ‹’çµ•ï¼ˆdeniedï¼‰</option>
            </select>
            <div class="btns">
              <button id="btnAuthzRefresh" class="secondary">é‡æ–°æ•´ç†</button>
              <button id="btnAuthzOpenModal" class="secondary">é–‹å•Ÿæˆæ¬Šçª—ï¼ˆé¸å–ï¼‰</button>
            </div>
            <div id="authzList" class="joblist" style="margin-top:10px;">ï¼ˆå°šæœªè¼‰å…¥ï¼‰</div>
          </div>
          <div>
            <label style="margin-top:0;">æˆæ¬Šè«‹ç¤ºå–®å…§å®¹ï¼ˆJSONï¼‰</label>
            <textarea id="authzDetail" class="mono jobdetail" readonly></textarea>
            <div class="row" style="margin-top:10px;">
              <div>
                <label style="margin-top:0;">æ ¸å‡† TTLï¼ˆç§’ï¼‰</label>
                <input id="authzTtl" value="3600" />
              </div>
              <div>
                <label style="margin-top:0;">æ‹’çµ•/æ’¤éŠ·åŸå› ï¼ˆå¯é¸ï¼‰</label>
                <input id="authzReason" placeholder="ä¾‹å¦‚ï¼šä¸åœ¨ç¶­è­·æ™‚æ®µ / è«‹è£œå……ç”¨é€”" />
              </div>
            </div>
            <div>
              <label>ç¯„åœæˆæ¬Š scopeï¼ˆJSONï¼‰</label>
              <textarea id="authzScope" class="mono" style="min-height: 90px;" placeholder='ä¾‹å¦‚ï¼š{"domain":"wuchang.life","node_id":"dev_server"}'></textarea>
              <div class="muted small">ç®¡ç†å“¡å¯èª¿æ•´ scopeï¼ˆç¯„åœï¼‰ï¼Œä¾‹å¦‚é™å®š domain / node_idã€‚</div>
            </div>
            <div>
              <label>é …ç›®æˆæ¬Š itemsï¼ˆJSONï¼Œå¯å«é€é … TTLï¼‰</label>
              <textarea id="authzItems" class="mono" style="min-height: 90px;" placeholder='ä¾‹å¦‚ï¼š[{"permission":"vm_control","ttl_seconds":1200}]'></textarea>
              <div class="muted small">è‹¥æä¾› itemsï¼Œç³»çµ±æœƒä»¥ items é€é … TTL ç‚ºæº–ï¼ˆç¼ºå°‘ ttl_seconds æ™‚æœƒç”¨ä¸Šæ–¹ TTL è£œé½Šï¼‰ã€‚</div>
            </div>
            <div class="btns">
              <button id="btnAuthzApprove">æ ¸å‡†ï¼ˆæš«æ™‚æˆæ¬Šï¼‰</button>
              <button id="btnAuthzDeny" class="secondary">æ‹’çµ•</button>
              <button id="btnAuthzLoadGrants" class="secondary">è¼‰å…¥æš«æ™‚æˆæ¬Šæ¸…å–®</button>
            </div>
            <div class="muted small" id="authzHint" style="margin-top:8px;"></div>
            <div style="margin-top:10px;">
              <label>æš«æ™‚æˆæ¬Šï¼ˆgrantsï¼‰</label>
              <textarea id="authzGrants" class="mono" readonly style="min-height: 120px;" placeholder="ï¼ˆå°šæœªè¼‰å…¥ï¼‰"></textarea>
              <div class="btns">
                <button id="btnAuthzRevoke" class="secondary">æ’¤éŠ·ï¼ˆä¾ grant_idï¼‰</button>
              </div>
              <div class="muted small">æ’¤éŠ·æ™‚è«‹åœ¨ã€Œå³æ™‚è¼¸å‡ºã€æ‰¾åˆ° grant_idï¼Œæˆ–åœ¨ä¸Šæ–¹ grants JSON å…§è¤‡è£½ idã€‚</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card" data-section="targets">
        <h2>1) ç›®æ¨™è³‡è¨Šï¼ˆå¯ä¸å¡«ï¼Œä½†ä¸å¡«å°±åªèƒ½ã€Œçœ‹ç‹€æ…‹ã€ä¸èƒ½æ¨é€ï¼‰</h2>
        <div class="row">
          <div>
            <label>ä¼ºæœå™¨å¥åº·æª¢æŸ¥ URL</label>
            <input id="healthUrl" placeholder='ä¾‹å¦‚ï¼šhttps://wuchang.life/health æˆ– https://<your-domain>/health' />
            <div class="muted small" style="margin-top:6px;">ä¹Ÿå¯æ”¹ç”¨ç’°å¢ƒè®Šæ•¸ï¼š<span class="mono">WUCHANG_HEALTH_URL</span></div>
          </div>
          <div>
            <label>ä¼ºæœå™¨æ¥æ”¶è³‡æ–™å¤¾ï¼ˆSMB/æ›è¼‰ç£ç¢Ÿï¼‰</label>
            <input id="copyTo" placeholder='ä¾‹å¦‚ï¼š\\\\SERVER\\share\\wuchang' />
            <div class="muted small" style="margin-top:6px;">ä¹Ÿå¯æ”¹ç”¨ç’°å¢ƒè®Šæ•¸ï¼š<span class="mono">WUCHANG_COPY_TO</span></div>
          </div>
        </div>
        <label>æ“ä½œè€…ï¼ˆç¨½æ ¸ç”¨ï¼‰</label>
        <input id="actor" placeholder="ä¾‹å¦‚ï¼šops / åº—é•· / admin" value="ops" />

        <div class="btns">
          <button id="btnCheckServer">æª¢æŸ¥ä¼ºæœå™¨å¥åº·</button>
          <button id="btnCheckDNS" class="secondary">æª¢æŸ¥ DNSï¼ˆ_acme-challengeï¼‰</button>
          <button id="btnNetSnapshot" class="secondary">ç¶²è·¯å¿«ç…§ï¼ˆæœ¬æ©Ÿ/è·¯ç”±å™¨/DNSï¼‰</button>
        </div>
        <div class="muted small" style="margin-top:10px;">
          DNS æª¢æŸ¥æœƒåƒç…§ repo å…§çš„ <span class="mono">dns_records.json</span> é æœŸå€¼ï¼›è‹¥å¤šå€‹å…¬ç”¨ DNS å›æ‡‰ä¸ä¸€è‡´ï¼Œä»£è¡¨å°šæœªå®Œå…¨å‚³æ’­ï¼Œæš«ä¸å»ºè­°ç°½ç™¼æ†‘è­‰ã€‚
        </div>
      </div>

      <div class="card" data-section="hub_arch">
        <h2>ä¼ºæœå™¨ç³»çµ±æ¶æ§‹ï¼ˆå…ˆç´¢å–å†è¨­è¨ˆï¼‰</h2>
        <div class="muted">
          é€™æœƒé€éä¼ºæœå™¨ç«¯ã€Œå°J Hubã€å›å ±å®¹å™¨/ç·¨æ’/port æ˜ å°„ç­‰<strong>æ©Ÿå™¨å¯è®€</strong>è³‡è¨Šï¼Œå”åŠ©å…ˆç†è§£æ¶æ§‹å¾Œå†åšè¨­è¨ˆã€‚
          éœ€è¦å…ˆè¨­å®š <span class="mono">WUCHANG_HUB_URL</span> èˆ‡ <span class="mono">WUCHANG_HUB_TOKEN</span>ï¼ˆæœ¬æ©Ÿç«¯ï¼‰ï¼Œä¸”ä¼ºæœå™¨ Hub å·²å•Ÿå‹•ã€‚
        </div>
        <div class="btns" style="margin-top:12px;">
          <button id="btnHubServerArch" class="secondary">å‘ä¼ºæœå™¨ç´¢å–ç³»çµ±æ¶æ§‹ï¼ˆHubï¼‰</button>
          <button id="btnHubGenerateReports" class="secondary">è¦æ±‚ä¼ºæœå™¨ç”Ÿæˆå›å ±æª”ï¼ˆå¯«å…¥æŒ‡å®šç›®éŒ„ï¼‰</button>
          <button id="btnHubServerArchCopy" class="secondary">è¤‡è£½</button>
        </div>
        <label style="margin-top:10px;">æ¶æ§‹å›å ±ï¼ˆJSONï¼‰</label>
        <textarea id="serverArchText" class="mono" readonly style="min-height: 220px;" placeholder="ï¼ˆå°šæœªç´¢å–ï¼‰"></textarea>
        <div class="muted small" id="serverArchHint" style="margin-top:6px;"></div>
      </div>

      <div class="card" data-section="dns">
        <h2>DNS è™•ç½®ï¼ˆç°½ç™¼æ†‘è­‰å‰ç½®ï¼‰</h2>
        <div class="muted">
          é€™è£¡æœƒæŠŠ <span class="mono">dns_records.json</span> å…§çš„é æœŸ <span class="mono">_acme-challenge</span> TXT å€¼ã€Œä¸­æ–‡åŒ–ã€å‘ˆç¾ã€‚
          <strong>æœ¬ç³»çµ±ä¸æœƒè‡ªå‹•æ”¹ DNS</strong>ï¼ˆé¿å…é«˜é¢¨éšªèª¤æ“ä½œï¼‰ï¼›ä½ åªè¦æŠŠä¸‹é¢çš„ TXT å€¼è²¼åˆ°ä½ çš„ DNS ç®¡ç†ä»‹é¢å³å¯ã€‚
        </div>

        <div class="row" style="margin-top:12px;">
          <div>
            <label>é æœŸ TXTï¼š_acme-challenge</label>
            <input id="expectedAcmeRoot" readonly />
            <div class="btns">
              <button id="btnCopyAcmeRoot" class="secondary">è¤‡è£½</button>
            </div>
          </div>
          <div>
            <label>é æœŸ TXTï¼š_acme-challenge.www</label>
            <input id="expectedAcmeWww" readonly />
            <div class="btns">
              <button id="btnCopyAcmeWww" class="secondary">è¤‡è£½</button>
            </div>
          </div>
        </div>

        <div class="btns">
          <button id="btnLoadExpectedDNS">è¼‰å…¥é æœŸå€¼ï¼ˆå¾ dns_records.jsonï¼‰</button>
          <button id="btnCheckDNS2" class="secondary">æŸ¥è©¢å‚³æ’­ç‹€æ…‹ï¼ˆå¤š DNSï¼‰</button>
        </div>

        <div class="muted small" style="margin-top:10px;">
          åˆ¤æ–·é‚è¼¯ï¼šåŒæ™‚å‘å¤šå€‹å…¬ç”¨ DNSï¼ˆ1.1.1.1 / 8.8.8.8 / 9.9.9.9 / OpenDNSï¼‰æŸ¥ TXTï¼›
          åªè¦ä»»ä½• resolver ç„¡å›æ‡‰ã€æˆ–å›æ‡‰ä¸ä¸€è‡´ã€æˆ–ç¼ºå°‘é æœŸ tokenï¼Œå³è¦–ç‚º <strong>NOT READY</strong>ã€‚
        </div>
      </div>

      <div class="card" data-section="actions">
        <h2>2) ä¸€éµå‹•ä½œï¼ˆå·²å…§å»ºã€Œç„¡å›æ‡‰ï¼ç¦æ­¢ã€ï¼‰</h2>
        <div class="muted">
          æ¨é€æœƒå‘¼å« <span class="mono">safe_sync_push.py</span>ï¼Œå®ƒæœƒå…ˆåšå¥åº·æª¢æŸ¥ï¼›åªè¦ç„¡å›æ‡‰/ä¸å¯é©—è­‰å°±æœƒä¸­æ­¢ï¼Œä¸¦å¯«å…¥ç¨½æ ¸ã€‚
        </div>
        <div class="btns" style="margin-top:12px;">
          <button id="btnPushRules">æ¨é€ï¼šæ–°è¦å‰‡æª”æ¡ˆï¼ˆrulesï¼‰</button>
          <button id="btnPushKB" class="secondary">æ¨é€ï¼šçŸ¥è­˜åº«ç´¢å¼•ï¼ˆkbï¼‰</button>
          <button id="btnReloadAudit">é‡æ–°è¼‰å…¥ç¨½æ ¸</button>
        </div>
        <div class="muted small" style="margin-top:10px;">
          rules å…§å®¹åŒ…å«ï¼š<span class="mono">AGENT_CONSTITUTION.md</span>ã€<span class="mono">RISK_ACTION_SOP.md</span>ã€<span class="mono">risk_gate.py</span>ã€<span class="mono">safe_sync_push.py</span> ç­‰ã€‚
        </div>
      </div>

      <div class="card" data-section="runlog">
        <h2>3) å³æ™‚è¼¸å‡ºï¼ˆæœ¬æ©ŸåŸ·è¡Œçµæœï¼‰</h2>
        <div class="toggle">
          <input type="checkbox" id="showRawJson" />
          <span>é¡¯ç¤ºåŸå§‹ JSONï¼ˆé™¤éŒ¯ç”¨ï¼‰</span>
        </div>
        <div id="runLog" class="log human">ï¼ˆå°šæœªåŸ·è¡Œï¼‰</div>
      </div>

      <div class="card" data-section="audit">
        <h2>4) ç¨½æ ¸ç´€éŒ„ï¼ˆå°¾ç«¯ 50 ç­†ï¼‰</h2>
        <div class="toggle">
          <input type="checkbox" id="showRawAudit" />
          <span>é¡¯ç¤ºåŸå§‹ç¨½æ ¸ JSONLï¼ˆé™¤éŒ¯ç”¨ï¼‰</span>
        </div>
        <div id="auditLog" class="log human">ï¼ˆå°šæœªè¼‰å…¥ï¼‰</div>
      </div>

      <div class="card" data-section="verify">
        <h2>4.5) ç¨‹åºé©—è­‰ï¼ˆå°J ç¨½æ ¸ï¼šè¤‡æŸ¥/å‘Šè­¦ï¼‰</h2>
        <div class="muted">
          é€™æ˜¯<strong>ç´”ç¨‹åºé©—è­‰</strong>ï¼šä¸ä¾è³´èªè¨€æ¨¡å‹ã€‚å®ƒæœƒæª¢æŸ¥å‘½ä»¤å–®æ˜¯å¦å¡ä½ã€Hub æ˜¯å¦å¯é”ã€Hub inbox æ˜¯å¦æœ‰å·²ç¢ºèªä½†æœªæ­¸æª”çš„å·¥ä½œï¼›è‹¥æœªå®Œæˆæœƒè‡ªå‹•é¡¯ç¤ºå‘Šè­¦ã€‚
        </div>
        <div class="toggle" style="margin-top:10px;">
          <input type="checkbox" id="verifyAuto" checked />
          <span>è‡ªå‹•åˆ·æ–°ï¼ˆæ¯ 15 ç§’ï¼‰</span>
        </div>
        <div class="btns" style="margin-top:10px;">
          <button id="btnVerifyNow" class="secondary">ç«‹å³é©—è­‰</button>
          <button id="btnVerifyCopy" class="secondary">ä¸€éµè¤‡è£½èª¿æŸ¥å ±å‘Š</button>
          <button id="btnVerifySendToLJ" class="secondary">è²¼åˆ°å°Jä¸¦é€å‡ºï¼ˆæé†’ï¼‰</button>
        </div>
        <div id="verifyLog" class="log human" style="min-height: 160px; margin-top:10px;">ï¼ˆå°šæœªé©—è­‰ï¼‰</div>
      </div>

      <div class="card" data-section="docs">
        <h2>5) è¦å‰‡æ–‡æœ¬ï¼ˆä¾›è‡¨æ™‚æŸ¥é–±ï¼‰</h2>
        <div class="row">
          <div>
            <label>æ–‡ä»¶</label>
            <select id="docName">
              <option value="RISK_ACTION_SOP.md">RISK_ACTION_SOP.md</option>
              <option value="AGENT_CONSTITUTION.md">AGENT_CONSTITUTION.md</option>
            </select>
            <div class="btns">
              <button id="btnLoadDoc" class="secondary">è¼‰å…¥æ–‡ä»¶</button>
            </div>
          </div>
          <div class="muted small">
            é€™è£¡åªåšã€ŒæŸ¥é–±ã€ï¼Œä¸åšä¿®æ”¹ã€‚ä¿®æ”¹ä»ä»¥æª”æ¡ˆç‚ºæº–ã€‚
          </div>
        </div>
        <label>å…§å®¹</label>
        <textarea id="docText" readonly></textarea>
      </div>
    </div>
  </div>

  <!-- æˆæ¬Šçª—ï¼ˆæ¬Šé™ä¸è¶³æ™‚è‡ªå‹•å½ˆå‡ºï¼‰ -->
  <div id="authzModalBackdrop" class="authz-backdrop">
    <div class="authz-modal">
      <div class="head">
        <div class="title">æˆæ¬Šè«‹ç¤ºå–®ï¼šæ ¸å‡† / æ‹’çµ•ï¼ˆæš«æ™‚æˆæ¬Šï¼‰</div>
        <button id="btnAuthzModalClose" class="close">é—œé–‰</button>
      </div>
      <div class="muted">
        è‹¥ä½ ä¸æ˜¯ç®¡ç†å“¡ï¼Œé€™è£¡æœƒé¡¯ç¤ºã€Œç­‰å¾…æ ¸å‡†ã€ï¼›ç®¡ç†å“¡å¯æ ¸å‡† TTLï¼ˆåˆ°æœŸè‡ªå‹•å¤±æ•ˆï¼‰ã€‚
      </div>
      <div class="row" style="margin-top:12px;">
        <div>
          <label style="margin-top:0;">è«‹ç¤ºå–® ID</label>
          <input id="authzModalId" readonly />
        </div>
        <div>
          <label style="margin-top:0;">TTLï¼ˆç§’ï¼‰</label>
          <input id="authzModalTtl" value="3600" />
        </div>
      </div>
      <label>ç¯„åœæˆæ¬Š scopeï¼ˆJSONï¼‰</label>
      <textarea id="authzModalScope" class="mono" style="min-height: 90px;" placeholder='ä¾‹å¦‚ï¼š{"domain":"wuchang.life","node_id":"dev_server"}'></textarea>
      <label>é …ç›®æˆæ¬Š itemsï¼ˆJSONï¼‰</label>
      <textarea id="authzModalItems" class="mono" style="min-height: 90px;" placeholder='ä¾‹å¦‚ï¼š[{"permission":"vm_control","ttl_seconds":1200}]'></textarea>
      <label>å…§å®¹ï¼ˆJSONï¼‰</label>
      <textarea id="authzModalDetail" class="mono" readonly style="min-height: 220px;"></textarea>
      <div class="btns">
        <button id="btnAuthzModalApprove">æ ¸å‡†</button>
        <button id="btnAuthzModalDeny" class="secondary">æ‹’çµ•</button>
        <button id="btnAuthzModalCopy" class="secondary">è¤‡è£½ JSON</button>
      </div>
      <div class="hint" id="authzModalHint"></div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    function escapeHtml(s) {
      const str = String(s ?? "");
      return str
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // ===== ä¸­å¤®å€å¡Šï¼šå¹³å°ç‹€æ…‹æ¨¡å‹ï¼ˆç¤ºç¯„è³‡æ–™ï¼Œå¯æ¥çœŸå¯¦ç‹€æ…‹ï¼‰ =====
    const ccModel = {
      nodes: {
        platform: {
          id: "platform",
          name: "å¹³å°ç¸½è¦½",
          type: "platform",
          status: "ok",
          metrics: { services: 16, ips: 4 },
          admins: [{ name: "å¹³å°ç®¡ç†å“¡", role: "admin", phone: "ï¼ˆå¾…å¡«ï¼‰", email: "ï¼ˆå¾…å¡«ï¼‰" }],
          agent: { name: "å°J AI ä»£ç†", duty: "ç›£çœ‹/æç¤º/ç•™ç—•", policy: "ç„¡å›æ‡‰ï¼ç¦æ­¢é«˜é¢¨éšªä½œæ¥­" },
          children: ["domain", "org", "devices", "services", "dns", "server", "ops", "security", "ui"]
        },

        // ä½ è¦çš„ç¤ºä¾‹ï¼šé€²å…¥ã€Œç¶²åŸŸã€å¾Œå¯åœ¨åŒå±¤ç´šåˆ‡æ›å‰å°/å¾Œå°/ç®¡ç†ç­‰
        domain: {
          id: "domain",
          parent: "platform",
          name: "ç¶²åŸŸï¼ˆwuchang.lifeï¼‰",
          desc: "å‰å°/å¾Œå°/å­ç¶²åŸŸåŒå±¤ç´šåˆ‡æ›",
          status: "ok",
          metrics: { root: "wuchang.life", ttl: 300 },
          admins: [{ name: "ç¶²åŸŸ/æ†‘è­‰ç®¡ç†", role: "admin", phone: "ï¼ˆå¾…å¡«ï¼‰", email: "ï¼ˆå¾…å¡«ï¼‰" }],
          agent: { name: "å°J AI ä»£ç†", duty: "ç¶²åŸŸç‹€æ…‹çœ‹é–€ç‹—", policy: "DNS READY å‰ä¸ç°½ç™¼" },
          children: ["domain_frontend", "domain_backend", "domain_admin", "domain_verify", "domain_shop", "domain_ui"]
        },
        domain_frontend: { id: "domain_frontend", parent: "domain", name: "å‰å°ï¼ˆwwwï¼‰", desc: "å°å¤–å…¥å£/å±•ç¤º", status: "ok", metrics: { host: "www.wuchang.life", role: "frontend" }, admins: [{ name: "å‰å°å€¼ç­", role: "ops", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "å‰å°å·¡æª¢", policy: "ç•°å¸¸å…ˆæ¨™è¨»å†è™•ç½®" }, children: [] },
        domain_backend: { id: "domain_backend", parent: "domain", name: "å¾Œå°ï¼ˆodooï¼‰", desc: "å¾Œå°æ¥­å‹™/ç®¡ç†", status: "warn", metrics: { host: "odoo.wuchang.life", role: "backend" }, admins: [{ name: "å¾Œå°ç®¡ç†", role: "admin", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "å¾Œå°å·¡æª¢", policy: "å…ˆç¨½æ ¸å¾Œè®Šæ›´" }, children: [] },
        domain_admin: { id: "domain_admin", parent: "domain", name: "ç®¡ç†ï¼ˆadmin/coreï¼‰", desc: "ç®¡ç†ç«¯/æ ¸å¿ƒæœå‹™", status: "warn", metrics: { host: "admin.wuchang.life", role: "admin" }, admins: [{ name: "æ ¸å¿ƒç®¡ç†", role: "admin", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "æ¬Šé™/è®Šæ›´å®ˆé–€", policy: "ç„¡å›æ‡‰ï¼ç¦æ­¢é«˜é¢¨éšªä½œæ¥­" }, children: [] },
        domain_verify: { id: "domain_verify", parent: "domain", name: "é©—è­‰ï¼ˆverifyï¼‰", desc: "é©—è­‰æœå‹™/æ¬Šé™", status: "ok", metrics: { host: "verify.wuchang.life", role: "verify" }, admins: [{ name: "é©—è­‰ç®¡ç†", role: "admin", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "é©—è­‰å·¡æª¢", policy: "ç–‘æ…®å…ˆé™æ¬Š" }, children: [] },
        domain_shop: { id: "domain_shop", parent: "domain", name: "å•†åº—ï¼ˆshopï¼‰", desc: "å•†å®¶å…¥å£/å•†æ¥­ç«¯", status: "ok", metrics: { host: "shop.wuchang.life", role: "shop" }, admins: [{ name: "å•†åº—ç®¡ç†", role: "ops", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "å•†åº—å·¡æª¢", policy: "å¯ç”¨æ€§å„ªå…ˆ" }, children: [] },
        domain_ui: { id: "domain_ui", parent: "domain", name: "UIï¼ˆuiï¼‰", desc: "Web UI/ç®¡ç†ä»‹é¢", status: "ok", metrics: { host: "ui.wuchang.life", role: "ui" }, admins: [{ name: "UI ç®¡ç†", role: "ops", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "UI å·¡æª¢", policy: "å…ˆæç¤ºå¾Œè®Šæ›´" }, children: [] },

        // ä½ è¦çš„ç¤ºä¾‹ï¼šé€²å…¥ã€Œçµ„ç¹”ã€å¾Œå¯åœ¨åŒç´šçµ„ç¹”ä¹‹é–“åˆ‡æ›ï¼ˆå”æœƒ/åŸºé‡‘æ± /è´ŠåŠ©æ–¹ï¼‰
        org: { id: "org", parent: "platform", name: "çµ„ç¹”/ä¸»é«”", desc: "å”æœƒ/åŸºé‡‘æ± /è´ŠåŠ©æ–¹åŒå±¤ç´šåˆ‡æ›", status: "ok", metrics: { policy: "åˆè¦/å…¬é–‹/å¯ç¨½æ ¸" }, admins: [{ name: "æ²»ç†çª—å£", role: "steward", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "æ²»ç†çœ‹æ¿", policy: "å…¬é–‹/å¯ç¨½æ ¸" }, children: ["org_association", "org_fund", "org_sponsor"] },
        org_association: { id: "org_association", parent: "org", name: "å”æœƒ", desc: "æ³•å®šä¸»é«”/æ²»ç†", status: "ok", metrics: { name: "äº”å¸¸ç¤¾å€ç™¼å±•å”æœƒ" }, admins: [{ name: "å”æœƒè¯ç¹«äºº", role: "contact", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "å”æœƒè³‡è¨Šä»£ç†", policy: "å»è­˜åˆ¥/å¯å…¬é–‹" }, children: [] },
        org_fund: { id: "org_fund", parent: "org", name: "åŸºé‡‘æ± ï¼ˆä»ç¾©åº—ï¼‰", desc: "ç¨ç«‹åŸºé‡‘æ± /ç„¡è³‡æœ¬åˆ©å¾—", status: "ok", metrics: { ledger: "ä»ç¾©åº—æœƒè¨ˆç³»çµ±" }, admins: [{ name: "åŸºé‡‘/å¸³å‹™çª—å£", role: "finance", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "åŸºé‡‘ç¨½æ ¸ä»£ç†", policy: "ä¸å¯ç§é ˜/å¯ç¨½æ ¸" }, children: [] },
        org_sponsor: { id: "org_sponsor", parent: "org", name: "è´ŠåŠ©æ–¹ï¼ˆé‡æ–°åº—ï¼‰", desc: "åªå‡ºä¸é€²/ä¸å¾—å›æµ", status: "warn", metrics: { mode: "åªå‡ºä¸é€²" }, admins: [{ name: "è´ŠåŠ©è¯ç¹«äºº", role: "sponsor", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "è´ŠåŠ©éš”é›¢ä»£ç†", policy: "åªå‡ºä¸é€²" }, children: [] },

        // è¨­å‚™ï¼šè·¯ç”±å™¨/ä¼ºæœå™¨/GPU/æ”å½±æ©Ÿ/ä¿å…¨â€¦ï¼ˆæ¯å€‹ä½ç½®éƒ½æ›å°Jä»£ç†ï¼‰
        devices: { id: "devices", parent: "platform", name: "è¨­å‚™", desc: "è¨­å‚™æ¸…å–®èˆ‡ä½ç½®/è²¬ä»»/è¯ç¹«", status: "warn", metrics: { site: "ç¾å ´/é›²ç«¯" }, admins: [{ name: "è¨­å‚™ç®¡ç†", role: "ops", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "è¨­å‚™å·¡æª¢", policy: "ç•°å¸¸å…ˆæ¨™è¨»" }, children: ["dev_router", "dev_server", "dev_local", "dev_gpu0", "dev_gpu1", "dev_cam_01", "dev_cam_02", "dev_cam_03", "dev_cam_04", "dev_cam_05", "dev_cam_06", "dev_cam_07", "dev_cam_08", "dev_cam_09", "dev_security_vendor"] },
        dev_router: { id: "dev_router", parent: "devices", name: "è·¯ç”±å™¨ï¼ˆASUS RT-BE86Uï¼‰", desc: "DDNS/è½‰ç™¼/ç¶²è·¯å…¥å£", status: "warn", metrics: { ddns: "CoffeeLoge.asuscomm.com:8443", wan_ip: "220.135.21.74" }, admins: [{ name: "ç¶²è·¯ç®¡ç†", role: "netops", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "å…¥å£å±¤å·¡æª¢", policy: "é€£ç·šä¸å¯ç”¨å…ˆæ­¢è¡€" }, children: [] },
        dev_server: { id: "dev_server", parent: "devices", name: "ä¼ºæœå™¨ï¼ˆä¸»æ©Ÿï¼‰", desc: "æœå‹™æ‰¿è¼‰/æ¨é€æ¥æ”¶", status: "warn", metrics: { note: "é›™ GPU" }, admins: [{ name: "ä¼ºæœå™¨ç®¡ç†", role: "ops", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "ä¼ºæœå™¨å®ˆæœ›", policy: "ç„¡å›æ‡‰ï¼ç¦æ­¢é«˜é¢¨éšªä½œæ¥­" }, children: [] },
        dev_local: { id: "dev_local", parent: "devices", name: "æœ¬æ©Ÿï¼ˆä¸­æ§/æ“ä½œç«¯ï¼‰", desc: "æœ¬æ©Ÿä¸­æ§ UI/å·¥å…·åŸ·è¡Œç«¯", status: "ok", metrics: { os: "Windows", ui: "127.0.0.1:8788" }, admins: [{ name: "ç¾å ´å€¼ç­", role: "ops", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "æœ¬æ©Ÿä»£ç†", policy: "å…ˆç¨½æ ¸å¾Œå‹•ä½œ" }, children: [] },
        dev_gpu0: { id: "dev_gpu0", parent: "devices", name: "GPU #0", desc: "æ¨è«–/å½±åƒåˆ†æ", status: "ok", metrics: { vram: "ï¼ˆå¾…å¡«ï¼‰" }, admins: [{ name: "AI/ç®—åŠ›ç®¡ç†", role: "mlops", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "ç®—åŠ›åˆ†é…æç¤º", policy: "å…ˆç¢ºèªè² è¼‰" }, children: [] },
        dev_gpu1: { id: "dev_gpu1", parent: "devices", name: "GPU #1", desc: "æ¨è«–/å½±åƒåˆ†æ", status: "ok", metrics: { vram: "ï¼ˆå¾…å¡«ï¼‰" }, admins: [{ name: "AI/ç®—åŠ›ç®¡ç†", role: "mlops", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "ç®—åŠ›åˆ†é…æç¤º", policy: "å…ˆç¢ºèªè² è¼‰" }, children: [] },
        dev_cam_01: { id: "dev_cam_01", parent: "devices", name: "æ”å½±æ©Ÿ 01", desc: "åº—å…§ç›£è¦–å™¨", status: "ok", metrics: { zone: "ï¼ˆå¾…å¡«ï¼‰" }, admins: [{ name: "ç¾å ´ç®¡ç†", role: "ops", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "å½±åƒé»ä½ä»£ç†", policy: "åªåšäº‹ä»¶è¨˜éŒ„/ä¸åˆªé™¤" }, children: [] },
        dev_cam_02: { id: "dev_cam_02", parent: "devices", name: "æ”å½±æ©Ÿ 02", desc: "åº—å…§ç›£è¦–å™¨", status: "ok", metrics: { zone: "ï¼ˆå¾…å¡«ï¼‰" }, admins: [{ name: "ç¾å ´ç®¡ç†", role: "ops", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "å½±åƒé»ä½ä»£ç†", policy: "åªåšäº‹ä»¶è¨˜éŒ„/ä¸åˆªé™¤" }, children: [] },
        dev_cam_03: { id: "dev_cam_03", parent: "devices", name: "æ”å½±æ©Ÿ 03", desc: "åº—å…§ç›£è¦–å™¨", status: "ok", metrics: { zone: "ï¼ˆå¾…å¡«ï¼‰" }, admins: [{ name: "ç¾å ´ç®¡ç†", role: "ops", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "å½±åƒé»ä½ä»£ç†", policy: "åªåšäº‹ä»¶è¨˜éŒ„/ä¸åˆªé™¤" }, children: [] },
        dev_cam_04: { id: "dev_cam_04", parent: "devices", name: "æ”å½±æ©Ÿ 04", desc: "åº—å…§ç›£è¦–å™¨", status: "ok", metrics: { zone: "ï¼ˆå¾…å¡«ï¼‰" }, admins: [{ name: "ç¾å ´ç®¡ç†", role: "ops", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "å½±åƒé»ä½ä»£ç†", policy: "åªåšäº‹ä»¶è¨˜éŒ„/ä¸åˆªé™¤" }, children: [] },
        dev_cam_05: { id: "dev_cam_05", parent: "devices", name: "æ”å½±æ©Ÿ 05", desc: "åº—å…§ç›£è¦–å™¨", status: "ok", metrics: { zone: "ï¼ˆå¾…å¡«ï¼‰" }, admins: [{ name: "ç¾å ´ç®¡ç†", role: "ops", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "å½±åƒé»ä½ä»£ç†", policy: "åªåšäº‹ä»¶è¨˜éŒ„/ä¸åˆªé™¤" }, children: [] },
        dev_cam_06: { id: "dev_cam_06", parent: "devices", name: "æ”å½±æ©Ÿ 06", desc: "åº—å…§ç›£è¦–å™¨", status: "ok", metrics: { zone: "ï¼ˆå¾…å¡«ï¼‰" }, admins: [{ name: "ç¾å ´ç®¡ç†", role: "ops", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "å½±åƒé»ä½ä»£ç†", policy: "åªåšäº‹ä»¶è¨˜éŒ„/ä¸åˆªé™¤" }, children: [] },
        dev_cam_07: { id: "dev_cam_07", parent: "devices", name: "æ”å½±æ©Ÿ 07", desc: "åº—å…§ç›£è¦–å™¨", status: "ok", metrics: { zone: "ï¼ˆå¾…å¡«ï¼‰" }, admins: [{ name: "ç¾å ´ç®¡ç†", role: "ops", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "å½±åƒé»ä½ä»£ç†", policy: "åªåšäº‹ä»¶è¨˜éŒ„/ä¸åˆªé™¤" }, children: [] },
        dev_cam_08: { id: "dev_cam_08", parent: "devices", name: "æ”å½±æ©Ÿ 08", desc: "åº—å…§ç›£è¦–å™¨", status: "ok", metrics: { zone: "ï¼ˆå¾…å¡«ï¼‰" }, admins: [{ name: "ç¾å ´ç®¡ç†", role: "ops", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "å½±åƒé»ä½ä»£ç†", policy: "åªåšäº‹ä»¶è¨˜éŒ„/ä¸åˆªé™¤" }, children: [] },
        dev_cam_09: { id: "dev_cam_09", parent: "devices", name: "æ”å½±æ©Ÿ 09", desc: "åº—å…§ç›£è¦–å™¨", status: "ok", metrics: { zone: "ï¼ˆå¾…å¡«ï¼‰" }, admins: [{ name: "ç¾å ´ç®¡ç†", role: "ops", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "å½±åƒé»ä½ä»£ç†", policy: "åªåšäº‹ä»¶è¨˜éŒ„/ä¸åˆªé™¤" }, children: [] },
        dev_security_vendor: { id: "dev_security_vendor", parent: "devices", name: "ä¿å…¨ç³»çµ±ï¼ˆä¸­èˆˆï¼‰", desc: "å¤–æ›æ¨¡çµ„/å‘Šè­¦ä¾†æº", status: "warn", metrics: { vendor: "ä¸­èˆˆä¿å…¨" }, admins: [{ name: "ä¿å…¨è¯ç¹«äºº", role: "vendor", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "å‘Šè­¦äº‹ä»¶ä»£ç†", policy: "åªåšè™•ç½®/ä¸åˆªé™¤" }, children: [] },

        // æœå‹™ï¼šå¹³å°æœå‹™æ¸…å–®ï¼ˆèˆ‡è¨­å‚™/ç¶²åŸŸå°æ‡‰ï¼‰
        services: { id: "services", parent: "platform", name: "æœå‹™", desc: "å¹³å°æœå‹™æ¸…å–®/å°æ‡‰è³‡è¨Š/è¯ç¹«", status: "warn", metrics: { note: "å¯é€æ­¥æ¥çœŸå¯¦å¥åº·æª¢æŸ¥" }, admins: [{ name: "æœå‹™ç®¡ç†", role: "ops", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "æœå‹™å·¡æª¢", policy: "ç„¡å›æ‡‰ï¼ç¦æ­¢é«˜é¢¨éšªä½œæ¥­" }, children: ["svc_control_center", "svc_dns_check", "svc_sync_push", "svc_security_demo", "svc_community_api"] },
        svc_control_center: { id: "svc_control_center", parent: "services", name: "æœ¬æ©Ÿä¸­æ§å°æœå‹™", desc: "local_control_center.py", status: "ok", metrics: { url: "http://127.0.0.1:8788/" }, admins: [{ name: "æœ¬æ©Ÿç¶­é‹", role: "ops", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "ä¸­æ§çœ‹æ¿ä»£ç†", policy: "åªé¡¯ç¤º/ä¸è‡ªå‹•æ”¹" }, children: [] },
        svc_dns_check: { id: "svc_dns_check", parent: "services", name: "DNS å‚³æ’­æª¢æŸ¥", desc: "dns_propagation_check.py", status: "ok", metrics: { resolvers: 4 }, admins: [{ name: "DNS ç¶­é‹", role: "ops", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "DNS READY åˆ¤å®š", policy: "READY æ‰ç°½ç™¼" }, children: [] },
        svc_sync_push: { id: "svc_sync_push", parent: "services", name: "åŒæ­¥æ¨é€", desc: "safe_sync_push.py", status: "warn", metrics: { audit: "risk_action_audit.jsonl" }, admins: [{ name: "æ¨é€ç¶­é‹", role: "ops", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "æ¨é€å®ˆé–€", policy: "ç„¡å›æ‡‰ï¼ç¦æ­¢" }, children: [] },
        svc_security_demo: { id: "svc_security_demo", parent: "services", name: "ä¿å…¨è™•ç½®æ¼”ç¤º", desc: "demo_security_ack_server.py", status: "warn", metrics: { port: 8799 }, admins: [{ name: "ä¿å…¨æ•´åˆ", role: "ops", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "å‘Šè­¦è™•ç½®ä»£ç†", policy: "å¯ç¨½æ ¸/ä¸åˆªé™¤" }, children: [] },
        svc_community_api: { id: "svc_community_api", parent: "services", name: "ç¤¾å€ APIï¼ˆBlueprintï¼‰", desc: "api_community_data.py", status: "ok", metrics: { health: "/health" }, admins: [{ name: "å¾Œç«¯ç¶­é‹", role: "ops", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "API å·¡æª¢", policy: "å¥åº·æª¢æŸ¥å…ˆè¡Œ" }, children: [] },

        dns: { id: "dns", parent: "platform", name: "DNS / æ†‘è­‰", desc: "DNS è§£æã€_acme-challengeã€ç°½ç™¼å‰ç½®", status: "warn", metrics: { ttl: 300, acme: "pending" }, admins: [{ name: "DNS ç®¡ç†", role: "netops", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "DNS/æ†‘è­‰ä»£ç†", policy: "READY æ‰ç°½ç™¼" }, children: ["dns_acme", "dns_records"] },
        dns_acme: { id: "dns_acme", parent: "dns", name: "_acme-challenge", desc: "DNS-01 é©—è­‰ TXT", status: "warn", metrics: { token: "from dns_records.json" }, admins: [{ name: "DNS ç®¡ç†", role: "netops", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "ACME token æª¢æ ¸", policy: "ä¸€è‡´æ‰é" }, children: [] },
        dns_records: { id: "dns_records", parent: "dns", name: "A/CNAME/TXT è¨˜éŒ„", desc: "ä¸»è¦å­ç¶²åŸŸèˆ‡ IP å°ç…§", status: "ok", metrics: { records: "dns_records.json" }, admins: [{ name: "DNS ç®¡ç†", role: "netops", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "DNS è¨˜éŒ„ä»£ç†", policy: "è®Šæ›´è¦ç•™ç—•" }, children: [] },

        server: { id: "server", parent: "platform", name: "ä¼ºæœå™¨å¥åº·", desc: "health URLã€é€£ç·šç‹€æ…‹ã€æœå‹™å¯é”æ€§", status: "warn", metrics: { health: "æœªæª¢æŸ¥" }, admins: [{ name: "ä¼ºæœå™¨ç®¡ç†", role: "ops", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "å¥åº·æª¢æŸ¥å®ˆé–€", policy: "ç„¡å›æ‡‰ï¼ç¦æ­¢é«˜é¢¨éšªä½œæ¥­" }, children: ["server_api", "server_storage"] },
        server_api: { id: "server_api", parent: "server", name: "API", desc: "/health /api/* æœå‹™", status: "warn", metrics: { endpoints: 2 }, admins: [{ name: "å¾Œç«¯ç¶­é‹", role: "ops", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "API å¥åº·å·¡æª¢", policy: "å…ˆå¥åº·å¾Œæ¨é€" }, children: [] },
        server_storage: { id: "server_storage", parent: "server", name: "å„²å­˜/æ¥æ”¶ç›®éŒ„", desc: "SMB/æ›è¼‰ç£ç¢Ÿæ¥æ”¶æ¨é€", status: "ok", metrics: { path: "WUCHANG_COPY_TO" }, admins: [{ name: "å„²å­˜ç®¡ç†", role: "ops", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "æ¥æ”¶ç›®éŒ„ä»£ç†", policy: "åªç‰ˆæœ¬åŒ–ä¸è¦†è“‹" }, children: [] },

        ops: { id: "ops", parent: "platform", name: "ç¶­é‹ï¼ˆæ¨é€/ç¨½æ ¸ï¼‰", desc: "åŒæ­¥æ¨é€ã€ç¨½æ ¸ã€ç„¡å›æ‡‰ç¦æ­¢", status: "ok", metrics: { audit: "risk_action_audit.jsonl" }, admins: [{ name: "å€¼ç­ç¶­é‹", role: "ops", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "ç¶­é‹å”ä½œ", policy: "å…ˆçœ‹ SOP" }, children: ["push_rules", "push_kb", "audit"] },
        push_rules: { id: "push_rules", parent: "ops", name: "æ¨é€è¦å‰‡", desc: "rules profile æ¨é€", status: "ok", metrics: { tool: "safe_sync_push.py" }, children: [] },
        push_kb: { id: "push_kb", parent: "ops", name: "æ¨é€ç´¢å¼•", desc: "kb profile æ¨é€", status: "ok", metrics: { tool: "safe_sync_push.py" }, children: [] },
        audit: { id: "audit", parent: "ops", name: "ç¨½æ ¸", desc: "append-only JSONL", status: "ok", metrics: { tail: 50 }, children: [] },

        security: { id: "security", parent: "platform", name: "ä¿å…¨/å‘Šè­¦ï¼ˆæ¼”ç¤ºï¼‰", desc: "ä¸€éµè™•ç½® + å¯ç¨½æ ¸ï¼ˆä¸åˆªé™¤ï¼‰", status: "warn", metrics: { demo: 8799 }, admins: [{ name: "ä¿å…¨æ•´åˆ", role: "ops", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "å‘Šè­¦è™•ç½®ä»£ç†", policy: "å¯ç¨½æ ¸/ä¸åˆªé™¤" }, children: ["security_demo"] },
        security_demo: { id: "security_demo", parent: "security", name: "demo ack server", desc: "/health /api/security/*", status: "warn", metrics: { port: 8799 }, children: [] },

        ui: { id: "ui", parent: "platform", name: "æœ¬æ©Ÿä¸­æ§ UI", desc: "ä¸­æ–‡åŒ–äº’å‹•å±¤ã€æ¨¹ç‹€/åœ°åœ–/ç‹€æ…‹", status: "ok", metrics: { port: 8788 }, admins: [{ name: "ä¸­æ§ç¶­é‹", role: "ops", phone: "ï¼ˆå¾…å¡«ï¼‰" }], agent: { name: "å°J AI ä»£ç†", duty: "ä¸­æ§å°è¦½ä»£ç†", policy: "è®“äººä¸è¿·è·¯" }, children: ["ui_map", "ui_docs"] },
        ui_map: { id: "ui_map", parent: "ui", name: "ä¸­å¤®åœ°åœ–æ¨¡çµ„", desc: "ç’°ç‹€åˆ‡æ› + æ¨¹ç‹€å°è¦½", status: "ok", metrics: { mode: "module/platform" }, children: [] },
        ui_docs: { id: "ui_docs", parent: "ui", name: "è¦å‰‡æ–‡ä»¶", desc: "SOP/æ†²æ³•æŸ¥é–±", status: "ok", metrics: { docs: 2 }, children: [] },
      }
    };

    // å¼·åˆ¶ï¼šæ¯å€‹ä½ç½®éƒ½å¿…é ˆæœ‰å°Jä»£ç†ï¼ˆè‹¥ç¼ºæ¼å°±è£œä¸Šé è¨­ä»£ç†ï¼‰
    const ccDefaultAgent = { name: "å°J AI ä»£ç†", duty: "ç›£çœ‹/æç¤º/ç•™ç—•", policy: "ç„¡å›æ‡‰ï¼ç¦æ­¢é«˜é¢¨éšªä½œæ¥­" };
    for (const id of Object.keys(ccModel.nodes)) {
      const n = ccModel.nodes[id];
      if (!n.agent) n.agent = { ...ccDefaultAgent };
      if (!n.admins) n.admins = [{ name: "ï¼ˆå¾…æŒ‡æ´¾ï¼‰", role: "ops", phone: "ï¼ˆå¾…å¡«ï¼‰" }];
    }

    const ccStatusRank = { bad: 4, offline: 3, warn: 2, ok: 1 };
    const ccStatusLabel = { ok: "OK", warn: "WARN", bad: "BAD", offline: "OFFLINE" };
    const ccStatusPillClass = (s) => (s === "ok" ? "ok" : (s === "warn" ? "unk" : "bad")); // reuse existing pill palette

    let ccCurrentRoot = "platform";
    let ccSelected = "platform";

    function ccGetNode(id) { return ccModel.nodes[id]; }

    function ccAggregateStatus(id) {
      const node = ccGetNode(id);
      if (!node) return "offline";
      if (!node.children || !node.children.length) return node.status || "offline";
      let best = node.status || "ok";
      for (const cid of node.children) {
        const cs = ccAggregateStatus(cid);
        if (ccStatusRank[cs] > ccStatusRank[best]) best = cs;
      }
      return best;
    }

    function ccPath(id) {
      const path = [];
      let cur = ccGetNode(id);
      while (cur) {
        path.unshift(cur);
        cur = cur.parent ? ccGetNode(cur.parent) : null;
      }
      return path;
    }

    function ccRenderBreadcrumb() {
      const p = ccPath(ccSelected);
      $("ccBreadcrumb").innerHTML = p.map(n => `<span class="mono">${n.name}</span>`).join("  /  ");
    }

    function ccDotClass(status) {
      if (status === "ok") return "ok";
      if (status === "warn") return "warn";
      if (status === "bad") return "bad";
      return "offline";
    }

    function ccNodeDisplayStatus(id) {
      const mode = $("ccViewMode").value;
      return mode === "platform" ? ccAggregateStatus(id) : (ccGetNode(id)?.status || "offline");
    }

    function ccRenderTree(rootId) {
      const root = ccGetNode(rootId);
      if (!root) { $("ccTree").textContent = "ï¼ˆæ‰¾ä¸åˆ°æ¨¹ç‹€è³‡æ–™ï¼‰"; return; }

      function renderNode(id) {
        const n = ccGetNode(id);
        if (!n) return "";
        const st = ccNodeDisplayStatus(id);
        const active = id === ccSelected ? "active" : "";
        const hint = n.desc ? `<span class="hint">â€” ${n.desc}</span>` : "";
        const hasChild = (n.children && n.children.length) ? true : false;
        const childHtml = hasChild ? `<ul>${n.children.map(renderNode).join("")}</ul>` : "";
        return `
          <li>
            <div class="item ${active}" data-cc-node="${id}">
              <span class="cc-dot ${ccDotClass(st)}"></span>
              <span class="name">${n.name}</span>
              ${hint}
            </div>
            ${childHtml}
          </li>
        `;
      }

      $("ccTree").innerHTML = `<ul>${renderNode(rootId)}</ul>`;
      $("ccTree").querySelectorAll("[data-cc-node]").forEach(el => {
        el.addEventListener("click", () => ccSelect(el.getAttribute("data-cc-node")));
      });
    }

    function ccRenderRing(rootId) {
      // éœ€æ±‚ï¼šåŒä¸€å±¤ç´šåˆ‡æ›ï¼ˆåŒç´šå‰å°/å¾Œå°ã€åŒç´šçµ„ç¹”ï¼‰
      // è¦å‰‡ï¼šä»¥ã€Œè¢«é¸å–ç¯€é»çš„çˆ¶ç¯€é»ã€ä½œç‚ºåŒå±¤ç´šï¼›è‹¥æ²’æœ‰çˆ¶ç¯€é»ï¼Œå°±ç”¨ç›®å‰ä¸­å¤®å±¤ç´šã€‚
      const sel = ccGetNode(ccSelected);
      const ringBaseId = (sel && sel.parent) ? sel.parent : ccCurrentRoot;
      const root = ccGetNode(ringBaseId);
      const ring = $("ccRing");
      ring.innerHTML = "";
      const targets = (root && root.children) ? root.children.slice(0, 6) : [];
      const n = targets.length || 1;
      const radius = 150;
      for (let i = 0; i < targets.length; i++) {
        const id = targets[i];
        const node = ccGetNode(id);
        const angle = (Math.PI * 2) * (i / n) - Math.PI / 2;
        const x = 180 + radius * Math.cos(angle) - 60;
        const y = 180 + radius * Math.sin(angle) - 18;
        const btn = document.createElement("button");
        btn.textContent = node?.name || id;
        btn.style.left = `${x}px`;
        btn.style.top = `${y}px`;
        // åŒå±¤ç´š ringï¼šä»¥ã€Œç›®å‰è¢«é¸å–ã€ä½œç‚º active
        if (id === ccSelected) btn.classList.add("active");
        btn.addEventListener("click", () => {
          ccSelect(id);
        });
        ring.appendChild(btn);
      }
    }

    function ccRenderMap() {
      const root = ccGetNode(ccCurrentRoot);
      const zones = ["A", "B", "C", "D"];
      const children = (root?.children || []).slice(0, 4);
      const fill = (idx) => children[idx] ? ccGetNode(children[idx]) : null;
      const zoneNodes = [fill(0), fill(1), fill(2), fill(3)];

      function setZone(idx, key) {
        const n = zoneNodes[idx];
        const titleEl = $(`ccZone${key}Title`);
        const descEl = $(`ccZone${key}Desc`);
        const stateEl = $(`ccZone${key}State`);
        const metricEl = $(`ccZone${key}Metric`);
        const zoneEl = $("ccMap").querySelector(`.cc-zone[data-zone="${key}"]`);
        zoneEl.classList.remove("active");

        if (!n) {
          titleEl.textContent = "ï¼ˆç©ºï¼‰";
          descEl.textContent = "â€”";
          stateEl.className = "pill unk";
          stateEl.textContent = "N/A";
          metricEl.textContent = "â€”";
          zoneEl.onclick = null;
          return;
        }

        const st = ccNodeDisplayStatus(n.id);
        stateEl.className = `pill ${ccStatusPillClass(st)}`;
        stateEl.textContent = ccStatusLabel[st] || st;
        titleEl.textContent = n.name;
        descEl.textContent = n.desc || "â€”";
        const mkeys = Object.keys(n.metrics || {});
        metricEl.textContent = mkeys.length ? `${mkeys[0]}=${String(n.metrics[mkeys[0]])}` : "â€”";
        if (n.id === ccSelected) zoneEl.classList.add("active");
        zoneEl.onclick = () => ccSelect(n.id);
      }

      setZone(0, "A");
      setZone(1, "B");
      setZone(2, "C");
      setZone(3, "D");

      $("ccCenterTitle").textContent = root?.name || "å¹³å°ç¸½è¦½";
      const centerStatus = ccAggregateStatus(ccCurrentRoot);
      $("ccCenterState").className = `pill ${ccStatusPillClass(centerStatus)}`;
      $("ccCenterState").textContent = ccStatusLabel[centerStatus] || centerStatus;

      // platform status field (right panel)
      const plat = ccAggregateStatus("platform");
      $("ccPlatformStatus").value = `${ccStatusLabel[plat] || plat}ï¼ˆèšåˆï¼‰`;
    }

    function ccRenderDetails() {
      const n = ccGetNode(ccSelected);
      if (!n) return;
      $("ccNodeStatus").value = n.status || "ok";

      const stDisp = ccNodeDisplayStatus(ccSelected);
      const piiIdent = (window.__piiCacheIdent && window.__piiCacheIdent[n.id]) ? window.__piiCacheIdent[n.id] : null;
      const piiNon = (window.__piiCacheNon && window.__piiCacheNon[n.id]) ? window.__piiCacheNon[n.id] : null;
      const adminsPublic = piiNon
        ? `${piiNon.role ? (piiNon.role) : "ï¼ˆæœªå¡«è§’è‰²ï¼‰"}${piiNon.note ? (" / " + piiNon.note) : ""}`
        : "ï¼ˆæœªå¡«/æœªè¼‰å…¥ï¼‰";
      const adminsPrivate = piiIdent
        ? `${piiIdent.name || "ï¼ˆæœªå¡«ï¼‰"}${piiIdent.phone ? " / " + piiIdent.phone : ""}${piiIdent.email ? " / " + piiIdent.email : ""}`
        : "ï¼ˆç§å¯†ï¼šæœªç™»å…¥/ç„¡æ¬Šé™/æœªè¼‰å…¥/æœªå¡«ï¼‰";
      const agent = n.agent || ccDefaultAgent;
      const agentLine = `${agent.name}ï½œ${agent.duty}ï½œ${agent.policy}`;
      const lines = [
        ["ç¯€é»", n.name],
        ["ID", n.id],
        ["é¡å‹", n.type || "module"],
        ["é¡¯ç¤ºç‹€æ…‹", `${ccStatusLabel[stDisp] || stDisp}ï¼ˆ${$("ccViewMode").value === "platform" ? "èšåˆ" : "æœ¬é«”"}ï¼‰`],
        ["èªªæ˜", n.desc || "â€”"],
        ["ç®¡ç†å“¡è¯ç¹«ï¼ˆå…¬é–‹/ä¸å¯è­˜åˆ¥ï¼‰", adminsPublic || "ï¼ˆæœªå¡«ï¼‰"],
        ["ç®¡ç†å“¡è¯ç¹«ï¼ˆç§å¯†/å¯è­˜åˆ¥ï¼‰", adminsPrivate || "ï¼ˆæœªå¡«ï¼‰"],
        ["å°J AI ä»£ç†", agentLine],
        ["å­ç¯€é»æ•¸", String((n.children || []).length)],
        ["è³‡æ–™", Object.keys(n.metrics || {}).length ? JSON.stringify(n.metrics, null, 0) : "â€”"]
      ];
      $("ccDetails").innerHTML = lines.map(([k,v]) => `<div class="k">${k}</div><div class="v">${String(v)}</div>`).join("");
      $("ccAgentOut").value = `ï¼ˆå°Jå¾…å‘½ï¼‰\nç¯€é»ï¼š${n.name}\nç‹€æ…‹ï¼š${ccStatusLabel[stDisp] || stDisp}\nè¦å‰‡ï¼š${agent.policy}\n\næç¤ºï¼šé»ã€Œå°Jï¼šè™•ç½®å»ºè­°ã€æˆ–ã€Œå°Jï¼šæ¯æ—¥æ‘˜è¦ã€ã€‚`;
    }

    function ccSelect(id) {
      if (!ccModel.nodes[id]) return;
      ccSelected = id;
      ccRenderAll();
      // å€‹è³‡åˆ†ç´šï¼šåˆ‡ç¯€é»æ™‚è‡ªå‹•è¼‰å…¥ï¼ˆå…¬é–‹/ç§å¯†å„ä¸€ä»½ï¼‰
      try { piiLoadAllForSelected().catch(() => {}); } catch (e) {}
    }

    function ccGoUp() {
      const n = ccGetNode(ccSelected);
      if (n?.parent) ccSelect(n.parent);
    }

    function ccGoDown() {
      const n = ccGetNode(ccSelected);
      if (n?.children && n.children.length) ccSelect(n.children[0]);
    }

    function ccApplyStatus() {
      const n = ccGetNode(ccSelected);
      if (!n) return;
      const v = $("ccNodeStatus").value;
      n.status = v;
      ccRenderAll();
      logRun({ ok: true, action: "set_status", node: n.id, status: v });
    }

    function ccShowHint() {
      const n = ccGetNode(ccSelected);
      const hints = [];
      if (n.id.startsWith("dns")) {
        hints.push("DNS è™•ç½®ï¼šè«‹å…ˆç”¨ã€Œè¼‰å…¥é æœŸå€¼ã€å–å¾— _acme-challenge TXTï¼Œè²¼åˆ° DNS ç®¡ç†ä»‹é¢å¾Œç­‰å¾… TTL å‚³æ’­ã€‚");
        hints.push("å®Œæˆå¾Œç”¨ã€ŒæŸ¥è©¢å‚³æ’­ç‹€æ…‹ï¼ˆå¤š DNSï¼‰ã€ç¢ºèª READYï¼Œå†é€²è¡Œæ†‘è­‰ç°½ç™¼ã€‚");
      } else if (n.id.startsWith("server")) {
        hints.push("ä¼ºæœå™¨è™•ç½®ï¼šå…ˆç¢ºèª health URL å¯å›æ‡‰ï¼ˆç„¡å›æ‡‰ï¼ç¦æ­¢é«˜é¢¨éšªä½œæ¥­ï¼‰ã€‚");
        hints.push("å¿…è¦æ™‚å…ˆåˆ‡ç¶­è­·æ¨¡å¼ï¼Œå†åšæ¨é€/ç´¢å¼•/æ¸…å¿«å–ã€‚");
      } else if (n.id.startsWith("push")) {
        hints.push("æ¨é€è™•ç½®ï¼šæ¨é€å‰å¿…é ˆé€šé health æª¢æŸ¥ï¼›æ²’æœ‰ health æˆ–ç„¡å›æ‡‰æœƒè¢«é˜»æ“‹ï¼ˆé€™æ˜¯é æœŸè¡Œç‚ºï¼‰ã€‚");
      } else {
        hints.push("æç¤ºï¼šæ­¤æ¨¡çµ„ç›®å‰æ˜¯ UI ç¤ºç¯„å±¤ï¼Œå¯å…ˆç”¨ã€Œå¥—ç”¨ç‹€æ…‹ã€åšæ¼”ç·´èˆ‡æ¨™è¨»ï¼Œå¾ŒçºŒå†æ¥çœŸå¯¦è³‡æ–™æºã€‚");
      }
      logRun({ ok: true, node: n.id, hint: hints });
    }

    function ccAgentSuggest() {
      const n = ccGetNode(ccSelected);
      if (!n) return;
      const st = ccNodeDisplayStatus(n.id);
      const todo = [];
      if (st === "offline" || st === "bad") {
        todo.push("å…ˆæ­¢è¡€ï¼šæ¨™è¨˜ç•°å¸¸ã€ç¢ºèªå½±éŸ¿ç¯„åœã€é¿å…é«˜é¢¨éšªä½œæ¥­ï¼ˆç„¡å›æ‡‰ï¼ç¦æ­¢ï¼‰ã€‚");
      }
      if (n.id.startsWith("dns")) {
        todo.push("å…ˆè¼‰å…¥ dns_records.json çš„ _acme-challenge é æœŸå€¼ â†’ è²¼åˆ° DNS ç®¡ç†ä»‹é¢ã€‚");
        todo.push("å†ç”¨ã€Œå¤š DNS æŸ¥è©¢ã€ç¢ºèª READY â†’ æ‰èƒ½ç°½ç™¼æ†‘è­‰ã€‚");
      }
      if (n.id.startsWith("server")) {
        todo.push("å…ˆæª¢æŸ¥ health URL æ˜¯å¦å¯å›æ‡‰ï¼›ç„¡å›æ‡‰å°±åœæ­¢æ¨é€/é‡å•Ÿ/æ¸…å¿«å–ã€‚");
      }
      if (n.id.startsWith("dev_")) {
        todo.push("è¨­å‚™ï¼šå…ˆç¢ºèªä¾›é›»/ç¶²è·¯/ä½ç½®ï¼Œå†æ±ºå®šè¦ä¸è¦æ´¾äººåˆ°å ´ï¼ˆç•™ç—•ï¼‰ã€‚");
      }
      if (n.id.startsWith("svc_") || n.id.startsWith("push_")) {
        todo.push("æœå‹™ï¼šå…ˆçœ‹ç¨½æ ¸ï¼ˆrisk_action_audit.jsonlï¼‰ç¢ºèªæœ€å¾Œä¸€æ¬¡å‹•ä½œèˆ‡çµæœã€‚");
      }
      if (!todo.length) todo.push("ä¿æŒç¾ç‹€ï¼šæŒçºŒç›£çœ‹ï¼Œæœ‰è®Šæ›´å…ˆç•™ç—•ã€‚");
      $("ccAgentOut").value = `ã€å°Jï¼šè™•ç½®å»ºè­°ã€‘\nç¯€é»ï¼š${n.name}\nç‹€æ…‹ï¼š${ccStatusLabel[st] || st}\n\n- ${todo.join("\n- ")}\n`;
      logRun({ ok: true, node: n.id, agent: "little_j", suggest: todo });
    }

    function ccAgentDaily() {
      const n = ccGetNode(ccSelected);
      if (!n) return;
      const siblings = (n.parent ? (ccGetNode(n.parent)?.children || []) : ccGetNode("platform")?.children || []).slice(0, 12);
      const snapshot = siblings.map(id => {
        const st = ccNodeDisplayStatus(id);
        const name = ccGetNode(id)?.name || id;
        return `${name}: ${ccStatusLabel[st] || st}`;
      });
      const msg = [
        `ã€å°Jï¼šæ¯æ—¥æ‘˜è¦ã€‘`,
        `ç„¦é»ç¯€é»ï¼š${n.name}`,
        `åŒå±¤ç´šç‹€æ…‹ï¼š`,
        ...snapshot.map(x => `- ${x}`),
        ``,
        `æé†’ï¼šä»»ä½•é«˜é¢¨éšªä½œæ¥­å‰ï¼Œå…ˆçœ‹ SOP æª¢æ ¸è¡¨ï¼›ç„¡å›æ‡‰ï¼ç¦æ­¢ã€‚`
      ].join("\n");
      $("ccAgentOut").value = msg;
      logRun({ ok: true, node: n.id, agent: "little_j", daily: snapshot });
    }

    async function ccWriteWorkspace() {
      const n = ccGetNode(ccSelected);
      if (!n) return;
      const st = ccNodeDisplayStatus(n.id);
      const content = ($("ccAgentOut").value || "").trim();
      if (!content) {
        logRun("æ²’æœ‰å¯å¯«å…¥çš„å…§å®¹ï¼ˆè«‹å…ˆç”¢ç”Ÿå°Jè¼¸å‡ºï¼‰ã€‚");
        return;
      }
      const pub = (window.__piiCacheNon && window.__piiCacheNon[n.id]) ? window.__piiCacheNon[n.id] : null;
      const admins_public = pub ? [{ role: pub.role || "", note: pub.note || "" }] : [];
      const body = {
        kind: "little_j_agent",
        title: `${n.name}__${ccStatusLabel[st] || st}`,
        content,
        meta: {
          node_id: n.id,
          node_name: n.name,
          status: st,
          admins: [],
          admins_public,
        }
      };
      const { data } = await fetchJson("/api/workspace/write", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      logRun(data);
    }

    function ccRenderAll() {
      ccRenderBreadcrumb();
      ccRenderTree(ccCurrentRoot);
      ccRenderRing();
      ccRenderMap();
      ccRenderDetails();
    }

    function setPill(el, state, text) {
      el.classList.remove("ok","bad","unk");
      el.classList.add(state);
      el.textContent = text;
    }

    function logRun(obj) {
      const showRaw = $("showRawJson")?.checked === true;
      if (typeof obj === "string") {
        $("runLog").textContent = obj;
        return;
      }

      function fmtList(arr) {
        if (!arr || !arr.length) return "ï¼ˆç„¡ï¼‰";
        return arr.map(x => String(x)).join("ã€");
      }

      function summarizeServerHealth(data) {
        const h = data?.health;
        if (!h) return null;
        const ok = h.ok === true;
        return [
          "ã€ä¼ºæœå™¨å¥åº·æª¢æŸ¥ã€‘",
          `çµæœï¼š${ok ? "OKï¼ˆå¯é”ï¼‰" : "ç„¡å›æ‡‰/ä¸å¯é©—è­‰ï¼ˆä¾è¦å‰‡ï¼šç¦æ­¢é«˜é¢¨éšªä½œæ¥­ï¼‰"}`,
          `ç‹€æ…‹ç¢¼ï¼š${h.status ?? "ï¼ˆç„¡ï¼‰"}`,
          `Content-Typeï¼š${h.content_type ?? "ï¼ˆç„¡ï¼‰"}`,
          `å›æ‡‰æ‘˜è¦ï¼š${(h.body_preview || "").trim() || "ï¼ˆç„¡ï¼‰"}`
        ].join("\n");
      }

      function summarizeDnsStatus(data) {
        const s = data?.status;
        if (!s) return null;
        const ready = s.ready_to_issue === true;
        const mismatches = s.mismatches || [];
        const resolvers = s.resolvers || [];
        return [
          "ã€DNS å‚³æ’­ï¼ˆ_acme-challengeï¼‰ã€‘",
          `åˆ¤å®šï¼š${ready ? "READYï¼ˆå¯ç°½ç™¼ï¼‰" : "NOT READYï¼ˆå…ˆä¸è¦ç°½ç™¼ï¼‰"}`,
          `Resolverï¼š${fmtList(resolvers)}`,
          mismatches.length ? `ç¼ºå£/ä¸ä¸€è‡´ï¼š\n- ${mismatches.join("\n- ")}` : "ç¼ºå£/ä¸ä¸€è‡´ï¼šç„¡",
          s.note ? `å‚™è¨»ï¼š${s.note}` : ""
        ].filter(Boolean).join("\n");
      }

      function summarizeExpectedDns(data) {
        const exp = data?.expected;
        if (!exp || !Array.isArray(exp.records)) return null;
        const by = {};
        for (const r of exp.records) by[r.qname] = (r.expected_values || []).join(" | ");
        return [
          "ã€DNS é æœŸå€¼ï¼ˆä¾†è‡ª dns_records.jsonï¼‰ã€‘",
          `_acme-challengeï¼š${by["_acme-challenge.wuchang.life"] || "ï¼ˆç„¡ï¼‰"}`,
          `_acme-challenge.wwwï¼š${by["_acme-challenge.www.wuchang.life"] || "ï¼ˆç„¡ï¼‰"}`
        ].join("\n");
      }

      function summarizeNetSnapshot(data) {
        if (data?.note !== "network_snapshot" || !data?.snapshot) return null;
        const snap = data.snapshot;
        const gw = snap?.default_gateway_ipv4 || "ï¼ˆæœªåµæ¸¬åˆ°ï¼‰";
        const matches = snap?.hosts_overrides?.matches || [];
        const hostPath = snap?.hosts_overrides?.path || "ï¼ˆæœªçŸ¥ï¼‰";
        const dnsSocket = (snap?.dns?.socket || []).filter(x => x && x.domain);
        const dnsOk = dnsSocket.filter(x => x.ok).map(x => `${x.domain} -> ${fmtList(x.addrs)}`);
        const dnsBad = dnsSocket.filter(x => !x.ok).map(x => `${x.domain}ï¼ˆå¤±æ•—ï¼š${x.error || "æœªçŸ¥"}ï¼‰`);
        const hc = snap?.server_health?.result;
        const hcLine = hc ? (hc.ok ? "ä¼ºæœå™¨å¥åº·ï¼šOKï¼ˆå¯é”ï¼‰" : "ä¼ºæœå™¨å¥åº·ï¼šç„¡å›æ‡‰/ä¸å¯é©—è­‰") : "ä¼ºæœå™¨å¥åº·ï¼šæœªæª¢æŸ¥ï¼ˆæœªå¡« health URLï¼‰";
        const saveLine = data.saved_path ? `å¿«ç…§å·²å­˜æª”ï¼š${data.saved_path}` : "å¿«ç…§æœªå­˜æª”";
        return [
          "ã€ç¶²è·¯å¿«ç…§ï¼ˆæœ¬æ©Ÿ/è·¯ç”±å™¨/DNSï¼‰ã€‘",
          saveLine,
          `é è¨­é–˜é“ï¼ˆå¤šåŠæ˜¯è·¯ç”±å™¨ LANï¼‰ï¼š${gw}`,
          hcLine,
          `hosts æª”ï¼š${hostPath}`,
          matches.length ? `hosts è¦†å¯«å‘½ä¸­ï¼š${matches.map(m => `${m.domain} -> ${m.ip}`).join("ï¼› ")}` : "hosts è¦†å¯«å‘½ä¸­ï¼šç„¡",
          dnsOk.length ? `DNSï¼ˆsocketï¼‰æˆåŠŸï¼š\n- ${dnsOk.join("\n- ")}` : "DNSï¼ˆsocketï¼‰æˆåŠŸï¼šç„¡",
          dnsBad.length ? `DNSï¼ˆsocketï¼‰å¤±æ•—ï¼š\n- ${dnsBad.join("\n- ")}` : "DNSï¼ˆsocketï¼‰å¤±æ•—ï¼šç„¡"
        ].join("\n");
      }

      function summarizeToolRun(data) {
        if (!data?.run || typeof data.run !== "object" || !("exit_code" in data.run)) return null;
        const ec = data.run.exit_code;
        const out = (data.run.stdout || "").trim();
        const err = (data.run.stderr || "").trim();
        return [
          "ã€å·¥å…·åŸ·è¡Œçµæœã€‘",
          `Exit codeï¼š${ec}`,
          err ? `éŒ¯èª¤ï¼š${err}` : "éŒ¯èª¤ï¼šç„¡",
          out ? `è¼¸å‡ºï¼š\n${out}` : "è¼¸å‡ºï¼šç„¡"
        ].join("\n");
      }

      const summary =
        summarizeServerHealth(obj) ||
        summarizeDnsStatus(obj) ||
        summarizeExpectedDns(obj) ||
        summarizeNetSnapshot(obj) ||
        summarizeToolRun(obj);

      const raw = JSON.stringify(obj, null, 2);
      $("runLog").textContent = summary ? (showRaw ? (summary + "\n\n---\nã€åŸå§‹ JSONã€‘\n" + raw) : summary) : raw;
    }

    function authSessionId() {
      try { return localStorage.getItem("wuchang_session_id") || ""; } catch (e) { return ""; }
    }

    function setAuthSessionId(v) {
      try {
        if (!v) localStorage.removeItem("wuchang_session_id");
        else localStorage.setItem("wuchang_session_id", v);
      } catch (e) {}
    }

    window.__auth = { accounts_enabled: false, session: null, policy_path: "" };

    async function authRefresh() {
      const { data } = await fetchJson("/api/auth/status");
      window.__auth = data || window.__auth;
      const enabled = data?.accounts_enabled === true;
      const sess = data?.session && Object.keys(data.session).length ? data.session : null;
      const sid = authSessionId();

      $("authStatus").value = enabled
        ? (sess ? `å·²ç™»å…¥ï¼š${sess.account_id || ""}ï¼ˆ${sess.label || ""}ï¼‰` : "æœªç™»å…¥ï¼ˆå·²å•Ÿç”¨å¸³è™Ÿæ”¿ç­–ï¼‰")
        : "æœªå•Ÿç”¨å¸³è™Ÿæ”¿ç­–ï¼ˆå–®æ©Ÿæ¨¡å¼ï¼‰";

      if (enabled) {
        $("authHint").textContent = `å¸³è™Ÿæ”¿ç­–æª”ï¼š${data?.policy_path || "ï¼ˆæœªæ‰¾åˆ°ï¼‰"}ï¼ˆå»ºè­°æ”¾åœ¨ Google Drive åŒæ­¥è³‡æ–™å¤¾ï¼‰`;
        if (!sid || !sess) {
          // æœªç™»å…¥ï¼šå¼·åˆ¶æœ€ä½å¯è¦‹
          $("uiProfile").value = "public_readonly";
          $("uiProfile").disabled = true;
          try { uiApplyProfile(); } catch (e) {}
        } else {
          // å·²ç™»å…¥ï¼šå¥—ç”¨å¸³è™Ÿç¶å®š profile
          const pid = sess.profile_id || "ops_admin";
          $("uiProfile").value = pid;
          $("uiProfile").disabled = true;
          try { uiApplyProfile(); } catch (e) {}
        }
      } else {
        $("authHint").textContent = "å°šæœªå»ºç«‹ accounts_policy.jsonï¼šä½ å¯ä»¥ç”¨ç¯„ä¾‹æª”å»ºç«‹ï¼ˆæ¯å€‹å¸³è™Ÿç”¨è™Ÿç¢¼æ±ºå®šæ¬Šé™ï¼‰ã€‚";
        $("uiProfile").disabled = false;
      }

      // é¡¯ç¤ºæ¬Šé™æ‘˜è¦ï¼ˆä¸å«æ•æ„Ÿï¼‰
      const perms = (sess?.permissions || []);
      if (enabled && sess) {
        $("uiProfilePolicy").value = `perms=${perms.slice(0, 8).join(",")}${perms.length > 8 ? "â€¦" : ""}`;
      }
      logRun(data);
    }

    async function authLogin() {
      const account_id = ($("accountId").value || "").trim();
      const pin = ($("accountPin").value || "").trim();
      const { data } = await fetchJson("/api/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ account_id, pin })
      });
      if (data?.ok && data?.session_id) {
        setAuthSessionId(data.session_id);
        $("accountPin").value = "";
        await uiLoadProfiles().catch(() => {});
        await authRefresh();
        await consentRefresh().catch(() => {});
        await jobRefresh().catch(() => {});
      } else {
        logRun(data);
      }
    }

    async function authLogout() {
      const sid = authSessionId();
      if (sid) {
        await fetchJson("/api/auth/logout", { method: "POST" }).catch(() => {});
      }
      setAuthSessionId("");
      await authRefresh();
      try { nonidSetEnabled(false); } catch (e) {}
    }

    // ===== Consentï¼ˆåŒæ„ï¼‰ï¼šå‘ŠçŸ¥ç¯„åœ/ç”¨é€”å¾Œæ‰å¯ä½¿ç”¨ =====
    window.__consent = { effective: false, policy: null, scope: "" };

    function nonidSetEnabled(enabled) {
      const ids = ["btnNonidLoad", "btnNonidSave", "btnNonidClear", "nonidGender", "nonidAgeBand", "nonidHabits"];
      for (const id of ids) {
        const el = $(id);
        if (el) el.disabled = !enabled;
      }
    }

    async function consentRefresh() {
      const { data: pol } = await fetchJson("/api/consent/policy").catch(() => ({ data: null }));
      const { data } = await fetchJson("/api/consent/status");
      if (!data?.ok) {
        $("consentStatus").value = "æœªç™»å…¥/ç„¡æ¬Šé™";
        $("consentRetention").value = "";
        $("consentHint").textContent = "è«‹å…ˆç™»å…¥å¸³è™Ÿè™Ÿç¢¼ï¼Œæ‰èƒ½æª¢è¦–/è¨­å®šåŒæ„ã€‚";
        $("consentPolicyText").textContent = "ï¼ˆéœ€ç™»å…¥å¾Œæ‰å¯è¼‰å…¥åŒæ„æ¢æ¬¾ï¼‰";
        nonidSetEnabled(false);
        logRun(data);
        return;
      }
      window.__consent.policy = pol?.policy || null;
      window.__consent.effective = data.effective === true;
      window.__consent.scope = data.scope || "";
      $("consentStatus").value = data.effective ? "å·²åŒæ„ï¼ˆæœ‰æ•ˆï¼‰" : (data?.consent?.revoked_at ? "å·²æ’¤å›" : "æœªåŒæ„/æœªç”Ÿæ•ˆ");
      $("consentRetention").value = String((pol?.policy?.retention_days ?? "") || "");
      const p = pol?.policy || {};
      const lines = [];
      lines.push(`ã€åŒæ„æ¢æ¬¾ã€‘v${p.policy_version ?? "?"}`);
      lines.push(`- ç¯„åœï¼ˆscopeï¼‰ï¼š${p.scope || ""}`);
      lines.push(`- ç”¨é€”ï¼ˆpurposesï¼‰ï¼š${(p.purposes || []).join("ã€") || "ï¼ˆç„¡ï¼‰"}`);
      lines.push(`- ä½¿ç”¨è³‡æ–™æ¬„ä½ï¼š${(p.data_fields || []).join("ã€") || "ï¼ˆç„¡ï¼‰"}`);
      lines.push(`- æ˜ç¢ºä¸æ”¶é›†ï¼š${(p.not_collect || []).join("ã€") || "ï¼ˆç„¡ï¼‰"}`);
      lines.push(`- ä¿å­˜æœŸé™ï¼š${p.retention_days ?? "?"} å¤©`);
      lines.push(`- ä¿å­˜ä½ç½®ï¼š${p.storage || ""}`);
      lines.push(`- å°å¤–åˆ†äº«ï¼š${p.sharing || ""}`);
      lines.push("");
      lines.push("ã€ä½¿ç”¨æ¬Šåˆ© / ä½¿ç”¨è€…æ¬Šåˆ©ã€‘");
      for (const r of (p.rights || [])) lines.push(`- ${r}`);
      $("consentPolicyText").textContent = lines.join("\n");

      $("consentHint").textContent = `ç¯„åœï¼š${data.scope || ""}ï½œç”¨é€”ï¼š${(p.purposes || []).join("ã€") || "ï¼ˆç„¡ï¼‰"}ï½œä¿å­˜ï¼š${p.retention_days ?? "?"} å¤©ï½œå¯éš¨æ™‚æ’¤å›`;
      nonidSetEnabled(window.__consent.effective);
      logRun({ consent: data, policy: pol?.policy || {} });
    }

    async function consentGrant() {
      if ($("consentAck")?.checked !== true) {
        $("consentHint").textContent = "è«‹å…ˆå‹¾é¸ã€Œæˆ‘å·²é–±è®€ä¸¦åŒæ„ã€æ‰å¯å•Ÿç”¨ã€‚";
        return;
      }
      const { data } = await fetchJson("/api/consent/grant", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ scope: "account_non_identifiable_profile", ack: true, source: "ui" })
      });
      if (!data?.ok) {
        $("consentHint").textContent = "åŒæ„å¤±æ•—ï¼ˆè«‹ç¢ºèªå·²ç™»å…¥/å·²è¨­å®š Workspaceï¼‰ã€‚";
        logRun(data);
        return;
      }
      $("consentHint").textContent = "å·²åŒæ„ä¸¦å•Ÿç”¨ä¸å¯è­˜åˆ¥å€‹è³‡åŠŸèƒ½ã€‚";
      await consentRefresh();
    }

    async function consentRevoke() {
      const { data } = await fetchJson("/api/consent/revoke", { method: "POST" });
      if (!data?.ok) {
        $("consentHint").textContent = "æ’¤å›å¤±æ•—ï¼ˆè«‹ç¢ºèªå·²ç™»å…¥/å·²è¨­å®š Workspaceï¼‰ã€‚";
        logRun(data);
        return;
      }
      $("consentHint").textContent = "å·²æ’¤å›åŒæ„ï¼ˆä¸å¯è­˜åˆ¥å€‹è³‡åŠŸèƒ½å·²åœç”¨ï¼‰ã€‚";
      await consentRefresh();
    }

    async function nonidLoad() {
      const { data } = await fetchJson("/api/profile/nonid/get");
      if (!data?.ok) {
        if (data?.error === "consent_required") {
          $("nonidHint").textContent = "ç„¡æ³•è¼‰å…¥ï¼šå¿…é ˆå…ˆå®ŒæˆåŒæ„ï¼ˆå‘ŠçŸ¥ç”¨é€”/ç¯„åœå¾ŒåŒæ„ï¼‰ã€‚";
          nonidSetEnabled(false);
          await consentRefresh().catch(() => {});
        } else {
          $("nonidHint").textContent = (data?.error === "forbidden") ? "ç„¡æ³•è¼‰å…¥ï¼šè«‹å…ˆç™»å…¥ä¸”éœ€æ¬Šé™ã€‚" : "ç„¡æ³•è¼‰å…¥ï¼šè«‹å…ˆè¨­å®š Workspace åŒæ­¥è·¯å¾‘ã€‚";
        }
        logRun(data);
        return;
      }
      const p = data.profile || {};
      $("nonidGender").value = p.gender || "";
      $("nonidAgeBand").value = p.age_band || "";
      $("nonidHabits").value = p.habits || "";
      $("nonidHint").textContent = `å·²è¼‰å…¥ï¼ˆaccount_id=${data.account_id || ""}ï½œvault: ${data.vault_path || ""}ï¼‰`;
      logRun(data);
    }

    async function nonidSave(clear = false) {
      const actor = ($("actor").value || "ops").trim();
      const profile = clear ? null : {
        gender: ($("nonidGender").value || "").trim(),
        age_band: ($("nonidAgeBand").value || "").trim(),
        habits: ($("nonidHabits").value || "").trim(),
      };
      const { data } = await fetchJson("/api/profile/nonid/set", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ actor, profile })
      });
      if (data?.ok) {
        if (clear) {
          $("nonidGender").value = "";
          $("nonidAgeBand").value = "";
          $("nonidHabits").value = "";
          $("nonidHint").textContent = "å·²æ¸…é™¤";
        } else {
          $("nonidHint").textContent = "å·²å„²å­˜ï¼ˆä¸å¯è­˜åˆ¥å€‹è³‡ï¼‰";
        }
      } else {
        if (data?.error === "consent_required") {
          $("nonidHint").textContent = "ç„¡æ³•å„²å­˜ï¼šå¿…é ˆå…ˆå®ŒæˆåŒæ„ï¼ˆå‘ŠçŸ¥ç”¨é€”/ç¯„åœå¾ŒåŒæ„ï¼‰ã€‚";
          nonidSetEnabled(false);
          await consentRefresh().catch(() => {});
        } else {
          $("nonidHint").textContent = (data?.error === "forbidden") ? "ç„¡æ³•å„²å­˜ï¼šè«‹å…ˆç™»å…¥ä¸”éœ€æ¬Šé™ã€‚" : "å„²å­˜å¤±æ•—";
        }
      }
      logRun(data);
    }

    async function fetchJson(url, opts) {
      const o = opts ? { ...opts } : {};
      const headers = { ...(o.headers || {}) };
      const sid = authSessionId();
      if (sid) headers["X-Wuchang-Session"] = sid;
      o.headers = headers;
      const res = await fetch(url, o);
      const data = await res.json();
      return { res, data };
    }

    async function init() {
      try {
        await uiLoadProfiles();
      } catch (e) {}
      try {
        await authRefresh();
      } catch (e) {}
      try {
        await consentRefresh();
      } catch (e) {}
      try {
        const { data } = await fetchJson("/api/local/health");
        const txt = data?.ok ? "OK" : (data?.error === "forbidden" ? "éœ€ç™»å…¥" : "å¤±æ•—");
        setPill($("localStatus"), data?.ok ? "ok" : "bad", txt);
      } catch (e) {
        setPill($("localStatus"), "bad", "å¤±æ•—");
      }
      // init central map module
      try {
        $("ccViewMode").addEventListener("change", () => ccRenderAll());
        $("ccBtnUp").addEventListener("click", () => ccGoUp());
        $("ccBtnDown").addEventListener("click", () => ccGoDown());
        $("ccBtnReset").addEventListener("click", () => { ccCurrentRoot = "platform"; ccSelect("platform"); });
        $("ccBtnApplyStatus").addEventListener("click", () => ccApplyStatus());
        $("ccBtnRefreshHint").addEventListener("click", () => ccShowHint());
        $("ccBtnAgentSuggest").addEventListener("click", () => ccAgentSuggest());
        $("ccBtnAgentDaily").addEventListener("click", () => ccAgentDaily());
        $("ccBtnWriteWorkspace").addEventListener("click", () => ccWriteWorkspace().catch(e => logRun(String(e))));
        ccSelect("platform");
      } catch (e) {
        // ignore
      }
      await loadAudit();
      try { await verifyRefresh(); } catch (e) {}
      try {
        ljInit();
      } catch (e) {}
      try {
        await jobRefresh();
      } catch (e) {}
      try { uiApplyProfile(); } catch (e) {}
      try { await maintenanceRefresh(); } catch (e) {}
      try { await designModeRefresh(); } catch (e) {}
      try {
        loadPersonalBindingStatus();
      } catch (e) {}
    }

    // è‡ªå‹•è¼ªè©¢ï¼šç¨‹åºé©—è­‰ï¼ˆä¸ä¾è³´èªè¨€æ¨¡å‹ï¼‰
    setInterval(() => {
      try {
        if ($("verifyAuto")?.checked === true) verifyRefresh().catch(() => {});
      } catch (e) {}
    }, 15000);

    // è‡ªå‹•è¼ªè©¢ï¼šè¨­è¨ˆæ³•äººå®šæœŸç¶­è­·å±•å»¶ç‹€æ…‹ï¼ˆå…¨ UI å·¦ä¸‹è§’æç¤ºï¼‰
    setInterval(() => {
      try { maintenanceRefresh().catch(() => {}); } catch (e) {}
    }, 60000);

    // è‡ªå‹•è¼ªè©¢ï¼šè¨­è¨ˆå•Ÿç”¨ç‹€æ…‹ï¼ˆé¿å…èª¤åˆ¤ï¼‰
    setInterval(() => {
      try { designModeRefresh().catch(() => {}); } catch (e) {}
    }, 15000);

    async function designModeRefresh() {
      const pill = $("designModePill");
      const hint = $("designModeHint");
      const box = $("designModeRecord");
      if (!pill || !hint) return;
      try {
        const { data } = await fetchJson("/api/design_mode/status");
        const dm = data?.design_mode || {};
        const active = dm?.active === true;
        pill.className = `pill ${active ? "ok" : "warn"}`;
        pill.textContent = active ? "å·²å•Ÿç”¨" : "æœªå•Ÿç”¨";
        const until = dm?.enabled_until_epoch ? `ï½œåˆ°æœŸï¼š${new Date((dm.enabled_until_epoch || 0) * 1000).toLocaleString()}` : "";
        hint.textContent = (dm?.path ? `state: ${dm.path}` : "") + (dm?.reason ? `ï½œåŸå› ï¼š${dm.reason}` : "") + until;
        if (box && !box.value) box.value = "ï¼ˆå°šæœªç”¢ç”Ÿè³‡è¨Šç´€éŒ„ï¼‰";
      } catch (e) {
        pill.className = "pill bad";
        pill.textContent = "è®€å–å¤±æ•—";
        hint.textContent = "ç„¡æ³•å–å¾—è¨­è¨ˆå•Ÿç”¨ç‹€æ…‹ï¼ˆè«‹å…ˆç™»å…¥æˆ–æŸ¥çœ‹å³æ™‚è¼¸å‡ºï¼‰ã€‚";
        if (box) box.value = "ï¼ˆç„¡æ³•è®€å–ç‹€æ…‹ï¼‰";
      }
    }

    async function designModeSet(enabled) {
      const actor = ($("actor")?.value || "ops").trim();
      const ttl_seconds = parseInt(($("designModeTtl")?.value || "1200").trim(), 10) || 1200;
      const reason = ($("designModeReason")?.value || "").trim();
      const { data } = await fetchJson("/api/design_mode/set", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ enabled: !!enabled, ttl_seconds, reason, actor })
      });
      logRun(data);
      try {
        const r = data?.record_written;
        const box = $("designModeRecord");
        if (box && r) box.value = JSON.stringify(r, null, 2);
      } catch (e) {}
      await designModeRefresh().catch(() => {});
    }

    async function designModeRecord() {
      const actor = ($("actor")?.value || "ops").trim();
      const reason = ($("designModeReason")?.value || "").trim();
      const { data } = await fetchJson("/api/design_mode/record", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ actor, reason, kind: "design_mode_record_manual" })
      });
      logRun(data);
      try {
        const r = data?.record_written;
        const box = $("designModeRecord");
        if (box && r) box.value = JSON.stringify(r, null, 2);
      } catch (e) {}
      await designModeRefresh().catch(() => {});
    }

    async function maintenanceRefresh() {
      const el = $("maintBanner");
      if (!el) return;
      try {
        const { data } = await fetchJson("/api/maintenance/status");
        const st = data?.status || {};
        if (st?.verified === true && st?.ok === true) {
          el.classList.add("hidden");
          el.classList.remove("warn");
          el.textContent = "";
          return;
        }
        const msg = (st?.message || "ï¼ˆæœ¬ç³»çµ±æœªç¶“åŸè¨­è¨ˆè€…åšå®šæœŸç¶­è­·ï¼Œå¯èƒ½å­˜åœ¨é¢¨éšªï¼‰\nï¼ˆæ­¤æ™‚æ‰€æœ‰é¢¨éšªå…¨æ­¸ä½¿ç”¨è€…ç«¯é»ï¼‰");
        const parts = String(msg).split("\n").filter(Boolean);
        const html = parts.map(p => `<div>${escapeHtml(p)}</div>`).join("") +
          (st?.reason ? `<div class="small">åŸå› ï¼š${escapeHtml(String(st.reason))}</div>` : "") +
          (st?.risk_owner ? `<div class="small">è²¬ä»»æ­¸å±¬ï¼š${escapeHtml(String(st.risk_owner))}</div>` : "");
        const sig = JSON.stringify({ level: st?.level, verified: st?.verified, reason: st?.reason, msg });
        if (window.__maintLastSig !== sig) {
          el.innerHTML = html;
          window.__maintLastSig = sig;
        }
        el.classList.remove("hidden");
        el.classList.toggle("warn", (st?.level || "warn") === "warn");
      } catch (e) {
        // ç„¡æ³•ç¢ºèªç‹€æ…‹æ™‚ä¹Ÿè¦æç¤ºï¼ˆç¬¦åˆã€Œä¸å¯é©—è­‰å³é«˜é¢¨éšªã€ç²¾ç¥ï¼‰
        el.classList.remove("hidden");
        el.classList.add("warn");
        el.innerHTML = `<div>ï¼ˆæœ¬ç³»çµ±æœªç¶“åŸè¨­è¨ˆè€…åšå®šæœŸç¶­è­·ï¼Œå¯èƒ½å­˜åœ¨é¢¨éšªï¼‰</div><div>ï¼ˆæ­¤æ™‚æ‰€æœ‰é¢¨éšªå…¨æ­¸ä½¿ç”¨è€…ç«¯é»ï¼‰</div><div class="small">åŸå› ï¼šç„¡æ³•å–å¾—ç¶­è­·ç‹€æ…‹</div>`;
      }
    }

    async function checkServer() {
      const url = ($("healthUrl").value || "").trim();
      if (!url) {
        setPill($("serverStatus"), "unk", "æœªå¡« URL");
        logRun("ä¼ºæœå™¨å¥åº·æª¢æŸ¥ï¼šè«‹å…ˆå¡«å…¥ health URLï¼ˆæˆ–æ”¹ç”¨ç’°å¢ƒè®Šæ•¸ WUCHANG_HEALTH_URLï¼‰ã€‚");
        return;
      }
      const { data } = await fetchJson("/api/server/health?url=" + encodeURIComponent(url));
      const ok = data?.health?.ok === true;
      setPill($("serverStatus"), ok ? "ok" : "bad", ok ? "OK" : "ç„¡å›æ‡‰/ä¸å¯é©—è­‰");
      logRun(data);
    }

    async function checkDNS() {
      setPill($("dnsStatus"), "unk", "æª¢æŸ¥ä¸­â€¦");
      // æ”¹æˆæ‹¿çµæ§‹åŒ–çµæœï¼ˆUI é¡¯ç¤ºç”¨ï¼‰
      const { data } = await fetchJson("/api/dns/acme_status?domain=" + encodeURIComponent("wuchang.life"));
      const ok = data?.status?.ready_to_issue === true;
      setPill($("dnsStatus"), ok ? "ok" : "bad", ok ? "READY" : "NOT READY");
      logRun(data);
    }

    async function loadExpectedDNS() {
      const { data } = await fetchJson("/api/dns/expected?domain=" + encodeURIComponent("wuchang.life"));
      const recs = data?.expected?.records || [];
      const byName = {};
      for (const r of recs) byName[r.qname] = (r.expected_values || []).join(" | ");
      $("expectedAcmeRoot").value = byName["_acme-challenge.wuchang.life"] || "";
      $("expectedAcmeWww").value = byName["_acme-challenge.www.wuchang.life"] || "";
      logRun(data);
    }

    async function checkDNS2() {
      await checkDNS();
    }

    async function copyText(value) {
      try {
        await navigator.clipboard.writeText(value);
        return true;
      } catch (e) {
        return false;
      }
    }

    async function runPush(profile) {
      const health_url = ($("healthUrl").value || "").trim();
      const copy_to = ($("copyTo").value || "").trim();
      const actor = ($("actor").value || "ops").trim();

      // ä¸å¼·è¿«å¡«ï¼Œä½†æœƒæç¤ºï¼šä¸å¡«é€šå¸¸æ¨é€æœƒè¢«å·¥å…·æ“‹ä¸‹ï¼ˆç¬¦åˆè¦å‰‡ï¼‰
      if (!health_url || !copy_to) {
        logRun("æé†’ï¼šä½ æœªå¡« health URL æˆ– copy-toã€‚ä¾è¦å‰‡ï¼Œæ¨é€æ‡‰è©²è¢«é˜»æ“‹ä¸¦å¯«å…¥ç¨½æ ¸ï¼ˆé€™æ˜¯é æœŸè¡Œç‚ºï¼‰ã€‚");
      }

      const { data } = await fetchJson("/api/run/sync_push", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ profile, health_url, copy_to, actor })
      });
      logRun(data);
      await loadAudit();
    }

    async function loadAudit() {
      const { data } = await fetchJson("/api/audit/tail?file=" + encodeURIComponent("risk_action_audit.jsonl") + "&limit=50");
      const items = data?.items || [];
      if (!items.length) {
        setPill($("auditStatus"), "unk", "ç„¡ç´€éŒ„/å°šæœªç”¢ç”Ÿ");
        $("auditLog").textContent = "ï¼ˆç›®å‰æ²’æœ‰ç¨½æ ¸ç´€éŒ„ï¼‰";
        return;
      }
      setPill($("auditStatus"), "ok", "å·²è¼‰å…¥");
      const showRaw = $("showRawAudit")?.checked === true;
      if (showRaw) {
        $("auditLog").textContent = items.map((x) => JSON.stringify(x)).join("\n");
        return;
      }
      const lines = items.map((x) => {
        const ts = x.timestamp || x.time || "ï¼ˆç„¡æ™‚é–“ï¼‰";
        const kind = x.kind || x.action_type || "ï¼ˆæœªçŸ¥ï¼‰";
        const actor = x.actor || "ï¼ˆæœªçŸ¥æ“ä½œè€…ï¼‰";
        const result = x.result || x.status || "ï¼ˆç„¡çµæœï¼‰";
        const health = x?.evidence?.status ? `http=${x.evidence.status}` : "";
        return `- ${ts}ï½œ${kind}ï½œæ“ä½œè€…=${actor}ï½œçµæœ=${result}${health ? "ï½œ" + health : ""}`;
      });
      $("auditLog").textContent = "ã€ç¨½æ ¸æ‘˜è¦ï¼ˆæœ€æ–°åœ¨ä¸‹æ–¹ï¼‰ã€‘\n" + lines.join("\n");
    }

    async function verifyRefresh() {
      try {
        const { data } = await fetchJson("/api/verify/status?hub=1");
        window.__verifyLast = data || null;
        const st = data?.status || "unk";
        if (st === "bad") setPill($("verifyStatus"), "bad", "ç•°å¸¸");
        else if (st === "warn") setPill($("verifyStatus"), "warn", "è­¦å‘Š");
        else setPill($("verifyStatus"), "ok", "OK");

        const alerts = data?.alerts || [];
        if (!alerts.length) {
          $("verifyLog").textContent = "ã€ç¨‹åºé©—è­‰ã€‘OKï¼šç›®å‰æœªåµæ¸¬åˆ°æœªå®Œæˆ/å¡ä½é …ç›®ã€‚";
          return;
        }
        const lines = alerts.slice(0, 80).map(a => {
          const lv = a.level || "warn";
          const code = a.code || "unknown";
          const jid = a.job_id ? `ï½œjob=${a.job_id}` : "";
          const t = (typeof a.age_seconds === "number") ? `ï½œage=${a.age_seconds}s` : "";
          return `- [${lv}] ${code}${jid}${t}ï½œ${a.message || ""}`;
        });
        $("verifyLog").textContent = "ã€ç¨‹åºé©—è­‰ï¼šå‘Šè­¦æ¸…å–®ã€‘\n" + lines.join("\n");
      } catch (e) {
        setPill($("verifyStatus"), "bad", "å¤±æ•—");
        $("verifyLog").textContent = "ã€ç¨‹åºé©—è­‰ã€‘å¤±æ•—ï¼š" + String(e);
      }
    }

    function buildInvestigationReport(v) {
      const ts = v?.timestamp || new Date().toISOString();
      const st = v?.status || "unk";
      const counts = v?.counts || {};
      const alerts = v?.alerts || [];
      const hub = v?.hub || {};
      const hubOk = hub?.health?.ok === true;
      const hubConfigured = hub?.configured === true;

      const lines = [];
      lines.push("ã€èª¿æŸ¥å ±å‘Šï½œå°J ç¨‹åºé©—è­‰ï¼ˆéèªè¨€ï¼‰ã€‘");
      lines.push(`æ™‚é–“ï¼š${ts}`);
      lines.push(`ç‹€æ…‹ï¼š${st}ï½œå‘Šè­¦æ•¸=${counts.alerts ?? alerts.length ?? 0}ï½œoutbox=${counts.local_outbox ?? "?"}ï½œsent=${counts.local_sent ?? "?"}`);
      lines.push(`Hubï¼š${hubConfigured ? "å·²è¨­å®š" : "æœªè¨­å®š"}ï½œhealth=${hubOk ? "OK" : "ç„¡å›æ‡‰/ä¸å¯é©—è­‰"}`);
      lines.push("");
      lines.push("ã€å‘Šè­¦ï¼ˆå‰ 12 ç­†ï¼‰ã€‘");
      if (!alerts.length) {
        lines.push("- ï¼ˆç„¡å‘Šè­¦ï¼‰");
      } else {
        for (const a of alerts.slice(0, 12)) {
          const lv = a.level || "warn";
          const code = a.code || "unknown";
          const jid = a.job_id ? ` job=${a.job_id}` : "";
          const jt = a.type ? ` type=${a.type}` : "";
          const age = (typeof a.age_seconds === "number") ? ` age=${a.age_seconds}s` : "";
          lines.push(`- [${lv}] ${code}${jid}${jt}${age}ï½œ${a.message || ""}`);
        }
      }
      lines.push("");
      lines.push("ã€æé†’å°Jï¼ˆå¯è²¼å›å»ï¼‰ã€‘");
      lines.push("ä½ å…ˆå‰å›è¦†å¯èƒ½å‡ºç¾ã€å·²å®Œæˆã€ä½†ç¨‹åºé©—è­‰é¡¯ç¤ºã€è­‰æ“šä¸è¶³/æœªæ­¸æª”/Hub æœªå›æ‡‰ã€ã€‚");
      lines.push("è«‹ä¾å‘Šè­¦ä»£ç¢¼é€ä¸€è£œè­‰æ“šæˆ–æ‰¿èªæœªå®Œæˆä¸¦æå‡ºä¸‹ä¸€æ­¥ã€‚");
      lines.push("ï¼ˆå¼·åˆ¶è¦å‰‡ï¼šç„¡å›æ‡‰ï¼ç¦æ­¢é«˜é¢¨éšªä½œæ¥­ï¼‰");
      return lines.join("\n");
    }

    async function verifyCopyReport() {
      const v = window.__verifyLast || null;
      if (!v) { logRun("å°šæœªæœ‰ç¨‹åºé©—è­‰çµæœå¯è¤‡è£½ï¼Œè«‹å…ˆæŒ‰ã€Œç«‹å³é©—è­‰ã€ã€‚"); return; }
      const text = buildInvestigationReport(v);
      const ok = await copyText(text);
      logRun(ok ? "å·²è¤‡è£½èª¿æŸ¥å ±å‘Šï¼ˆå¯è²¼å›å°Jæˆ–å¤–éƒ¨å®˜æ–¹ AIï¼‰ã€‚" : "è¤‡è£½å¤±æ•—ï¼ˆç€è¦½å™¨æ¬Šé™é™åˆ¶ï¼‰ã€‚");
    }

    async function verifySendToLittleJ() {
      const v = window.__verifyLast || null;
      if (!v) { logRun("å°šæœªæœ‰ç¨‹åºé©—è­‰çµæœå¯é€å‡ºï¼Œè«‹å…ˆæŒ‰ã€Œç«‹å³é©—è­‰ã€ã€‚"); return; }
      const text = buildInvestigationReport(v);
      // é€åˆ°å°J æŒ‡ä»¤çª—å£ä¸¦é€å‡º
      try { $("ljInput").value = text; } catch (e) {}
      try { await ljSend(text); } catch (e) { logRun(String(e)); }
    }

    async function loadDoc() {
      const name = $("docName").value;
      const { data } = await fetchJson("/api/docs?name=" + encodeURIComponent(name));
      $("docText").value = data?.text || "";
    }

    async function netSnapshot() {
      const health_url = ($("healthUrl").value || "").trim();
      const url = "/api/net/snapshot?save=1" + (health_url ? ("&health_url=" + encodeURIComponent(health_url)) : "");
      const { data } = await fetchJson(url);
      // åŒæ­¥æ›´æ–°ç‹€æ…‹ pillï¼šè‹¥æœ‰ health_urlï¼Œä¸¦ä¸” health ok å‰‡ OKï¼›å¦å‰‡ç¶­æŒæœªçŸ¥ä½†æŠŠå¿«ç…§å°å‡ºä¾†
      try {
        const snap = JSON.parse(data?.run?.stdout || "{}");
        const gw = snap?.default_gateway_ipv4;
        const hostOverrides = (snap?.hosts_overrides?.matches || []).length;
        const hcOk = snap?.server_health?.result?.ok === true;
        if (health_url) setPill($("serverStatus"), hcOk ? "ok" : "bad", hcOk ? "OK" : "ç„¡å›æ‡‰/ä¸å¯é©—è­‰");
        logRun({
          ok: true,
          note: "network_snapshot",
          saved_path: data?.saved_path || "",
          default_gateway_ipv4: gw || null,
          hosts_overrides_matches: hostOverrides,
          snapshot: snap
        });
      } catch (e) {
        logRun(data);
      }
    }

    async function hubFetchServerArchitecture() {
      try {
        if ($("serverArchHint")) $("serverArchHint").textContent = "ç´¢å–ä¸­â€¦";
        const { data } = await fetchJson("/api/hub/server_architecture");
        // æœ¬æ©Ÿç«¯å›å‚³æ ¼å¼ï¼š{ ok: true, hub: { ok, status, data/raw } }
        const hub = data?.hub || {};
        const payload = (hub && typeof hub === "object" && ("data" in hub)) ? hub.data : data;
        if ($("serverArchText")) $("serverArchText").value = JSON.stringify(payload, null, 2);
        if ($("serverArchHint")) {
          if (payload?.error === "forbidden") $("serverArchHint").textContent = "ç„¡æ³•ç´¢å–ï¼šæœªç™»å…¥æˆ–ç„¡æ¬Šé™ã€‚";
          else if (hub?.ok === true) $("serverArchHint").textContent = "å·²å–å¾—ä¼ºæœå™¨ç³»çµ±æ¶æ§‹å›å ±ï¼ˆHubï¼‰ã€‚";
          else $("serverArchHint").textContent = "ç´¢å–å¤±æ•—ï¼šè«‹ç¢ºèª Hub å·²å•Ÿå‹•ã€ä¸”æœ¬æ©Ÿå·²è¨­å®š WUCHANG_HUB_URL/WUCHANG_HUB_TOKENã€‚";
        }
        logRun(data);
      } catch (e) {
        if ($("serverArchHint")) $("serverArchHint").textContent = "ç´¢å–å¤±æ•—ï¼ˆè«‹çœ‹å³æ™‚è¼¸å‡ºï¼‰ã€‚";
        logRun(String(e));
      }
    }

    async function hubGenerateServerReports() {
      try {
        const actor = ($("actor").value || "ops").trim();
        if ($("serverArchHint")) $("serverArchHint").textContent = "è«‹æ±‚ä¼ºæœå™¨ç”Ÿæˆå›å ±æª”ä¸­â€¦";
        const { data } = await fetchJson("/api/hub/generate_reports", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ actor })
        });
        const hub = data?.hub || {};
        const payload = (hub && typeof hub === "object" && ("data" in hub)) ? hub.data : data;
        // å°‡çµæœé™„åŠ åœ¨è¼¸å‡ºå€ï¼Œæ–¹ä¾¿è¤‡è£½/ç•™å­˜
        if ($("serverArchText")) {
          const prev = ($("serverArchText").value || "").trim();
          const next = JSON.stringify(payload, null, 2);
          $("serverArchText").value = prev ? (prev + "\n\n---\n\n" + next) : next;
        }
        if ($("serverArchHint")) {
          const ok = hub?.ok === true && (payload?.ok === true || payload?.ok === undefined);
          $("serverArchHint").textContent = ok
            ? "å·²è«‹æ±‚ä¼ºæœå™¨ç”Ÿæˆå›å ±æª”ï¼ˆè«‹çœ‹ JSON å…§çš„ out_dir / inventory_path / architecture_pathï¼‰ã€‚"
            : "ç”Ÿæˆå¤±æ•—ï¼šè«‹ç¢ºèª Hub å·²å•Ÿå‹•ã€ä¸”ä½ å·²ç™»å…¥ä¸”å…·å‚™ job_manage æ¬Šé™ã€‚";
        }
        logRun(data);
      } catch (e) {
        if ($("serverArchHint")) $("serverArchHint").textContent = "ç”Ÿæˆå¤±æ•—ï¼ˆè«‹çœ‹å³æ™‚è¼¸å‡ºï¼‰ã€‚";
        logRun(String(e));
      }
    }

    $("btnCheckServer").addEventListener("click", () => checkServer().catch(e => logRun(String(e))));
    $("btnCheckDNS").addEventListener("click", () => checkDNS().catch(e => logRun(String(e))));
    $("btnNetSnapshot").addEventListener("click", () => netSnapshot().catch(e => logRun(String(e))));
    $("btnLoadExpectedDNS").addEventListener("click", () => loadExpectedDNS().catch(e => logRun(String(e))));
    $("btnCheckDNS2").addEventListener("click", () => checkDNS2().catch(e => logRun(String(e))));
    $("btnHubServerArch").addEventListener("click", () => hubFetchServerArchitecture().catch(e => logRun(String(e))));
    $("btnHubGenerateReports").addEventListener("click", () => hubGenerateServerReports().catch(e => logRun(String(e))));
    $("btnHubServerArchCopy").addEventListener("click", async () => {
      const v = ($("serverArchText")?.value || "").trim();
      const ok = await copyText(v);
      logRun(ok ? "å·²è¤‡è£½ä¼ºæœå™¨ç³»çµ±æ¶æ§‹ JSON" : "è¤‡è£½å¤±æ•—ï¼ˆç€è¦½å™¨æ¬Šé™é™åˆ¶ï¼‰");
    });
    $("btnCopyAcmeRoot").addEventListener("click", async () => {
      const v = ($("expectedAcmeRoot").value || "").trim();
      const ok = await copyText(v);
      logRun(ok ? "å·²è¤‡è£½ _acme-challenge TXT" : "è¤‡è£½å¤±æ•—ï¼ˆç€è¦½å™¨æ¬Šé™é™åˆ¶ï¼‰");
    });
    $("btnCopyAcmeWww").addEventListener("click", async () => {
      const v = ($("expectedAcmeWww").value || "").trim();
      const ok = await copyText(v);
      logRun(ok ? "å·²è¤‡è£½ _acme-challenge.www TXT" : "è¤‡è£½å¤±æ•—ï¼ˆç€è¦½å™¨æ¬Šé™é™åˆ¶ï¼‰");
    });
    $("btnPushRules").addEventListener("click", () => runPush("rules").catch(e => logRun(String(e))));
    $("btnPushKB").addEventListener("click", () => runPush("kb").catch(e => logRun(String(e))));
    $("btnReloadAudit").addEventListener("click", () => loadAudit().catch(e => logRun(String(e))));
    $("btnLoadDoc").addEventListener("click", () => loadDoc().catch(e => logRun(String(e))));
    $("showRawAudit").addEventListener("change", () => loadAudit().catch(e => logRun(String(e))));
    $("btnVerifyNow").addEventListener("click", () => verifyRefresh().catch(e => logRun(String(e))));
    $("btnVerifyCopy").addEventListener("click", () => verifyCopyReport().catch(e => logRun(String(e))));
    $("btnVerifySendToLJ").addEventListener("click", () => verifySendToLittleJ().catch(e => logRun(String(e))));

    init();

    // ===== å°Jï¼šè‡ªç„¶èªè¨€èŠå¤© + èªéŸ³ =====
    function ljSessionId() {
      const k = "wuchang_lj_session_id";
      let v = localStorage.getItem(k);
      if (!v) {
        v = Math.random().toString(16).slice(2) + Date.now().toString(16);
        localStorage.setItem(k, v);
      }
      return v;
    }

    function ljAdd(role, text) {
      const box = $("ljMessages");
      const div = document.createElement("div");
      div.className = "msg " + (role === "user" ? "user" : "assistant");
      div.innerHTML = `<div class="role">${role === "user" ? "ä½ " : "å°J"}</div><div class="bubble"></div>`;
      div.querySelector(".bubble").textContent = String(text || "");
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }

    function ljSpeak(text) {
      try {
        if (!$("ljSpeak")?.checked) return;
        if (!window.speechSynthesis) return;
        const u = new SpeechSynthesisUtterance(String(text || ""));
        u.lang = "zh-TW";
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
      } catch (e) {}
    }

    async function ljSend(text) {
      const t = String(text || "").trim();
      if (!t) return;
      $("ljInput").value = "";
      ljAdd("user", t);

      const agent_mode = ($("ljMode").value || "command").trim();
      const agent_model = ($("ljModel").value || "local_rule").trim();

      const body = {
        text: t,
        session_id: ljSessionId(),
        domain: "wuchang.life",
        health_url: ($("healthUrl").value || "").trim(),
        copy_to: ($("copyTo").value || "").trim(),
        actor: ($("actor").value || "ops").trim(),
        agent_mode,
        agent_model,
        agent_provider: (agent_model === "local_rule") ? "local" : "openai_compat",
        ui_profile: (window.__uiProfileId || $("uiProfile")?.value || "ops_admin"),
        account_id: (window.__auth?.session?.account_id || ""),
        node: (typeof ccSelected !== "undefined" && typeof ccGetNode === "function") ? {
          id: ccSelected,
          name: (ccGetNode(ccSelected)?.name || "")
        } : {}
      };

      const { data } = await fetchJson("/api/agent/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      const reply = data?.reply || "ï¼ˆæ²’æœ‰å›è¦†ï¼‰";
      ljAdd("assistant", reply);
      ljSpeak(reply);
      // åŒæ­¥æŠŠçµæœä¸Ÿåˆ°ã€Œå³æ™‚è¼¸å‡ºã€å€ï¼Œæ–¹ä¾¿ä½ ä¸€çœ¼çœ‹åˆ°
      try { logRun(data); } catch (e) {}
      // è‹¥å›è¦†åŒ…å« jobï¼Œé †ä¾¿åˆ·æ–°æ”¶ä»¶åŒ£
      try {
        if (data?.job || data?.job_id) await jobRefresh();
      } catch (e) {}

      // è‹¥éœ€è¦ç¢ºèªï¼Œæä¾›ä¸€éµé€å‡ºç¢ºèªå¥
      if (data?.needs_confirmation && data?.confirm_phrase) {
        const phrase = data.confirm_phrase;
        const hint = `ï¼ˆéœ€è¦ç¢ºèªï¼‰ä½ å¯ä»¥ç›´æ¥å›è¦†ï¼š${phrase}`;
        ljAdd("assistant", hint);
        ljSpeak(hint);
      }

      // æ¬Šé™ä¸è¶³ï¼šè‹¥å°J å›å‚³æˆæ¬Šè«‹ç¤ºå–®ï¼Œå°±è‡ªå‹•æ‰“é–‹æˆæ¬Šçª—
      try {
        const rid = data?.authz_request?.id || "";
        if (rid) {
          await authzOpenModal(rid);
        }
      } catch (e) {}
    }

    function ljInit() {
      // åˆå§‹æ­¡è¿
      $("ljMessages").innerHTML = "";
      ljAdd("assistant", "æˆ‘åœ¨ã€‚ä½ å¯ä»¥ç”¨è‡ªç„¶èªè¨€å«æˆ‘åšï¼šæª¢æŸ¥ DNSã€è¼‰å…¥ DNS é æœŸå€¼ã€åšç¶²è·¯å¿«ç…§ã€æŸ¥çœ‹ç¨½æ ¸ã€æ¨é€ rules/kbï¼ˆé è¨­æ”¹æˆå»ºç«‹ã€å‘½ä»¤å–®ã€ï¼‰ã€‚ä½ ä¹Ÿå¯ä»¥èªªï¼šåˆ—å‡ºå‘½ä»¤å–®ã€‚");

      $("ljSend").addEventListener("click", () => ljSend($("ljInput").value).catch(e => ljAdd("assistant", String(e))));
      $("ljInput").addEventListener("keydown", (e) => {
        if (e.key === "Enter") ljSend($("ljInput").value).catch(err => ljAdd("assistant", String(err)));
      });
      $("ljClear").addEventListener("click", () => {
        $("ljMessages").innerHTML = "";
        ljAdd("assistant", "å·²æ¸…ç©ºã€‚è«‹ç¹¼çºŒä¸‹æŒ‡ä»¤ã€‚");
      });
      document.querySelectorAll("[data-lj]").forEach(el => {
        el.addEventListener("click", () => ljSend(el.getAttribute("data-lj")).catch(e => ljAdd("assistant", String(e))));
      });

      // load saved config from localStorage (UI side)
      try {
        const lm = localStorage.getItem("wuchang_lj_mode");
        const lmodel = localStorage.getItem("wuchang_lj_model");
        if (lm) $("ljMode").value = lm;
        if (lmodel) $("ljModel").value = lmodel;
      } catch (e) {}

      // load from backend (best-effort)
      ljLoadModels().catch(() => {});

      // Voice input (Web Speech API)
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) {
        $("ljVoiceHint").textContent = "æç¤ºï¼šæ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼ˆSpeechRecognitionï¼‰ã€‚å¯æ”¹ç”¨ Edge/Chromeï¼Œæˆ–ä½¿ç”¨æ‰“å­—ã€‚";
        $("ljMic").disabled = true;
        return;
      }
      const rec = new SR();
      rec.lang = "zh-TW";
      rec.interimResults = true;
      rec.continuous = false;
      let listening = false;

      rec.onresult = (ev) => {
        let finalText = "";
        let interim = "";
        for (let i = ev.resultIndex; i < ev.results.length; i++) {
          const r = ev.results[i];
          const txt = r[0]?.transcript || "";
          if (r.isFinal) finalText += txt;
          else interim += txt;
        }
        $("ljInput").value = (finalText || interim || "").trim();
      };
      rec.onstart = () => {
        listening = true;
        $("ljVoiceHint").textContent = "èªéŸ³è¾¨è­˜ä¸­â€¦è«‹èªªè©±ã€‚";
        $("ljMic").textContent = "åœæ­¢";
      };
      rec.onend = () => {
        listening = false;
        $("ljMic").textContent = "èªéŸ³";
        $("ljVoiceHint").textContent = $("ljInput").value ? "å·²è½‰æˆæ–‡å­—ï¼ŒæŒ‰ Enter æˆ–é€å‡ºå³å¯ã€‚" : "èªéŸ³å·²åœæ­¢ã€‚";
      };
      rec.onerror = (e) => {
        $("ljVoiceHint").textContent = "èªéŸ³éŒ¯èª¤ï¼š" + (e?.error || "unknown") + "ï¼ˆå¯èƒ½æ˜¯éº¥å…‹é¢¨æ¬Šé™/æ”¿ç­–é™åˆ¶ï¼‰";
      };

      $("ljMic").addEventListener("click", () => {
        try {
          if (listening) rec.stop();
          else rec.start();
        } catch (e) {
          $("ljVoiceHint").textContent = "ç„¡æ³•å•Ÿå‹•èªéŸ³è¾¨è­˜ï¼ˆå¯èƒ½éœ€è¦å…ˆå…è¨±éº¥å…‹é¢¨æ¬Šé™ï¼‰ã€‚";
        }
      });
    }

    // ===== èº«åˆ†/ä»‹é¢ï¼ˆProfileï¼‰ =====
    window.__uiProfiles = [];
    window.__uiProfileId = "ops_admin";

    async function uiLoadProfiles() {
      const { data } = await fetchJson("/api/ui/profiles");
      const profiles = data?.profiles || [];
      if (Array.isArray(profiles) && profiles.length) {
        window.__uiProfiles = profiles;
        // æ›´æ–°ä¸‹æ‹‰é¸å–®ï¼ˆä¿ç•™æ—¢æœ‰é¸é …ï¼‰
        const sel = $("uiProfile");
        const cur = sel.value;
        sel.innerHTML = profiles.map(p => `<option value="${p.id}">${p.label}</option>`).join("");
        // è®€ localStorage æˆ–æ²¿ç”¨åŸæœ¬
        const saved = localStorage.getItem("wuchang_ui_profile") || cur;
        sel.value = saved || profiles[0].id;
      }
      // å­˜èµ·ä¾†
      window.__uiProfileId = $("uiProfile").value || "ops_admin";
    }

    function uiGetProfile() {
      const id = $("uiProfile")?.value || "ops_admin";
      window.__uiProfileId = id;
      return (window.__uiProfiles || []).find(p => p.id === id) || null;
    }

    function uiApplyProfile() {
      const p = uiGetProfile();
      if (!p) return;
      try { localStorage.setItem("wuchang_ui_profile", p.id); } catch (e) {}

      const visible = new Set(p.visible_sections || []);
      document.querySelectorAll("[data-section]").forEach(el => {
        const key = el.getAttribute("data-section");
        el.style.display = visible.has(key) ? "" : "none";
      });

      const pol = p.agent_policy || {};
      $("uiProfilePolicy").value =
        `cloud=${pol.allow_cloud_chat ? "å…è¨±" : "ç¦æ­¢"}ï½œå»ºå–®=${pol.allow_job_create ? "å…è¨±" : "ç¦æ­¢"}ï½œæœ¬æ©Ÿé«˜é¢¨éšªåŸ·è¡Œ=${pol.allow_high_risk_execute_local ? "å…è¨±" : "ç¦æ­¢"}`;

      // åŒæ­¥ç¯€é»ï¼šåˆ‡æ›èº«åˆ†å¾Œï¼Œé è¨­è·³åˆ°è©²èº«åˆ†ç¯€é»ï¼ˆè‹¥å­˜åœ¨ï¼‰
      const nid = p.default_node_id;
      try {
        if (nid && typeof ccSelect === "function") ccSelect(nid);
      } catch (e) {}

      // åŒæ­¥å°Jæ¨¡å¼ï¼šè‹¥æ”¿ç­–ç¦æ­¢é›²ç«¯å°±å¼·åˆ¶æ”¹å› command
      try {
        if (!pol.allow_cloud_chat) {
          $("ljMode").value = "command";
          if ($("ljModel").value !== "local_rule") $("ljModel").value = "local_rule";
        }
      } catch (e) {}
    }

    $("uiProfile").addEventListener("change", () => {
      uiApplyProfile();
      logRun({ ok: true, action: "ui_profile_changed", profile: $("uiProfile").value });
    });

    async function ljLoadModels() {
      const { data } = await fetchJson("/api/agent/models");
      const cloudEnabled = data?.cloud_enabled === true;
      const current = data?.current || {};
      if (current?.mode) $("ljMode").value = current.mode;
      if (current?.model) $("ljModel").value = current.model;
      $("ljModelHint").textContent = cloudEnabled
        ? `é›²ç«¯å·²å•Ÿç”¨ï¼ˆbase_url=${data?.cloud_base_url || ""}ï¼‰ã€‚åˆ‡åˆ°é›²ç«¯æ¨¡å¼æ™‚ï¼ŒæœªçŸ¥å•ç­”æœƒå¤–é€åˆ°é›²ç«¯æ¨¡å‹ï¼›æ¶‰åŠå‹•ä½œä»èµ°æœ¬æ©Ÿç™½åå–®/å‘½ä»¤å–®ã€‚`
        : "é›²ç«¯æœªå•Ÿç”¨ï¼ˆæœªè¨­å®š WUCHANG_LLM_API_KEYï¼‰ã€‚åˆ‡åˆ°é›²ç«¯æ¨¡å¼æ™‚ä¸æœƒå¤–é€å…§å®¹ï¼Œæœƒæç¤ºä½ å…ˆè¨­å®šé‡‘é‘°ã€‚";
      // also persist UI choices
      try {
        localStorage.setItem("wuchang_lj_mode", $("ljMode").value);
        localStorage.setItem("wuchang_lj_model", $("ljModel").value);
      } catch (e) {}
      logRun(data);
    }

    async function ljSaveConfig() {
      const actor = ($("actor").value || "ops").trim();
      const mode = ($("ljMode").value || "command").trim();
      const model = ($("ljModel").value || "local_rule").trim();
      const provider = (model === "local_rule") ? "local" : "openai_compat";
      // persist UI side
      try {
        localStorage.setItem("wuchang_lj_mode", mode);
        localStorage.setItem("wuchang_lj_model", model);
      } catch (e) {}
      const { data } = await fetchJson("/api/agent/config", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ mode, model, provider, actor })
      });
      logRun(data);
      ljAdd("assistant", data?.ok ? `å·²å„²å­˜å°Jè¨­å®šï¼šmode=${mode} / model=${model}` : "å„²å­˜å¤±æ•—ï¼ˆè«‹çœ‹å³æ™‚è¼¸å‡ºï¼‰");
    }

    // ===== å‘½ä»¤å–®ï¼ˆJobï¼‰é¢æ¿ =====
    let jobSelectedId = "";

    function jobRenderList(items) {
      const box = $("jobList");
      if (!items || !items.length) {
        box.textContent = "ï¼ˆç›®å‰æ²’æœ‰å‘½ä»¤å–®ï¼‰";
        return;
      }
      box.innerHTML = "";
      for (const j of items) {
        const id = j.id || j._id || j.job_id || "unknown";
        const div = document.createElement("div");
        div.className = "jobitem";
        div.setAttribute("data-job-id", id);
        const t = j.type || "ï¼ˆæœªçŸ¥ï¼‰";
        const by = j.requested_by || j.actor || "ï¼ˆæœªçŸ¥ï¼‰";
        const at = j.created_at || j.timestamp || "ï¼ˆç„¡æ™‚é–“ï¼‰";
        div.innerHTML = `
          <div class="top">
            <div class="id">${id}</div>
            <div class="type">${t}</div>
          </div>
          <div class="meta">ç”± ${by} å»ºç«‹ï½œ${at}</div>
        `;
        div.addEventListener("click", () => jobSelect(id));
        box.appendChild(div);
      }
    }

    async function jobRefresh() {
      const state = $("jobState").value;
      const { data } = await fetchJson("/api/jobs/list?state=" + encodeURIComponent(state) + "&limit=50");
      jobRenderList(data?.items || []);
      if (jobSelectedId) {
        try { await jobSelect(jobSelectedId); } catch (e) {}
      }
    }

    async function jobSelect(id) {
      jobSelectedId = String(id || "").trim();
      if (!jobSelectedId) return;
      const { data } = await fetchJson("/api/jobs/get?id=" + encodeURIComponent(jobSelectedId));
      const job = data?.job || null;
      $("jobDetail").value = job ? JSON.stringify(job, null, 2) : (JSON.stringify(data, null, 2));
      logRun(data);
    }

    async function jobMove(to) {
      if (!jobSelectedId) {
        logRun("è«‹å…ˆåœ¨å·¦å´é»é¸ä¸€ç­†å‘½ä»¤å–®ã€‚");
        return;
      }
      const actor = ($("actor").value || "ops").trim();
      const { data } = await fetchJson("/api/jobs/move", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: jobSelectedId, to, actor })
      });
      logRun(data);
      await jobRefresh();
    }

    $("btnJobRefresh").addEventListener("click", () => jobRefresh().catch(e => logRun(String(e))));
    $("jobState").addEventListener("change", () => jobRefresh().catch(e => logRun(String(e))));
    $("btnJobMarkSent").addEventListener("click", () => jobMove("sent").catch(e => logRun(String(e))));
    $("btnJobArchive").addEventListener("click", () => jobMove("archive").catch(e => logRun(String(e))));
    $("btnJobCopy").addEventListener("click", async () => {
      const v = ($("jobDetail").value || "").trim();
      const ok = await copyText(v);
      logRun(ok ? "å·²è¤‡è£½å‘½ä»¤å–® JSON" : "è¤‡è£½å¤±æ•—ï¼ˆç€è¦½å™¨æ¬Šé™é™åˆ¶ï¼‰");
    });
    $("btnJobWriteWorkspace").addEventListener("click", async () => {
      const v = ($("jobDetail").value || "").trim();
      if (!v) { logRun("æ²’æœ‰å‘½ä»¤å–®å…§å®¹å¯å¯«å…¥ã€‚"); return; }
      const actor = ($("actor").value || "ops").trim();
      const body = {
        kind: "job_order",
        title: `job__${jobSelectedId || "unknown"}`,
        content: v,
        meta: { job_id: jobSelectedId, actor }
      };
      const { data } = await fetchJson("/api/workspace/write", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      logRun(data);
    });

    async function hubSendSelectedJob() {
      if (!jobSelectedId) { logRun("è«‹å…ˆé»é¸ä¸€ç­†å‘½ä»¤å–®ã€‚"); return; }
      const { data } = await fetchJson("/api/hub/submit_job", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ job_id: jobSelectedId })
      });
      logRun(data);
    }

    async function hubConfirmSelectedJob() {
      if (!jobSelectedId) { logRun("è«‹å…ˆé»é¸ä¸€ç­†å‘½ä»¤å–®ã€‚"); return; }
      const actor = ($("actor").value || "ops").trim();
      const { data } = await fetchJson("/api/hub/confirm_job", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ job_id: jobSelectedId, actor })
      });
      logRun(data);
    }

    $("btnJobSendHub").addEventListener("click", () => hubSendSelectedJob().catch(e => logRun(String(e))));
    $("btnJobConfirmHub").addEventListener("click", () => hubConfirmSelectedJob().catch(e => logRun(String(e))));

    // ===== æˆæ¬Šè«‹ç¤ºå–®ï¼ˆAuthzï¼‰é¢æ¿ + æˆæ¬Šçª— =====
    let authzSelectedId = "";

    function authzRenderList(items) {
      const box = $("authzList");
      if (!box) return;
      if (!items || !items.length) {
        box.textContent = "ï¼ˆç›®å‰æ²’æœ‰æˆæ¬Šè«‹ç¤ºå–®ï¼‰";
        return;
      }
      box.innerHTML = "";
      for (const r of items) {
        const id = r.id || r.request_id || r._id || "unknown";
        const div = document.createElement("div");
        div.className = "jobitem";
        div.setAttribute("data-authz-id", id);
        const perms = (r.permissions || []).join(", ") || "ï¼ˆæœªå¡«ï¼‰";
        const by = r.requested_by || r.requester_account_id || "ï¼ˆæœªçŸ¥ï¼‰";
        const at = r.created_at || "ï¼ˆç„¡æ™‚é–“ï¼‰";
        const st = r.status || "unknown";
        div.innerHTML = `
          <div class="top">
            <div class="id">${id}</div>
            <div class="type">${st}</div>
          </div>
          <div class="meta">æ¬Šé™ï¼š${perms}ï½œç”± ${by}ï½œ${at}</div>
        `;
        div.addEventListener("click", () => authzSelect(id));
        box.appendChild(div);
      }
    }

    async function authzRefresh() {
      const state = ($("authzState")?.value || "pending").trim();
      // éç®¡ç†å“¡å¯ç”¨ mine=1 åˆ—å‡ºè‡ªå·±çš„ pending
      const mine = (state === "pending") ? "&mine=1" : "";
      const { data } = await fetchJson("/api/authz/requests/list?state=" + encodeURIComponent(state) + "&limit=50" + mine);
      authzRenderList(data?.items || []);
      if (authzSelectedId) {
        try { await authzSelect(authzSelectedId); } catch (e) {}
      }
      $("authzHint").textContent = data?.ok ? "å·²è¼‰å…¥æˆæ¬Šè«‹ç¤ºå–®æ¸…å–®ã€‚" : "è¼‰å…¥å¤±æ•—ï¼ˆè«‹çœ‹å³æ™‚è¼¸å‡ºï¼‰ã€‚";
      logRun(data);
    }

    async function authzSelect(id) {
      authzSelectedId = String(id || "").trim();
      if (!authzSelectedId) return;
      const { data } = await fetchJson("/api/authz/requests/get?id=" + encodeURIComponent(authzSelectedId));
      $("authzDetail").value = data?.request ? JSON.stringify(data.request, null, 2) : JSON.stringify(data, null, 2);
      try {
        const scope = data?.request?.scope || {};
        $("authzScope").value = JSON.stringify(scope, null, 2);
        const items = data?.request?.items || [];
        $("authzItems").value = JSON.stringify(items, null, 2);
        $("authzTtl").value = String(data?.request?.ttl_seconds || $("authzTtl")?.value || "3600");
      } catch (e) {}
      logRun(data);
    }

    async function authzApprove(id, ttlSeconds) {
      const rid = String(id || authzSelectedId || "").trim();
      if (!rid) { logRun("è«‹å…ˆé¸å–ä¸€å¼µæˆæ¬Šè«‹ç¤ºå–®ã€‚"); return; }
      const ttl = Number(ttlSeconds || $("authzTtl")?.value || 3600);
      let scope = {};
      try { scope = JSON.parse(($("authzScope")?.value || "{}").trim() || "{}"); } catch (e) { scope = {}; }
      let items = null;
      try {
        const raw = ($("authzItems")?.value || "").trim();
        items = raw ? JSON.parse(raw) : null;
      } catch (e) { items = null; }
      const { data } = await fetchJson("/api/authz/requests/approve", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: rid, ttl_seconds: ttl, scope, items })
      });
      logRun(data);
      await authzRefresh();
      try { await authzLoadGrants(); } catch (e) {}
    }

    async function authzDeny(id, reason) {
      const rid = String(id || authzSelectedId || "").trim();
      if (!rid) { logRun("è«‹å…ˆé¸å–ä¸€å¼µæˆæ¬Šè«‹ç¤ºå–®ã€‚"); return; }
      const why = String(reason || $("authzReason")?.value || "").trim();
      const { data } = await fetchJson("/api/authz/requests/deny", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: rid, reason: why })
      });
      logRun(data);
      await authzRefresh();
    }

    async function authzLoadGrants() {
      const { data } = await fetchJson("/api/authz/grants/list");
      $("authzGrants").value = JSON.stringify(data?.items || [], null, 2);
      logRun(data);
    }

    async function authzRevoke(grantId, reason) {
      const gid = String(grantId || "").trim() || (() => {
        try {
          const items = JSON.parse($("authzGrants")?.value || "[]");
          return (items && items[0] && items[0].id) ? String(items[0].id) : "";
        } catch (e) { return ""; }
      })();
      if (!gid) { logRun("è«‹æä¾› grant_idï¼ˆå¯å…ˆè¼‰å…¥ grantsï¼‰ã€‚"); return; }
      const why = String(reason || $("authzReason")?.value || "").trim();
      const { data } = await fetchJson("/api/authz/grants/revoke", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: gid, reason: why })
      });
      logRun(data);
      await authzLoadGrants();
    }

    function authzModalShow(on) {
      const el = $("authzModalBackdrop");
      if (!el) return;
      el.style.display = on ? "flex" : "none";
    }

    async function authzOpenModal(requestId) {
      const rid = String(requestId || authzSelectedId || "").trim();
      if (!rid) { logRun("æ²’æœ‰ request_id å¯é–‹å•Ÿã€‚"); return; }
      authzSelectedId = rid;
      $("authzModalId").value = rid;
      $("authzModalHint").textContent = "è¼‰å…¥ä¸­â€¦";
      authzModalShow(true);
      const { data } = await fetchJson("/api/authz/requests/get?id=" + encodeURIComponent(rid));
      const text = data?.request ? JSON.stringify(data.request, null, 2) : JSON.stringify(data, null, 2);
      $("authzModalDetail").value = text;
      $("authzDetail").value = text; // åŒæ­¥åˆ°é¢æ¿
      try {
        const scope = data?.request?.scope || {};
        $("authzModalScope").value = JSON.stringify(scope, null, 2);
        const items = data?.request?.items || [];
        $("authzModalItems").value = JSON.stringify(items, null, 2);
        $("authzModalTtl").value = String(data?.request?.ttl_seconds || $("authzModalTtl")?.value || "3600");
        $("authzScope").value = JSON.stringify(scope, null, 2);
        $("authzItems").value = JSON.stringify(items, null, 2);
        $("authzTtl").value = String(data?.request?.ttl_seconds || $("authzTtl")?.value || "3600");
      } catch (e) {}
      $("authzModalHint").textContent = data?.ok ? "å·²è¼‰å…¥ã€‚" : "è¼‰å…¥å¤±æ•—ï¼ˆå¯èƒ½éœ€è¦ç®¡ç†å“¡æ¬Šé™ï¼‰ã€‚";
      try { logRun(data); } catch (e) {}
    }

    $("btnAuthzRefresh")?.addEventListener("click", () => authzRefresh().catch(e => logRun(String(e))));
    $("authzState")?.addEventListener("change", () => authzRefresh().catch(e => logRun(String(e))));
    $("btnAuthzOpenModal")?.addEventListener("click", () => authzOpenModal(authzSelectedId).catch(e => logRun(String(e))));
    $("btnAuthzApprove")?.addEventListener("click", () => authzApprove(authzSelectedId, $("authzTtl")?.value).catch(e => logRun(String(e))));
    $("btnAuthzDeny")?.addEventListener("click", () => authzDeny(authzSelectedId, $("authzReason")?.value).catch(e => logRun(String(e))));
    $("btnAuthzLoadGrants")?.addEventListener("click", () => authzLoadGrants().catch(e => logRun(String(e))));
    $("btnAuthzRevoke")?.addEventListener("click", () => authzRevoke("", $("authzReason")?.value).catch(e => logRun(String(e))));

    $("btnAuthzModalClose")?.addEventListener("click", () => authzModalShow(false));
    $("authzModalBackdrop")?.addEventListener("click", (e) => { if (e.target && e.target.id === "authzModalBackdrop") authzModalShow(false); });
    $("btnAuthzModalApprove")?.addEventListener("click", async () => {
      const rid = ($("authzModalId")?.value || "").trim();
      const ttl = ($("authzModalTtl")?.value || "3600").trim();
      // modal scope å„ªå…ˆ
      let scope = {};
      try { scope = JSON.parse(($("authzModalScope")?.value || "{}").trim() || "{}"); } catch (e) { scope = {}; }
      let items = null;
      try {
        const raw = ($("authzModalItems")?.value || "").trim();
        items = raw ? JSON.parse(raw) : null;
      } catch (e) { items = null; }
      const { data } = await fetchJson("/api/authz/requests/approve", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: rid, ttl_seconds: Number(ttl || 3600), scope, items })
      });
      logRun(data);
      await authzRefresh();
      try { await authzLoadGrants(); } catch (e) {}
      $("authzModalHint").textContent = "å·²é€å‡ºæ ¸å‡†ï¼ˆè«‹çœ‹å³æ™‚è¼¸å‡ºï¼‰ã€‚";
    });
    $("btnAuthzModalDeny")?.addEventListener("click", async () => {
      const rid = ($("authzModalId")?.value || "").trim();
      const why = ($("authzReason")?.value || "").trim();
      await authzDeny(rid, why);
      $("authzModalHint").textContent = "å·²é€å‡ºæ‹’çµ•ï¼ˆè«‹çœ‹å³æ™‚è¼¸å‡ºï¼‰ã€‚";
    });
    $("btnAuthzModalCopy")?.addEventListener("click", async () => {
      const v = ($("authzModalDetail")?.value || "").trim();
      const ok = await copyText(v);
      $("authzModalHint").textContent = ok ? "å·²è¤‡è£½ã€‚" : "è¤‡è£½å¤±æ•—ï¼ˆç€è¦½å™¨æ¬Šé™é™åˆ¶ï¼‰ã€‚";
    });

    // ===== PIIï¼ˆå€‹è³‡ï¼‰åˆ†ç´šï¼šå¯è­˜åˆ¥ / ä¸å¯è­˜åˆ¥ =====
    window.__piiCacheIdent = window.__piiCacheIdent || {};
    window.__piiCacheNon = window.__piiCacheNon || {};

    function piiClass() {
      return ($("piiClass")?.value || "identifiable").trim();
    }

    function piiApplyClassUI() {
      const cls = piiClass();
      const ident = (cls === "identifiable");
      $("piiClassHint").value = ident ? "ç§å¯†ï¼šå§“å/é›»è©±/Emailï¼ˆä¸å°å¤–è¼¸å‡ºï¼‰" : "æ‘˜è¦ï¼šè§’è‰²/å‚™è¨»ï¼ˆå¯ç”¨æ–¼ Workspace è¼¸å‡ºï¼‰";

      // é¡¯ç¤º/éš±è—æ¬„ä½ï¼ˆé¿å…èª¤å¡«ï¼‰
      const showIdent = (el, on) => { if (el && el.parentElement) el.parentElement.style.display = on ? "" : "none"; };
      showIdent($("piiName"), ident);
      showIdent($("piiPhone"), ident);
      showIdent($("piiEmail"), ident);

      showIdent($("piiRole"), !ident);
      if ($("piiNote") && $("piiNote").parentElement) $("piiNote").parentElement.style.display = ident ? "none" : "";
    }

    function piiFillFromCache(nid) {
      const cls = piiClass();
      if (cls === "identifiable") {
        const c = window.__piiCacheIdent[nid] || {};
        $("piiName").value = c.name || "";
        $("piiPhone").value = c.phone || "";
        $("piiEmail").value = c.email || "";
      } else {
        const c = window.__piiCacheNon[nid] || {};
        $("piiRole").value = c.role || "";
        $("piiNote").value = c.note || "";
      }
    }

    async function piiLoadForSelected(cls) {
      const nid = (typeof ccSelected !== "undefined") ? ccSelected : "";
      if (!nid) return;
      const c = (cls || piiClass()).trim();
      const { data } = await fetchJson("/api/pii/get?node_id=" + encodeURIComponent(nid) + "&class=" + encodeURIComponent(c));
      if (!data?.ok) {
        $("piiHint").textContent = (data?.error === "forbidden")
          ? "ç„¡æ³•è¼‰å…¥ï¼šæœªç™»å…¥æˆ–ç„¡æ¬Šé™ã€‚"
          : "ç„¡æ³•è¼‰å…¥ï¼šè«‹å…ˆè¨­å®š WUCHANG_WORKSPACE_OUTDIRï¼ˆæˆ– WUCHANG_PII_OUTDIRï¼‰ã€‚";
        return;
      }
      const got = data.contact || {};
      if (data.pii_class === "non_identifiable" || c === "non_identifiable") window.__piiCacheNon[nid] = got;
      else window.__piiCacheIdent[nid] = got;

      piiApplyClassUI();
      piiFillFromCache(nid);
      $("piiHint").textContent = `å·²è¼‰å…¥ï¼ˆ${data.pii_class}ï½œvault: ${data.vault_path || ""}ï¼‰`;
      try { ccRenderDetails(); } catch (e) {}
    }

    async function piiLoadAllForSelected() {
      await piiLoadForSelected("non_identifiable").catch(() => {});
      await piiLoadForSelected("identifiable").catch(() => {});
    }

    async function piiSaveForSelected(clear = false) {
      const nid = (typeof ccSelected !== "undefined") ? ccSelected : "";
      if (!nid) { logRun("å°šæœªé¸æ“‡ç¯€é»ã€‚"); return; }
      const actor = ($("actor").value || "ops").trim();
      const cls = piiClass();
      let contact = null;
      if (!clear) {
        if (cls === "identifiable") {
          contact = {
            name: ($("piiName").value || "").trim(),
            phone: ($("piiPhone").value || "").trim(),
            email: ($("piiEmail").value || "").trim(),
          };
        } else {
          contact = {
            role: ($("piiRole").value || "").trim(),
            note: ($("piiNote").value || "").trim(),
          };
        }
      }
      const { data } = await fetchJson("/api/pii/set", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ node_id: nid, actor, pii_class: cls, contact })
      });
      if (data?.ok) {
        if (cls === "identifiable") window.__piiCacheIdent[nid] = clear ? {} : (contact || {});
        else window.__piiCacheNon[nid] = clear ? {} : (contact || {});
        piiFillFromCache(nid);
        $("piiHint").textContent = clear ? `å·²æ¸…é™¤ï¼ˆ${cls}ï¼‰` : `å·²å„²å­˜ï¼ˆ${cls}ï¼‰`;
        try { ccRenderDetails(); } catch (e) {}
      }
      logRun(data);
    }

    async function piiMatchForSelected() {
      const nid = (typeof ccSelected !== "undefined") ? ccSelected : "";
      if (!nid) { logRun("å°šæœªé¸æ“‡ç¯€é»ã€‚"); return; }
      const name_mask = ($("piiMatchNameMask").value || "").trim();
      const phone_last4 = ($("piiMatchPhoneLast4").value || "").trim();
      const { data } = await fetchJson("/api/pii/match", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ node_id: nid, name_mask, phone_last4 })
      });
      if (data?.ok) {
        $("piiHint").textContent = data.match
          ? `æ¯”å°é€šéï¼ˆé®ç½©é è¦½ï¼š${data?.preview?.name_masked || ""} / ${data?.preview?.phone_masked || ""}ï¼‰`
          : `æ¯”å°æœªé€šéï¼ˆé®ç½©é è¦½ï¼š${data?.preview?.name_masked || ""} / ${data?.preview?.phone_masked || ""}ï¼‰`;
      } else {
        $("piiHint").textContent = (data?.error === "forbidden") ? "ç„¡æ³•æ¯”å°ï¼šæœªç™»å…¥æˆ–ç„¡æ¬Šé™ã€‚" : "æ¯”å°å¤±æ•—";
      }
      logRun(data);
    }

    $("piiClass").addEventListener("change", () => {
      piiApplyClassUI();
      const nid = (typeof ccSelected !== "undefined") ? ccSelected : "";
      if (nid) piiFillFromCache(nid);
    });
    piiApplyClassUI();

    $("btnPiiLoad").addEventListener("click", () => piiLoadForSelected(piiClass()).catch(e => logRun(String(e))));
    $("btnPiiSave").addEventListener("click", () => piiSaveForSelected(false).catch(e => logRun(String(e))));
    $("btnPiiClear").addEventListener("click", () => piiSaveForSelected(true).catch(e => logRun(String(e))));
    $("btnPiiMatch").addEventListener("click", () => piiMatchForSelected().catch(e => logRun(String(e))));

    // å°J æ¨¡å‹åˆ‡æ›æŒ‰éˆ•
    $("ljLoadModels").addEventListener("click", () => ljLoadModels().catch(e => logRun(String(e))));
    $("ljSaveConfig").addEventListener("click", () => ljSaveConfig().catch(e => logRun(String(e))));

    // ===== ä¸‰äººå°è©±æœƒè­°å®¤ =====
    let tripleJSessionId = null;
    let tripleJConversationHistory = [];

    function tripleJSessionIdFunc() {
      if (!tripleJSessionId) {
        const k = "wuchang_triple_j_session_id";
        let v = localStorage.getItem(k);
        if (!v) {
          v = Math.random().toString(16).slice(2) + Date.now().toString(16);
          localStorage.setItem(k, v);
        }
        tripleJSessionId = v;
      }
      return tripleJSessionId;
    }

    function tripleJAdd(role, text, agent = null) {
      const box = $("tripleJMessages");
      if (!box) return;
      const div = document.createElement("div");
      div.className = "msg " + (role === "user" ? "user" : "assistant");
      
      let roleLabel = role === "user" ? "ä½ " : (agent || "ç³»çµ±");
      if (agent === "åœ°ç«¯å° j") {
        roleLabel = "åœ°ç«¯å° j";
        div.style.borderLeft = "3px solid #667eea";
      } else if (agent === "é›²ç«¯å° j (JULES)") {
        roleLabel = "é›²ç«¯å° j";
        div.style.borderLeft = "3px solid #764ba2";
      }
      
      div.innerHTML = `<div class="role">${roleLabel}</div><div class="bubble"></div>`;
      div.querySelector(".bubble").textContent = String(text || "");
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }

    async function tripleJSend(text) {
      const t = String(text || "").trim();
      if (!t) return;
      const input = $("tripleJInput");
      if (input) input.value = "";
      
      // é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
      tripleJAdd("user", t);
      tripleJConversationHistory.push({ role: "user", content: t });
      
      // é¡¯ç¤ºè¼‰å…¥ä¸­
      const loadingDiv = document.createElement("div");
      loadingDiv.className = "msg assistant";
      loadingDiv.innerHTML = '<div class="role">ç³»çµ±</div><div class="bubble">åœ°ç«¯å° j å’Œé›²ç«¯å° j æ­£åœ¨æ€è€ƒ...</div>';
      const box = $("tripleJMessages");
      if (box) {
        box.appendChild(loadingDiv);
        box.scrollTop = box.scrollHeight;
      }
      
      try {
        const { data } = await fetchJson("/api/triple_j_conference", {
          method: "POST",
          body: JSON.stringify({
            message: t,
            session_id: tripleJSessionIdFunc(),
            conversation_history: tripleJConversationHistory.slice(-10)
          })
        });
        
        // ç§»é™¤è¼‰å…¥ä¸­
        if (loadingDiv.parentNode) loadingDiv.remove();
        
        if (data && data.ok) {
          const responses = data.responses || {};
          
          // é¡¯ç¤ºåœ°ç«¯å° j å›æ‡‰
          if (responses.local_j && responses.local_j.ok) {
            const localJResponse = responses.local_j.response;
            tripleJAdd("assistant", localJResponse, "åœ°ç«¯å° j");
            tripleJConversationHistory.push({ role: "assistant", content: localJResponse, agent: "åœ°ç«¯å° j" });
            
            // æª¢æŸ¥åœ°ç«¯å° j æ˜¯å¦è«‹æ±‚é¡é ­æˆæ¬Š
            if (localJResponse.includes("é¡é ­") || localJResponse.includes("æ”åƒé ­") || localJResponse.includes("camera") || 
                localJResponse.includes("æˆæ¬Š") || localJResponse.includes("æ¬Šé™")) {
              // è‡ªå‹•è«‹æ±‚é¡é ­æˆæ¬Š
              requestLocalJCameraPermission();
            }
          } else if (responses.local_j) {
            tripleJAdd("assistant", `åœ°ç«¯å° jï¼š${responses.local_j.response || "ç„¡æ³•å›æ‡‰"}`, "åœ°ç«¯å° j");
          }
          
          // é¡¯ç¤ºé›²ç«¯å° j å›æ‡‰
          if (responses.cloud_j && responses.cloud_j.ok) {
            tripleJAdd("assistant", responses.cloud_j.response, "é›²ç«¯å° j (JULES)");
            tripleJConversationHistory.push({ role: "assistant", content: responses.cloud_j.response, agent: "é›²ç«¯å° j (JULES)" });
          } else if (responses.cloud_j) {
            tripleJAdd("assistant", `é›²ç«¯å° jï¼š${responses.cloud_j.response || "ç„¡æ³•å›æ‡‰"}`, "é›²ç«¯å° j (JULES)");
          }
        } else {
          tripleJAdd("assistant", `éŒ¯èª¤ï¼š${(data && data.error) || "æœªçŸ¥éŒ¯èª¤"}`, "ç³»çµ±");
        }
      } catch (e) {
        if (loadingDiv.parentNode) loadingDiv.remove();
        tripleJAdd("assistant", `ç™¼ç”ŸéŒ¯èª¤ï¼š${String(e)}`, "ç³»çµ±");
      }
    }

    // åœ°ç«¯å° J é¡é ­æˆæ¬ŠåŠŸèƒ½
    let localJCameraPermissionStatus = null;
    
    async function requestLocalJCameraPermission() {
      try {
        const { data } = await fetchJson("/api/local_j/camera_permission", {
          method: "POST",
          body: JSON.stringify({
            reason: "åœ°ç«¯å° J è«‹æ±‚é¡é ­é©—è­‰æˆæ¬Š",
            session_id: tripleJSessionIdFunc()
          })
        });
        
        if (data?.ok) {
          localJCameraPermissionStatus = data.permission_request;
          // é¡¯ç¤ºæˆæ¬Šè«‹æ±‚é€šçŸ¥
          const permissionDiv = document.createElement("div");
          permissionDiv.className = "msg assistant";
          permissionDiv.style.background = "#fff3cd";
          permissionDiv.style.border = "2px solid #ffc107";
          permissionDiv.style.borderRadius = "8px";
          permissionDiv.style.padding = "12px";
          permissionDiv.style.margin = "8px 0";
          permissionDiv.innerHTML = `
            <div class="role" style="color: #856404; font-weight: bold;">ğŸ” åœ°ç«¯å° J é¡é ­æˆæ¬Šè«‹æ±‚</div>
            <div class="bubble" style="color: #856404;">
              <p>åœ°ç«¯å° J è«‹æ±‚ä½¿ç”¨é¡é ­é€²è¡Œé©—è­‰</p>
              <p style="font-size: 0.9em; margin-top: 8px;">åŸå› ï¼š${data.permission_request?.reason || "åœ°ç«¯å° J è«‹æ±‚é¡é ­é©—è­‰æˆæ¬Š"}</p>
              <div style="margin-top: 12px;">
                <button id="btnGrantCameraPermission" class="primary" style="margin-right: 8px;">âœ… æ‰¹å‡†æˆæ¬Š</button>
                <button id="btnDenyCameraPermission" class="secondary">âŒ æ‹’çµ•</button>
              </div>
            </div>
          `;
          
          const box = $("tripleJMessages");
          if (box) {
            box.appendChild(permissionDiv);
            box.scrollTop = box.scrollHeight;
            
            // ç¶å®šæŒ‰éˆ•äº‹ä»¶
            $("btnGrantCameraPermission")?.addEventListener("click", () => grantLocalJCameraPermission());
            $("btnDenyCameraPermission")?.addEventListener("click", () => {
              permissionDiv.remove();
              tripleJAdd("assistant", "å·²æ‹’çµ•åœ°ç«¯å° J çš„é¡é ­æˆæ¬Šè«‹æ±‚", "ç³»çµ±");
            });
          }
        }
      } catch (e) {
        console.error("è«‹æ±‚é¡é ­æˆæ¬Šå¤±æ•—:", e);
      }
    }
    
    async function grantLocalJCameraPermission() {
      try {
        const { data } = await fetchJson("/api/local_j/camera_permission/grant", {
          method: "POST",
          body: JSON.stringify({
            session_id: tripleJSessionIdFunc(),
            granted_by: "user"
          })
        });
        
        if (data?.ok) {
          tripleJAdd("assistant", "âœ… å·²æ‰¹å‡†åœ°ç«¯å° J çš„é¡é ­æˆæ¬Šï¼Œç¾åœ¨å¯ä»¥é€²è¡Œç”Ÿç‰©ç‰¹å¾µé©—è­‰", "ç³»çµ±");
          
          // è‡ªå‹•å•Ÿå‹•ç”Ÿç‰©ç‰¹å¾µæƒæ
          setTimeout(() => {
            if ($("biometricVerification")) {
              $("biometricVerification").style.display = "block";
              if ($("btnStartBiometricScan")) {
                $("btnStartBiometricScan").click();
              }
            }
          }, 500);
        }
      } catch (e) {
        tripleJAdd("assistant", `æ‰¹å‡†æˆæ¬Šå¤±æ•—ï¼š${String(e)}`, "ç³»çµ±");
      }
    }
    
    async function checkLocalJCameraPermissionStatus() {
      try {
        const { data } = await fetchJson(`/api/local_j/camera_permission/status?session_id=${encodeURIComponent(tripleJSessionIdFunc())}`);
        if (data?.ok) {
          localJCameraPermissionStatus = data.permission;
          return data.has_permission;
        }
      } catch (e) {
        console.error("æŸ¥è©¢æˆæ¬Šç‹€æ…‹å¤±æ•—:", e);
      }
      return false;
    }
    
    // æ‰‹å‹•è«‹æ±‚é¡é ­æˆæ¬ŠæŒ‰éˆ•ï¼ˆå¯é¸ï¼‰
    function addCameraPermissionButton() {
      const tripleJSection = document.querySelector('[data-section="triple_j_conference"]');
      if (tripleJSection) {
        const button = document.createElement("button");
        button.className = "secondary";
        button.textContent = "ğŸ“· åœ°ç«¯å° J è«‹æ±‚é¡é ­æˆæ¬Š";
        button.title = "è®“åœ°ç«¯å° J è«‹æ±‚ä½¿ç”¨é¡é ­é€²è¡Œé©—è­‰";
        button.style.marginLeft = "8px";
        button.addEventListener("click", () => {
          requestLocalJCameraPermission();
          tripleJAdd("user", "è«‹åœ°ç«¯å°jé ˜å–é¡é ­é©—è­‰æˆæ¬Š", "ä½ ");
        });
        
        const inputContainer = $("tripleJInput")?.parentElement;
        if (inputContainer) {
          inputContainer.appendChild(button);
        }
      }
    }
    
    const tripleJSendBtn = $("tripleJSend");
    if (tripleJSendBtn) {
      tripleJSendBtn.addEventListener("click", () => {
        const input = $("tripleJInput");
        if (input) {
          const text = input.value.trim();
          if (text) tripleJSend(text).catch(e => console.error(e));
        }
      });
    }

    // åˆå§‹åŒ–ï¼šåŠ å…¥é¡é ­æˆæ¬ŠæŒ‰éˆ•
    addCameraPermissionButton();
    
    // æª¢æŸ¥ç¾æœ‰æˆæ¬Šç‹€æ…‹
    checkLocalJCameraPermissionStatus().then(hasPermission => {
      if (hasPermission) {
        tripleJAdd("assistant", "âœ… åœ°ç«¯å° J å·²ç²å¾—é¡é ­æˆæ¬Š", "ç³»çµ±");
      }
    });
    
    const tripleJInput = $("tripleJInput");
    if (tripleJInput) {
      tripleJInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          const text = e.target.value.trim();
          if (text) tripleJSend(text).catch(e => console.error(e));
        }
      });
    }

    const tripleJClearBtn = $("tripleJClear");
    if (tripleJClearBtn) {
      tripleJClearBtn.addEventListener("click", () => {
        const box = $("tripleJMessages");
        if (box) {
          box.innerHTML = `
            <div class="msg system">
              <div class="role">ç³»çµ±</div>
              <div class="bubble">
                <strong>æœƒè­°å®¤å·²é–‹å•Ÿ</strong><br/>
                åƒèˆ‡è€…ï¼š<br/>
                â€¢ ä½¿ç”¨è€…ï¼ˆä½ ï¼‰<br/>
                â€¢ åœ°ç«¯å° jï¼ˆæœ¬åœ° LLM åŠ©ç†ï¼‰<br/>
                â€¢ é›²ç«¯å° j (JULES)ï¼ˆé›²ç«¯ AI åŠ©ç†ï¼‰<br/><br/>
                <strong>ç•¶å‰è­°é¡Œï¼šå…¨ç³»çµ±è¨­å®šç‚ºä½•ç„¡æ³•å…¨çƒå¯è¦‹ï¼Ÿå¦‚ä½•æ”¹å–„ï¼Ÿ</strong>
              </div>
            </div>
          `;
        }
        tripleJConversationHistory = [];
      });
    }

    // è‡ªå‹•ç™¼é€åˆå§‹å•é¡Œ
    setTimeout(() => {
      if (tripleJConversationHistory.length === 0 && $("tripleJMessages")) {
        tripleJSend("ç›®å‰å…¨ç³»çµ±è¨­å®šç‚ºä½•ç„¡æ³•å…¨çƒå¯è¦‹ï¼Ÿè«‹åˆ†æå•é¡Œä¸¦æå‡ºæ”¹å–„æ–¹æ¡ˆã€‚").catch(e => console.error(e));
      }
    }, 2000);

    // å¸³è™Ÿç™»å…¥/ç™»å‡º
    $("btnLogin").addEventListener("click", () => authLogin().catch(e => logRun(String(e))));
    $("btnLogout").addEventListener("click", () => authLogout().catch(e => logRun(String(e))));
    $("btnAuthRefresh").addEventListener("click", () => authRefresh().catch(e => logRun(String(e))));
    $("accountId").addEventListener("keydown", (e) => { if (e.key === "Enter") authLogin().catch(err => logRun(String(err))); });
    $("accountPin").addEventListener("keydown", (e) => { if (e.key === "Enter") authLogin().catch(err => logRun(String(err))); });

    // è¨­è¨ˆå•Ÿç”¨ï¼ˆè³‡è¨Šç´€éŒ„/ç•™ç—•ï¼‰
    $("btnDesignModeRefresh")?.addEventListener("click", () => designModeRefresh().catch(e => logRun(String(e))));
    $("btnDesignModeEnable")?.addEventListener("click", () => designModeSet(true).catch(e => logRun(String(e))));
    $("btnDesignModeDisable")?.addEventListener("click", () => designModeSet(false).catch(e => logRun(String(e))));
    $("btnDesignModeRecord")?.addEventListener("click", () => designModeRecord().catch(e => logRun(String(e))));

    // ä¸å¯è­˜åˆ¥å€‹è³‡ï¼ˆå¸³è™Ÿç·¨ç¢¼ï¼‰
    $("btnNonidLoad").addEventListener("click", () => nonidLoad().catch(e => logRun(String(e))));
    $("btnNonidSave").addEventListener("click", () => nonidSave(false).catch(e => logRun(String(e))));
    $("btnNonidClear").addEventListener("click", () => nonidSave(true).catch(e => logRun(String(e))));

    // åŒæ„ï¼ˆConsentï¼‰
    $("btnConsentGrant").addEventListener("click", () => consentGrant().catch(e => logRun(String(e))));
    $("btnConsentRevoke").addEventListener("click", () => consentRevoke().catch(e => logRun(String(e))));
    $("btnConsentRefresh").addEventListener("click", () => consentRefresh().catch(e => logRun(String(e))));

    // åˆå§‹ï¼šæœªåŒæ„å…ˆç¦ç”¨ä¸å¯è­˜åˆ¥è³‡æ–™æ“ä½œï¼ˆå¾… consentRefresh/ç™»å…¥å¾Œæ›´æ–°ï¼‰
    try { nonidSetEnabled(false); } catch (e) {}

    // ===== å€‹äºº AI ç¶å®š =====
    async function loadPersonalBindingStatus() {
      try {
        const { data } = await fetchJson("/api/personal_ai_binding/status");
        const statusDiv = $("personalBindingStatus");
        const formDiv = $("personalBindingForm");
        const verifyFormDiv = $("personalVerificationForm");
        const verifyDataDiv = $("personalVerificationData");
        
        if (data?.ok && data?.status?.bound) {
          const status = data.status;
          const macMatch = status.mac_match !== false;
          statusDiv.innerHTML = `
            <div style="color: #28a745; font-weight: bold; margin-bottom: 8px;">
              âœ… å·²ç¶å®šå€‹äººèº«ä»½
            </div>
            <div style="font-size: 0.9em;">
              <div><strong>å§“åï¼š</strong>${status.personal_name || ''}</div>
              <div><strong>èº«ä»½ IDï¼š</strong>${status.personal_id || ''}</div>
              <div><strong>æœ€é«˜æ¬Šé™ï¼š</strong>${status.highest_authority ? 'æ˜¯' : 'å¦'}</div>
              <div><strong>MAC åœ°å€ï¼š</strong>${status.mac_address || 'æœªè¨­å®š'}</div>
              <div><strong>MAC é©—è­‰ï¼š</strong>${macMatch ? 'âœ… é€šé' : 'âŒ ä¸åŒ¹é…'}</div>
              <div><strong>ç¶å®šæ™‚é–“ï¼š</strong>${status.created_at || ''}</div>
            </div>
            <div style="margin-top: 12px;">
              <button id="btnShowVerifyForm" class="secondary">å¡«å¯«é©—è­‰è³‡æ–™</button>
              <button id="btnShowBiometric" class="secondary" style="margin-left: 8px;">ç”Ÿç‰©ç‰¹å¾µæƒæ</button>
            </div>
          `;
          formDiv.style.display = "none";
          
          // æª¢æŸ¥æ˜¯å¦å·²é©—è­‰
          const sess = window.__auth?.session || {};
          if (sess.personal_verified) {
            verifyDataDiv.style.display = "block";
            verifyFormDiv.style.display = "none";
          } else {
            verifyFormDiv.style.display = "block";
            verifyDataDiv.style.display = "none";
          }
          
          $("btnShowVerifyForm")?.addEventListener("click", () => {
            verifyFormDiv.style.display = "block";
          });
          
          $("btnShowBiometric")?.addEventListener("click", () => {
            $("biometricVerification").style.display = "block";
            getMacAddress();
          });
        } else {
          statusDiv.innerHTML = `
            <div style="color: #6c757d; margin-bottom: 12px;">
              âŒ å°šæœªç¶å®šå€‹äººèº«ä»½
            </div>
            <div class="muted" style="margin-bottom: 12px;">
              è«‹å¡«å¯«ä»¥ä¸‹è³‡æ–™ä»¥å»ºç«‹å€‹äºº AI ç¶å®š
            </div>
          `;
          formDiv.style.display = "block";
          verifyFormDiv.style.display = "none";
          verifyDataDiv.style.display = "none";
        }
      } catch (e) {
        $("personalBindingStatus").innerHTML = `
          <div style="color: #dc3545;">
            âŒ è¼‰å…¥ç‹€æ…‹å¤±æ•—ï¼š${String(e)}
          </div>
        `;
      }
    }

    async function createPersonalBinding() {
      const personalName = $("personalName").value.trim();
      const personalId = $("personalId").value.trim();
      const password = $("personalPassword").value;
      const passwordConfirm = $("personalPasswordConfirm").value;
      const email = $("personalEmail").value.trim();
      const phone = $("personalPhone").value.trim();
      const notes = $("personalNotes").value.trim();
      
      if (!personalName || !personalId || !password) {
        alert("è«‹å¡«å¯«å¿…å¡«æ¬„ä½ï¼ˆå§“åã€èº«ä»½ IDã€å¯†ç¢¼ï¼‰");
        return;
      }
      
      if (password !== passwordConfirm) {
        alert("å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ä¸€è‡´");
        return;
      }
      
      try {
        const { data } = await fetchJson("/api/personal_ai_binding/create", {
          method: "POST",
          body: JSON.stringify({
            personal_name: personalName,
            personal_id: personalId,
            password: password,
            email: email,
            phone: phone,
            notes: notes
          })
        });
        
        if (data?.ok) {
          alert("âœ… å€‹äºº AI ç¶å®šå»ºç«‹æˆåŠŸï¼");
          loadPersonalBindingStatus();
        } else {
          alert(`âŒ å»ºç«‹å¤±æ•—ï¼š${data?.error || "æœªçŸ¥éŒ¯èª¤"}`);
        }
      } catch (e) {
        alert(`âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š${String(e)}`);
      }
    }

    async function verifyPersonalIdentity() {
      const personalId = $("verifyPersonalId").value.trim();
      const password = $("verifyPassword").value;
      
      if (!personalId || !password) {
        alert("è«‹å¡«å¯«èº«ä»½ ID å’Œå¯†ç¢¼");
        return;
      }
      
      try {
        const { data } = await fetchJson("/api/personal_ai_binding/verify", {
          method: "POST",
          body: JSON.stringify({
            personal_id: personalId,
            password: password
          })
        });
        
        if (data?.ok && data?.verified) {
          alert("âœ… èº«ä»½é©—è­‰æˆåŠŸï¼");
          $("personalVerificationForm").style.display = "none";
          $("personalVerificationData").style.display = "block";
          loadPersonalBindingStatus();
        } else {
          alert(`âŒ é©—è­‰å¤±æ•—ï¼š${data?.error || "èº«ä»½ ID æˆ–å¯†ç¢¼éŒ¯èª¤"}`);
        }
      } catch (e) {
        alert(`âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š${String(e)}`);
      }
    }

    async function saveVerificationData() {
      const verificationDataText = $("verificationData").value.trim();
      
      if (!verificationDataText) {
        alert("è«‹å¡«å¯«é©—è­‰è³‡æ–™");
        return;
      }
      
      let verificationData;
      try {
        verificationData = JSON.parse(verificationDataText);
      } catch (e) {
        alert(`âŒ JSON æ ¼å¼éŒ¯èª¤ï¼š${String(e)}`);
        return;
      }
      
      try {
        const { data } = await fetchJson("/api/personal_ai_binding/update_verification", {
          method: "POST",
          body: JSON.stringify({
            verification_data: verificationData
          })
        });
        
        if (data?.ok) {
          alert("âœ… é©—è­‰è³‡æ–™å„²å­˜æˆåŠŸï¼");
        } else {
          alert(`âŒ å„²å­˜å¤±æ•—ï¼š${data?.error || "æœªçŸ¥éŒ¯èª¤"}`);
        }
      } catch (e) {
        alert(`âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š${String(e)}`);
      }
    }

    // ç¶å®šäº‹ä»¶
    $("btnCreateBinding")?.addEventListener("click", () => createPersonalBinding().catch(e => alert(String(e))));
    $("btnCancelBinding")?.addEventListener("click", () => {
      $("personalBindingForm").style.display = "none";
      loadPersonalBindingStatus();
    });
    $("btnVerifyIdentity")?.addEventListener("click", () => verifyPersonalIdentity().catch(e => alert(String(e))));
    $("btnSaveVerification")?.addEventListener("click", () => saveVerificationData().catch(e => alert(String(e))));

    // åˆå§‹è¼‰å…¥
    loadPersonalBindingStatus();
  </script>

  <script>
    // è·¯ç”±å™¨ç›£æ§åŠŸèƒ½
    let routerTrafficChart = null;
    let routerUpdateInterval = null;

    // è¼‰å…¥ Chart.jsï¼ˆå¦‚æœæœªè¼‰å…¥ï¼‰
    function loadChartJS() {
      return new Promise((resolve, reject) => {
        if (window.Chart) {
          resolve();
          return;
        }
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';
        script.onload = () => resolve();
        script.onerror = () => reject(new Error('ç„¡æ³•è¼‰å…¥ Chart.js'));
        document.head.appendChild(script);
      });
    }

    // æ›´æ–°è·¯ç”±å™¨ç‹€æ…‹
    async function updateRouterStatus() {
      try {
        // ç²å–é€£ç·šè£ç½®
        const devicesRes = await fetch('/api/router/devices');
        if (devicesRes.ok) {
          const devicesData = await devicesRes.json();
          if (devicesData.ok && devicesData.devices) {
            const count = devicesData.devices.total_count || 0;
            document.getElementById('routerDeviceCount').textContent = count;
            document.getElementById('routerDeviceDetails').textContent = 
              `${count} å€‹è£ç½®å·²é€£ç·š`;
            
            // æ›´æ–°è£ç½®åˆ—è¡¨
            const deviceList = document.getElementById('routerDeviceList');
            if (devicesData.devices.devices && devicesData.devices.devices.length > 0) {
              deviceList.innerHTML = devicesData.devices.devices.map(device => `
                <div style="padding: 8px; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between;">
                  <div>
                    <strong>${device.name || device.ip || 'æœªçŸ¥è£ç½®'}</strong><br>
                    <span class="muted small">${device.ip || ''}</span>
                    <span class="muted small">${device.mac || ''}</span>
                  </div>
                  <div class="muted small">${device.type || 'unknown'}</div>
                </div>
              `).join('');
            } else {
              deviceList.innerHTML = '<div class="muted">ç„¡é€£ç·šè£ç½®</div>';
            }
          }
        }
      } catch (e) {
        console.error('ç²å–è£ç½®åˆ—è¡¨å¤±æ•—:', e);
        document.getElementById('routerDeviceCount').textContent = '?';
        document.getElementById('routerDeviceDetails').textContent = 'è¼‰å…¥å¤±æ•—';
      }

      try {
        // ç²å–æµé‡è³‡è¨Š
        const trafficRes = await fetch('/api/router/traffic');
        if (trafficRes.ok) {
          const trafficData = await trafficRes.json();
          if (trafficData.ok && trafficData.traffic) {
            const traffic = trafficData.traffic;
            document.getElementById('routerUploadSpeed').textContent = 
              (traffic.upload_speed_mbps || 0).toFixed(2);
            document.getElementById('routerDownloadSpeed').textContent = 
              (traffic.download_speed_mbps || 0).toFixed(2);
            
            // æ›´æ–°æµé‡åœ–
            if (traffic.history && traffic.history.upload && traffic.history.download) {
              updateTrafficChart(traffic.history);
            }
          }
        }
      } catch (e) {
        console.error('ç²å–æµé‡è³‡è¨Šå¤±æ•—:', e);
        document.getElementById('routerUploadSpeed').textContent = '-';
        document.getElementById('routerDownloadSpeed').textContent = '-';
      }
    }

    // æ›´æ–°æµé‡åœ–
    function updateTrafficChart(history) {
      if (!routerTrafficChart) {
        return;
      }

      const labels = history.timestamps.map((ts, i) => {
        const date = new Date(ts);
        return date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
      });

      routerTrafficChart.data.labels = labels;
      routerTrafficChart.data.datasets[0].data = history.upload.map(v => (v / 1000000).toFixed(2));
      routerTrafficChart.data.datasets[1].data = history.download.map(v => (v / 1000000).toFixed(2));
      routerTrafficChart.update('none');
    }

    // åˆå§‹åŒ–æµé‡åœ–
    async function initTrafficChart() {
      await loadChartJS();
      
      const ctx = document.getElementById('routerTrafficChart');
      if (!ctx) return;

      routerTrafficChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            {
              label: 'ä¸Šå‚³ (Mbps)',
              data: [],
              borderColor: 'rgb(102, 126, 234)',
              backgroundColor: 'rgba(102, 126, 234, 0.1)',
              tension: 0.4
            },
            {
              label: 'ä¸‹è¼‰ (Mbps)',
              data: [],
              borderColor: 'rgb(40, 167, 69)',
              backgroundColor: 'rgba(40, 167, 69, 0.1)',
              tension: 0.4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Mbps'
              }
            }
          }
        }
      });
    }

    // ç¶å®šåˆ·æ–°æŒ‰éˆ•
    document.getElementById('btnRefreshRouter')?.addEventListener('click', () => {
      updateRouterStatus();
    });

    // åˆå§‹åŒ–
    (async () => {
      await initTrafficChart();
      updateRouterStatus();
      
      // æ¯ 30 ç§’è‡ªå‹•æ›´æ–°
      routerUpdateInterval = setInterval(updateRouterStatus, 30000);
    })();
  </script>

  <div id="maintBanner" class="maint-banner hidden">ï¼ˆæœ¬ç³»çµ±æœªç¶“åŸè¨­è¨ˆè€…åšå®šæœŸç¶­è­·ï¼Œå¯èƒ½å­˜åœ¨é¢¨éšªï¼‰</div>
      </div>
    </div>
  </div>
  
  <script>
    // è¢å¹•æ¨¡å¼åˆ‡æ›èˆ‡é¢æ¿ç®¡ç†
    (function() {
      const multiScreenContainer = document.querySelector('.multi-screen-container');
      const firstPanel = document.querySelector('.screen-panel');
      const fullscreenBtn = document.getElementById('fullscreenToggle');
      
      function createPanels(count) {
        // æ¸…é™¤ç¾æœ‰é¢æ¿ï¼ˆä¿ç•™ç¬¬ä¸€å€‹ï¼‰
        while (multiScreenContainer.children.length > 1) {
          multiScreenContainer.removeChild(multiScreenContainer.lastChild);
        }
        
        // è¤‡è£½é¢æ¿
        for (let i = 1; i < count; i++) {
          const newPanel = firstPanel.cloneNode(true);
          newPanel.classList.add('screen-panel');
          multiScreenContainer.appendChild(newPanel);
        }
      }
      
      function switchScreenMode(mode) {
        const count = parseInt(mode);
        document.body.setAttribute('data-screens', mode);
        localStorage.setItem('wuchang_screen_mode', mode);
        
        if (count > 1) {
          createPanels(count);
        } else {
          // å–®è¢å¹•æ¨¡å¼ï¼šç§»é™¤å¤šé¤˜é¢æ¿
          while (multiScreenContainer.children.length > 1) {
            multiScreenContainer.removeChild(multiScreenContainer.lastChild);
          }
        }
      }
      
      // å…¨è¢å¹•åŠŸèƒ½
      function toggleFullscreen() {
        if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement) {
          // é€²å…¥å…¨è¢å¹•
          if (document.documentElement.requestFullscreen) {
            document.documentElement.requestFullscreen();
          } else if (document.documentElement.webkitRequestFullscreen) {
            document.documentElement.webkitRequestFullscreen();
          } else if (document.documentElement.msRequestFullscreen) {
            document.documentElement.msRequestFullscreen();
          }
          document.body.classList.add('fullscreen');
          fullscreenBtn.textContent = 'â›¶ é€€å‡ºå…¨è¢å¹•';
          fullscreenBtn.classList.add('active');
        } else {
          // é€€å‡ºå…¨è¢å¹•
          if (document.exitFullscreen) {
            document.exitFullscreen();
          } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
          } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
          }
          document.body.classList.remove('fullscreen');
          fullscreenBtn.textContent = 'â›¶ å…¨è¢å¹•';
          fullscreenBtn.classList.remove('active');
        }
      }
      
      // ç›£è½å…¨è¢å¹•ç‹€æ…‹è®ŠåŒ–
      document.addEventListener('fullscreenchange', () => {
        if (!document.fullscreenElement) {
          document.body.classList.remove('fullscreen');
          fullscreenBtn.textContent = 'â›¶ å…¨è¢å¹•';
          fullscreenBtn.classList.remove('active');
        }
      });
      document.addEventListener('webkitfullscreenchange', () => {
        if (!document.webkitFullscreenElement) {
          document.body.classList.remove('fullscreen');
          fullscreenBtn.textContent = 'â›¶ å…¨è¢å¹•';
          fullscreenBtn.classList.remove('active');
        }
      });
      document.addEventListener('msfullscreenchange', () => {
        if (!document.msFullscreenElement) {
          document.body.classList.remove('fullscreen');
          fullscreenBtn.textContent = 'â›¶ å…¨è¢å¹•';
          fullscreenBtn.classList.remove('active');
        }
      });
      
      // åˆå§‹åŒ–
      const savedMode = localStorage.getItem('wuchang_screen_mode') || '1';
      switchScreenMode(savedMode);
      
      // è¢å¹•æ¨¡å¼æŒ‰éˆ•äº‹ä»¶
      const screenButtons = document.querySelectorAll('.screen-mode-selector button[data-screens]');
      screenButtons.forEach(btn => {
        if (btn.getAttribute('data-screens') === savedMode) {
          btn.classList.add('active');
        }
        btn.addEventListener('click', () => {
          const mode = btn.getAttribute('data-screens');
          switchScreenMode(mode);
          screenButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
        });
      });
      
      // å…¨è¢å¹•æŒ‰éˆ•äº‹ä»¶
      // é›™è¢å¹•å…¨è¢å¹•æ¨¡å¼
      function openDualScreenFullscreen() {
        const url = window.location.href.split('?')[0];
        const screen2Url = url + '?screen=2';
        
        // æ‰“é–‹ç¬¬äºŒå€‹è¢å¹•çš„è¦–çª—ï¼ˆå®šä½åˆ°ç¬¬äºŒå€‹è¢å¹•ï¼‰
        // å˜—è©¦å°‡è¦–çª—å®šä½åˆ°ä¸»è¢å¹•å³å´ï¼ˆç¬¬äºŒå€‹è¢å¹•ä½ç½®ï¼‰
        const leftPos = screen.width; // ä¸»è¢å¹•å¯¬åº¦ï¼Œç¬¬äºŒå€‹è¢å¹•æ‡‰è©²åœ¨å³å´
        const screen2Window = window.open(
          screen2Url,
          'screen2',
          `width=${screen.width},height=${screen.height},left=${leftPos},top=0,fullscreen=yes`
        );
        
        if (screen2Window) {
          // å»¶é²å¾Œé€²å…¥å…¨è¢å¹•
          setTimeout(() => {
            if (screen2Window.document) {
              screen2Window.document.documentElement.requestFullscreen?.() ||
              screen2Window.document.documentElement.webkitRequestFullscreen?.() ||
              screen2Window.document.documentElement.msRequestFullscreen?.();
            }
          }, 1000);
          
          // ç•¶å‰è¦–çª—ä¹Ÿé€²å…¥å…¨è¢å¹•
          setTimeout(() => {
            toggleFullscreen();
          }, 500);
        } else {
          alert('ç„¡æ³•æ‰“é–‹ç¬¬äºŒå€‹è¦–çª—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨çš„å½ˆå‡ºè¦–çª—é˜»æ“‹è¨­å®š');
        }
      }
      
      // æª¢æ¸¬ URL åƒæ•¸ï¼Œåˆ¤æ–·æ˜¯å¦ç‚ºç¬¬äºŒå€‹è¢å¹•
      const urlParams = new URLSearchParams(window.location.search);
      const isScreen2 = urlParams.get('screen') === '2';
      
      if (isScreen2) {
        // ç¬¬äºŒå€‹è¢å¹•ï¼šè‡ªå‹•é€²å…¥å…¨è¢å¹•
        document.body.setAttribute('data-screen-index', '2');
        setTimeout(() => {
          toggleFullscreen();
        }, 500);
      } else {
        // ç¬¬ä¸€å€‹è¢å¹•ï¼šé¡¯ç¤ºé›™è¢å¹•æŒ‰éˆ•
        const dualScreenBtn = document.createElement('button');
        dualScreenBtn.className = 'fullscreen-btn';
        dualScreenBtn.id = 'dualScreenBtn';
        dualScreenBtn.textContent = 'ğŸ–¥ï¸ é›™è¢å¹•å…¨è¢å¹•';
        dualScreenBtn.title = 'åœ¨å…©å€‹è¢å¹•ä¸Šåˆ†åˆ¥æ‰“é–‹å…¨è¢å¹•è¦–çª—';
        dualScreenBtn.style.marginLeft = '8px';
        
        const screenModeSelector = document.querySelector('.screen-mode-selector');
        if (screenModeSelector && fullscreenBtn) {
          fullscreenBtn.parentNode.insertBefore(dualScreenBtn, fullscreenBtn.nextSibling);
          dualScreenBtn.addEventListener('click', openDualScreenFullscreen);
        }
      }
      
      if (fullscreenBtn) {
        fullscreenBtn.addEventListener('click', toggleFullscreen);
        
        // éµç›¤å¿«æ·éµï¼šF11 æˆ– Ctrl+Enterï¼ˆåƒ…æ¡Œé¢ï¼‰
        if (!/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
          document.addEventListener('keydown', (e) => {
            if (e.key === 'F11' || (e.ctrlKey && e.key === 'Enter')) {
              e.preventDefault();
              toggleFullscreen();
            }
          });
        }
      }
      
      // æ‰‹æ©Ÿå„ªåŒ–ï¼šè‡ªå‹•èª¿æ•´è¢å¹•æ¨¡å¼
      function detectMobile() {
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isSmallScreen = window.innerWidth <= 768;
        
        if (isMobile || isSmallScreen) {
          // æ‰‹æ©Ÿè‡ªå‹•åˆ‡æ›ç‚ºå–®è¢å¹•æ¨¡å¼
          switchScreenMode('1');
          const screenButtons = document.querySelectorAll('.screen-mode-selector button[data-screens]');
          screenButtons.forEach(btn => {
            btn.classList.remove('active');
            if (btn.getAttribute('data-screens') === '1') {
              btn.classList.add('active');
            }
          });
          
          // éš±è—å¤šè¢å¹•åˆ‡æ›æŒ‰éˆ•ï¼ˆæ‰‹æ©Ÿä¸éœ€è¦ï¼‰
          screenButtons.forEach(btn => {
            if (btn.getAttribute('data-screens') !== '1') {
              btn.style.display = 'none';
            }
          });
        } else {
          // æ¡Œé¢é¡¯ç¤ºæ‰€æœ‰æŒ‰éˆ•
          const screenButtons = document.querySelectorAll('.screen-mode-selector button[data-screens]');
          screenButtons.forEach(btn => {
            btn.style.display = '';
          });
        }
      }
      
      // åˆå§‹æª¢æ¸¬
      detectMobile();
      
      // è¦–çª—å¤§å°è®ŠåŒ–æ™‚é‡æ–°æª¢æ¸¬
      let resizeTimer;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(detectMobile, 250);
      });
    })();
  </script>
</body>
</html>

