# 小J三階段權限系統說明

**建立日期**：2026-01-22  
**版本**：1.0  
**權限歸屬**：第一類可究責對象（系統創辦人，本系統設計人）

---

## 📋 三階段權限系統概述

小J採用三階段權限系統，根據使用者身份和可究責關係，提供不同層級的權限控制：

### 階段一：限縮權限（一般使用者）
- **適用對象**：一般使用者
- **權限等級**：最嚴格
- **限制方式**：採用一般AI限制，如同Gemini對於一般使用者
- **安全檢查**：
  - 嚴格檢查所有權限
  - 必須通過白名單（function catalog）
  - 必須通過節點限制
  - 必須通過同意檢查（consent）
  - 中風險以上操作需要確認

### 階段二：最高權限（系統管理員）
- **適用對象**：系統管理員（擁有 `admin_all` 權限）
- **權限等級**：最高限度開放
- **限制方式**：仍走白名單/同意/確認，但較寬鬆
- **安全檢查**：
  - 基本權限檢查（需有 `admin_all`）
  - 仍檢查白名單
  - 同意檢查較寬鬆（建議但不強制）
  - 僅關鍵風險操作需要確認

### 階段三：權限解放（系統創辦人）
- **適用對象**：系統創辦人，本系統設計人（第一類可究責對象）
- **權限等級**：無視任何安全規定
- **限制方式**：完全繞過所有安全檢查
- **認證方式**：**生物特徵辨認**（必須通過）
- **設計目的**：**緊急意外停機或封閉系統時的緊急修復機制**
- **核心原則**：**我們不知道何時會有問題，必須有完整的防禦功能**
- **安全檢查**：
  - **無視所有權限檢查**
  - **無視白名單限制**
  - **無視節點限制**
  - **無視同意檢查**
  - **無視風險等級**
  - **無視確認要求**
- **可究責性**：以可究責人身分，對所有操作負完全責任

---

## 🔍 權限階段判定邏輯

### 判定順序

1. **階段三判定**：
   - 檢查 `design_responsibility.natural_person.name` 是否為「系統創辦人，本系統設計人」
   - 檢查 `design_responsibility.natural_person.priority` 是否為 `1`
   - 符合條件 → 階段三

2. **階段二判定**：
   - 檢查 `permissions` 是否包含 `admin_all`
   - 符合條件 → 階段二

3. **階段一判定**：
   - 不符合階段二或階段三 → 階段一（預設）

### 判定實作

```python
def account_permission_stage(self, account_id: str) -> int:
    """
    取得帳號的權限階段
    1 = 階段一：限縮權限（一般AI限制，如同Gemini對於一般使用者）
    2 = 階段二：最高權限（唯系統管理員可用，最高限度開放）
    3 = 階段三：權限解放（唯系統創辦人可用，無視任何安全規定，以可究責人身分）
    """
    # 檢查是否為系統創辦人（第一類可究責對象）
    if design_responsibility.natural_person.name == "系統創辦人，本系統設計人" 
       and design_responsibility.natural_person.priority == 1:
        return 3  # 階段三：權限解放
    
    # 檢查是否為系統管理員
    if "admin_all" in permissions:
        return 2  # 階段二：最高權限
    
    # 預設：階段一：限縮權限
    return 1
```

---

## 🔒 各階段安全檢查對照表

| 安全檢查項目 | 階段一（限縮） | 階段二（最高權限） | 階段三（權限解放） |
|------------|--------------|-----------------|-----------------|
| **權限檢查** | ✅ 嚴格檢查 | ✅ 基本檢查（需admin_all） | ❌ 無視 |
| **白名單檢查** | ✅ 必須通過 | ✅ 仍檢查 | ❌ 無視 |
| **節點限制** | ✅ 必須通過 | ✅ 仍檢查 | ❌ 無視 |
| **同意檢查** | ✅ 必須通過 | ⚠️ 較寬鬆（建議） | ❌ 無視 |
| **風險等級** | ✅ 中風險以上需確認 | ✅ 僅關鍵風險需確認 | ❌ 無視 |
| **確認要求** | ✅ 嚴格要求 | ⚠️ 較寬鬆 | ❌ 無視 |

---

## 📝 階段三權限解放的特殊性

### 完全繞過安全檢查

階段三（系統創辦人）可以：
- **無視所有權限檢查**：不需要任何特定權限
- **無視白名單限制**：可以執行任何功能
- **無視節點限制**：可以在任何節點執行
- **無視同意檢查**：不需要任何同意
- **無視風險等級**：可以執行任何風險等級的操作
- **無視確認要求**：不需要任何確認

### 可究責性

階段三的權限解放是基於：
- **可究責人身分**：系統創辦人，本系統設計人為第一類可究責對象
- **權責相依關係**：設計者對設計內容負有完全責任
- **法律責任**：所有操作的法律責任由系統創辦人承擔

### 設計目的與使用場景

#### 設計目的
階段三權限解放的設計目的是為了**緊急意外停機或封閉系統時的緊急修復機制**。當系統面臨以下緊急情況時，需要能夠立即採取行動，而不被安全檢查機制阻擋：

1. **緊急意外停機**：
   - 系統完全無法運作
   - 服務中斷影響用戶
   - 需要立即重啟或修復
   - 無法等待權限審批流程

2. **系統封閉**：
   - 系統被惡意攻擊或入侵
   - 需要立即封閉系統防止擴散
   - 需要立即切斷網路連線
   - 需要立即停止所有服務

3. **緊急安全事件**：
   - 發現嚴重安全漏洞
   - 需要立即修補
   - 無法等待正常審批流程

#### 使用場景

階段三適用於以下緊急情況：
- **緊急意外停機修復**：系統完全無法運作時的緊急修復
- **系統封閉**：系統被攻擊或入侵時的緊急封閉
- **緊急安全修補**：發現嚴重安全漏洞時的立即修補
- **緊急服務恢復**：關鍵服務中斷時的立即恢復
- **緊急資料保護**：資料面臨風險時的立即保護措施
- **系統架構緊急變更**：需要立即調整系統架構以應對緊急情況
- **任何需要立即行動的緊急操作**：無法等待正常審批流程的緊急情況

#### 使用原則
- **僅限緊急情況**：只有在系統面臨緊急情況時才使用階段三權限
- **可究責性**：所有操作都必須記錄，系統創辦人對所有操作負完全責任
- **事後檢討**：緊急操作後必須進行事後檢討和記錄
- **最小必要原則**：只執行必要的緊急操作，避免過度使用

---

## 🎯 權限階段使用範例

### 階段一：一般使用者

```python
# 一般使用者嘗試執行高風險操作
job = {
    "type": "router_restart",
    "requester_account_id": "2001"  # 協會帳號
}

decision = decide_execution(store=store, job=job)
# 結果：ok=False, reason="missing_permission_router_admin", permission_stage=1
```

### 階段二：系統管理員

```python
# 系統管理員執行高風險操作
job = {
    "type": "router_restart",
    "requester_account_id": "1001"  # 維運管理帳號（有admin_all）
}

decision = decide_execution(store=store, job=job)
# 結果：ok=True, requires_confirm=True（關鍵風險需確認）, permission_stage=2
```

### 階段三：系統創辦人

```python
# 系統創辦人執行任何操作
job = {
    "type": "router_restart",
    "requester_account_id": "1001"  # 系統創辦人帳號
}

decision = decide_execution(store=store, job=job)
# 結果：ok=True, reason="allowed_stage3_founder_override", 
#       requires_confirm=False, permission_stage=3
```

---

## 📋 相關檔案

1. **政策控制**：`little_j_policy.py`
   - `account_permission_stage()`：判定權限階段
   - `decide_execution()`：執行權限檢查

2. **帳號政策**：`accounts_policy.json`
   - 定義帳號的 `design_responsibility`
   - 定義帳號的 `permissions`

3. **可究責對象設定**：`可究責對象設定說明.md`
   - 說明第一類可究責對象的設定

4. **小J檔案權限歸屬**：`小J檔案權限歸屬說明.md`
   - 說明小J相關檔案的權限歸屬

---

## ✅ 生效狀態

✅ **三階段權限系統已建立**

- [x] 權限階段判定邏輯已實作
- [x] 各階段安全檢查已設定
- [x] 階段三權限解放已實作
- [x] 可究責性已明確

---

**建立時間**：2026-01-22  
**最後更新**：2026-01-22  
**權限歸屬**：系統創辦人，本系統設計人（第一類可究責對象）
