# Cloudflare Tunnel 雙身份配置指南

**重要**：伺服器為雙網卡，有兩個不同的身份（名稱不同）。

---

## 📋 雙身份架構說明

### 網路架構
- **身份 1**：
  - 名稱：需要確認
  - 內部 IP：`192.168.50.249`（已知）
  - 網卡：網卡 1
  
- **身份 2**：
  - 名稱：需要確認
  - 內部 IP：需要確認
  - 網卡：網卡 2

### 配置考量
1. **服務分配**：不同服務可能使用不同的身份
2. **身份識別**：每個身份可能有不同的主機名稱
3. **路由配置**：需要確保路由器可以識別和路由到兩個身份

---

## 🔧 配置選項

### 選項 A：身份分離（推薦）

**不同服務使用不同的身份**：

```yaml
ingress:
  # 身份 1 的服務
  - hostname: wuchang.life
    service: http://192.168.50.249:80  # 身份 1 IP
  
  # 身份 2 的服務
  - hostname: app.wuchang.org.tw
    service: http://192.168.50.XXX:8069  # 身份 2 IP
```

### 選項 B：主身份統一

**所有服務使用主要身份**：

```yaml
ingress:
  # 所有服務使用身份 1
  - hostname: wuchang.life
    service: http://192.168.50.249:80
```

### 選項 C：容錯配置

**使用兩個身份作為主備**：

```yaml
ingress:
  # 主要路徑（身份 1）
  - hostname: wuchang.life
    service: http://192.168.50.249:80
  
  # 備援路徑（身份 2）
  - hostname: wuchang.life
    service: http://192.168.50.XXX:80
    originRequest:
      failoverTimeout: 10s
```

---

## 🚀 配置步驟

### 步驟 1：確認兩個身份資訊

**需要確認**：
1. **身份 1**：
   - 名稱：？
   - IP：`192.168.50.249`（已知）
   
2. **身份 2**：
   - 名稱：？
   - IP：？

### 步驟 2：確認服務分配

**確認每個服務使用哪個身份**：

| 服務 | 身份 | IP | 端口 |
|------|------|-----|------|
| wuchang.life | 身份 1/身份 2 | ? | 80 |
| app.wuchang.org.tw | 身份 1/身份 2 | ? | 8069 |
| ai.wuchang.org.tw | 身份 1/身份 2 | ? | 8080 |
| admin.wuchang.org.tw | 身份 1/身份 2 | ? | 9000 |
| monitor.wuchang.org.tw | 身份 1/身份 2 | ? | 3001 |

### 步驟 3：更新 config.yml

根據實際身份分配更新配置。

---

## 📝 配置範例

### 範例 1：身份分離配置

```yaml
tunnel: 837487dd-1536-43ec-a1c9-ee366a0aa4b7
credentials-file: /etc/cloudflared/credentials.json

ingress:
  # 身份 1 的服務（192.168.50.249）
  - hostname: wuchang.life
    service: http://192.168.50.249:80
  
  - hostname: www.wuchang.life
    service: http://192.168.50.249:80
  
  # 身份 2 的服務（192.168.50.XXX）
  - hostname: app.wuchang.org.tw
    service: http://192.168.50.XXX:8069
  
  - hostname: ai.wuchang.org.tw
    service: http://192.168.50.XXX:8080
  
  - hostname: admin.wuchang.org.tw
    service: http://192.168.50.249:9000
  
  - hostname: monitor.wuchang.org.tw
    service: http://192.168.50.249:3001
  
  - service: http_status:404
```

### 範例 2：使用主機名稱（如果配置了 DNS）

```yaml
ingress:
  # 使用身份 1 的主機名稱
  - hostname: wuchang.life
    service: http://identity1-hostname.local:80
  
  # 使用身份 2 的主機名稱
  - hostname: app.wuchang.org.tw
    service: http://identity2-hostname.local:8069
```

---

## 🔍 診斷工具

### 在伺服器上檢查兩個身份

```bash
# 查看所有網卡和 IP
ip addr show

# 查看主機名稱
hostname
hostname -I

# 查看所有主機名稱（如果配置了）
cat /etc/hosts

# 查看服務綁定
netstat -tuln | grep LISTEN
ss -tuln | grep LISTEN
```

### 測試兩個身份的連接

```bash
# 測試身份 1
curl http://192.168.50.249:80
curl http://identity1-hostname:80

# 測試身份 2
curl http://192.168.50.XXX:80
curl http://identity2-hostname:80
```

---

## ⚠️ 重要注意事項

### 1. 主機名稱解析

**如果使用主機名稱而非 IP**：
- 確保 Cloudflare Tunnel 容器可以解析主機名稱
- 可能需要配置 `/etc/hosts` 或 DNS
- 或使用 IP 地址更可靠

### 2. 路由器路由配置

**確保路由器可以路由到兩個身份**：
- 兩個 IP 都應該在路由器的內部網路中
- 路由器應該能夠訪問兩個 IP
- 可能需要配置靜態路由

### 3. 服務綁定確認

**確認每個服務綁定到正確的身份**：

```bash
# 檢查服務監聽的 IP
netstat -tuln | grep LISTEN

# 確認服務綁定到哪個網卡
ip addr show
```

---

## 📋 配置檢查清單

- [ ] 確認身份 1 的名稱和 IP（IP: 192.168.50.249）
- [ ] 確認身份 2 的名稱和 IP
- [ ] 確認每個服務使用哪個身份
- [ ] 選擇配置選項（身份分離 / 主身份統一 / 容錯）
- [ ] 更新 config.yml
- [ ] 測試兩個身份的連接
- [ ] 確認路由器可以訪問兩個身份
- [ ] 部署並驗證

---

**建立時間**：2026-01-22
