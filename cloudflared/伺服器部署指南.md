# Cloudflare Tunnel ä¼ºæœå™¨éƒ¨ç½²æŒ‡å—

**ç›®çš„**ï¼šç¢ºä¿ä¼ºæœå™¨ä¸Šçš„å¤–ç¶²è¨­å®šèˆ‡æœ¬åœ°ä¸€è‡´

---

## âœ… å·²åŒæ­¥çš„æª”æ¡ˆ

1. âœ… `cloudflared/config.yml` - Tunnel é…ç½®
2. âœ… `cloudflared/credentials.json` - Tunnel æ†‘è­‰

---

## ğŸš€ ä¼ºæœå™¨ç«¯éƒ¨ç½²æ­¥é©Ÿ

### æ­¥é©Ÿ 1ï¼šç¢ºèªæª”æ¡ˆå·²åŒæ­¥

**SSH åˆ°ä¼ºæœå™¨å¾ŒåŸ·è¡Œ**ï¼š

```bash
# ç¢ºèªæª”æ¡ˆå­˜åœ¨
ls -la cloudflared/
# æ‡‰è©²çœ‹åˆ°ï¼š
# - config.yml
# - credentials.json
```

### æ­¥é©Ÿ 2ï¼šæª¢æŸ¥ä¸¦èª¿æ•´å®¹å™¨åç¨±

**æª¢æŸ¥ä¼ºæœå™¨ä¸Šçš„å®¹å™¨åç¨±**ï¼š

```bash
docker ps --format "table {{.Names}}\t{{.Image}}"
```

**å¦‚æœå®¹å™¨åç¨±ä¸åŒï¼Œéœ€è¦ä¿®æ”¹ `config.yml`**ï¼š

ä¾‹å¦‚ï¼Œå¦‚æœä¼ºæœå™¨ä¸Šçš„å®¹å™¨æ˜¯ `wuchang-caddy-1` è€Œä¸æ˜¯ `wuchangv510-caddy-1`ï¼š

```bash
# ç·¨è¼¯ config.yml
nano cloudflared/config.yml

# å°‡æ‰€æœ‰ wuchangv510- æ”¹ç‚º wuchang-
# æˆ–æ ¹æ“šå¯¦éš›å®¹å™¨åç¨±èª¿æ•´
```

### æ­¥é©Ÿ 3ï¼šåœæ­¢ç¾æœ‰å®¹å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰

```bash
docker stop wuchang-cloudflared 2>/dev/null || true
docker rm wuchang-cloudflared 2>/dev/null || true
```

### æ­¥é©Ÿ 4ï¼šå•Ÿå‹• Cloudflare Tunnel å®¹å™¨

```bash
# ç¢ºèªç•¶å‰ç›®éŒ„
cd /path/to/wuchang-V5.1.0

# å•Ÿå‹•å®¹å™¨
docker run -d \
  --name wuchang-cloudflared \
  --restart unless-stopped \
  -v "$PWD/cloudflared/config.yml:/etc/cloudflared/config.yml:ro" \
  -v "$PWD/cloudflared/credentials.json:/etc/cloudflared/credentials.json:ro" \
  --network wuchang-network \
  cloudflare/cloudflared:latest tunnel run
```

**æˆ–ä½¿ç”¨ docker-compose**ï¼ˆå¦‚æœå·²é…ç½®ï¼‰ï¼š

```bash
docker-compose -f docker-compose.cloud.yml up -d cloudflared
```

### æ­¥é©Ÿ 5ï¼šæª¢æŸ¥å®¹å™¨ç‹€æ…‹

```bash
# æª¢æŸ¥å®¹å™¨æ˜¯å¦é‹è¡Œ
docker ps --filter "name=cloudflared"

# æª¢æŸ¥æ—¥èªŒ
docker logs wuchang-cloudflared --tail 50
```

**æ‡‰è©²çœ‹åˆ°**ï¼š
```
Starting tunnel tunnelID=837487dd-1536-43ec-a1c9-ee366a0aa4b7
Registered tunnel connection connIndex=0 location=...
```

---

## âš ï¸ é‡è¦æ³¨æ„äº‹é …

### 1. å®¹å™¨åç¨±å·®ç•°

**æœ¬åœ°é…ç½®**ï¼ˆ`config.yml`ï¼‰ï¼š
```yaml
service: http://wuchangv510-caddy-1:80
```

**ä¼ºæœå™¨å¯èƒ½éœ€è¦**ï¼š
```yaml
service: http://wuchang-caddy-1:80
```

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
- åœ¨éƒ¨ç½²å‰æª¢æŸ¥ä¼ºæœå™¨ä¸Šçš„å®¹å™¨åç¨±
- æ‰‹å‹•ä¿®æ”¹ `config.yml` ä¸­çš„æœå‹™åç¨±
- æˆ–ä½¿ç”¨ç’°å¢ƒè®Šæ•¸ä¾†å‹•æ…‹é…ç½®

### 2. æ†‘è­‰æª”æ¡ˆå®‰å…¨

**`credentials.json` åŒ…å«æ•æ„Ÿè³‡è¨Š**ï¼š
- âœ… å·²åŒæ­¥åˆ°ä¼ºæœå™¨
- âš ï¸ ç¢ºä¿æª”æ¡ˆæ¬Šé™æ­£ç¢ºï¼ˆ600ï¼‰
- âš ï¸ ä¸è¦æäº¤åˆ° Git

**è¨­å®šæª”æ¡ˆæ¬Šé™**ï¼š
```bash
chmod 600 cloudflared/credentials.json
```

### 3. ç¶²è·¯é…ç½®

**ç¢ºä¿ Docker ç¶²è·¯é…ç½®æ­£ç¢º**ï¼š

```bash
# æª¢æŸ¥ç¶²è·¯
docker network ls

# å¦‚æœä½¿ç”¨ docker-composeï¼Œç¶²è·¯æœƒè‡ªå‹•å»ºç«‹
# å¦‚æœæ‰‹å‹•å•Ÿå‹•ï¼Œéœ€è¦ç¢ºä¿å®¹å™¨åœ¨åŒä¸€ç¶²è·¯ä¸­
```

### 4. æœå‹™ä¾è³´

**ç¢ºä¿ä¾è³´çš„æœå‹™æ­£åœ¨é‹è¡Œ**ï¼š

```bash
# æª¢æŸ¥ Caddy å®¹å™¨
docker ps --filter "name=caddy"

# æª¢æŸ¥å…¶ä»–æœå‹™å®¹å™¨
docker ps --filter "name=wuchang"
```

---

## ğŸ”§ æ•…éšœæ’é™¤

### å•é¡Œ 1ï¼šå®¹å™¨ç„¡æ³•å•Ÿå‹•

**æª¢æŸ¥**ï¼š
```bash
# æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨
ls -la cloudflared/config.yml cloudflared/credentials.json

# æª¢æŸ¥æª”æ¡ˆå…§å®¹
cat cloudflared/config.yml
cat cloudflared/credentials.json | jq .TunnelID

# æª¢æŸ¥ Docker ç¶²è·¯
docker network inspect wuchang-network
```

### å•é¡Œ 2ï¼šç„¡æ³•é€£æ¥åˆ°æœå‹™

**æª¢æŸ¥**ï¼š
```bash
# æª¢æŸ¥æœå‹™å®¹å™¨æ˜¯å¦é‹è¡Œ
docker ps --filter "name=caddy"

# æª¢æŸ¥å®¹å™¨ç¶²è·¯é€£æ¥
docker exec wuchang-cloudflared ping -c 3 wuchangv510-caddy-1
# æˆ–
docker exec wuchang-cloudflared ping -c 3 wuchang-caddy-1
```

**å¦‚æœç„¡æ³•é€£æ¥**ï¼š
- æª¢æŸ¥å®¹å™¨åç¨±æ˜¯å¦æ­£ç¢º
- æª¢æŸ¥ Docker ç¶²è·¯é…ç½®
- æª¢æŸ¥æœå‹™å®¹å™¨æ˜¯å¦åœ¨åŒä¸€ç¶²è·¯ä¸­

### å•é¡Œ 3ï¼šTunnel é€£æ¥å¤±æ•—

**æª¢æŸ¥æ—¥èªŒ**ï¼š
```bash
docker logs wuchang-cloudflared --tail 100
```

**å¸¸è¦‹éŒ¯èª¤**ï¼š
- `Cannot determine default origin certificate path` - è­¦å‘Šï¼Œä¸å½±éŸ¿é‹ä½œ
- `Error locating origin cert` - æª¢æŸ¥ credentials.json æ˜¯å¦æ­£ç¢º
- `Connection refused` - æª¢æŸ¥æœå‹™å®¹å™¨æ˜¯å¦é‹è¡Œ

---

## âœ… é©—è­‰æ­¥é©Ÿ

### 1. æª¢æŸ¥å®¹å™¨ç‹€æ…‹

```bash
docker ps --filter "name=cloudflared"
# æ‡‰è©²é¡¯ç¤ºé‹è¡Œä¸­çš„å®¹å™¨
```

### 2. æª¢æŸ¥æ—¥èªŒ

```bash
docker logs wuchang-cloudflared --tail 30
# æ‡‰è©²çœ‹åˆ° "Registered tunnel connection"
```

### 3. æ¸¬è©¦ HTTPS è¨ªå•

åœ¨ç€è¦½å™¨è¨ªå•ï¼š
- https://wuchang.life
- https://www.wuchang.life

**é æœŸçµæœ**ï¼š
- âœ… æœ‰æ•ˆçš„ SSL è­‰æ›¸ï¼ˆé–é ­åœ–ç¤ºï¼‰
- âœ… ç¶²ç«™æ­£å¸¸è¼‰å…¥

### 4. æª¢æŸ¥ DNSï¼ˆç¢ºèªæœªä¿®æ”¹ï¼‰

åœ¨ Cloudflare Dashboard æª¢æŸ¥ï¼š
- âœ… `wuchang.life` çš„ A è¨˜éŒ„ä»ç„¶æ˜¯ `220.135.21.74`
- âœ… `www.wuchang.life` çš„ A è¨˜éŒ„ä»ç„¶æ˜¯ `220.135.21.74`
- âœ… **DNS è¨˜éŒ„æœªä¿®æ”¹**ï¼ˆç¬¦åˆ Google éç‡Ÿåˆ©è¦ç¯„ï¼‰

---

## ğŸ“‹ å¿«é€Ÿéƒ¨ç½²å‘½ä»¤

**å®Œæ•´éƒ¨ç½²æµç¨‹**ï¼š

```bash
# 1. ç¢ºèªæª”æ¡ˆå·²åŒæ­¥
ls -la cloudflared/

# 2. æª¢æŸ¥å®¹å™¨åç¨±
docker ps --format "{{.Names}}" | grep -E "caddy|wuchang"

# 3. åœæ­¢èˆŠå®¹å™¨
docker stop wuchang-cloudflared 2>/dev/null || true
docker rm wuchang-cloudflared 2>/dev/null || true

# 4. å•Ÿå‹•æ–°å®¹å™¨
docker run -d \
  --name wuchang-cloudflared \
  --restart unless-stopped \
  -v "$PWD/cloudflared/config.yml:/etc/cloudflared/config.yml:ro" \
  -v "$PWD/cloudflared/credentials.json:/etc/cloudflared/credentials.json:ro" \
  --network wuchang-network \
  cloudflare/cloudflared:latest tunnel run

# 5. æª¢æŸ¥ç‹€æ…‹
docker logs wuchang-cloudflared --tail 30
```

---

## ğŸ”„ æ›´æ–°é…ç½®

**å¦‚æœéœ€è¦æ›´æ–°é…ç½®**ï¼š

1. **åœ¨æœ¬åœ°ä¿®æ”¹é…ç½®**
2. **åŒæ­¥åˆ°ä¼ºæœå™¨**ï¼š
   ```bash
   python dual_j_file_sync_with_dns_replace.py --files cloudflared/config.yml
   ```
3. **åœ¨ä¼ºæœå™¨ä¸Šé‡å•Ÿå®¹å™¨**ï¼š
   ```bash
   docker restart wuchang-cloudflared
   ```

---

**å»ºç«‹æ™‚é–“**ï¼š2026-01-22  
**ç‹€æ…‹**ï¼šâœ… é…ç½®å·²åŒæ­¥ï¼Œç­‰å¾…ä¼ºæœå™¨ç«¯éƒ¨ç½²
