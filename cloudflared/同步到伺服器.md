# å°‡ Cloudflare Tunnel é…ç½®åŒæ­¥åˆ°ä¼ºæœå™¨

**ç›®çš„**ï¼šç¢ºä¿ä¼ºæœå™¨ä¸Šçš„å¤–ç¶²è¨­å®šèˆ‡æœ¬åœ°ä¸€è‡´

---

## ğŸ“‹ éœ€è¦åŒæ­¥çš„æª”æ¡ˆ

### 1. é…ç½®æª”æ¡ˆ
- `cloudflared/config.yml` - Tunnel é…ç½®
- `cloudflared/credentials.json` - Tunnel æ†‘è­‰ï¼ˆæ•æ„Ÿè³‡è¨Šï¼‰

### 2. æ³¨æ„äº‹é …
- âš ï¸ `credentials.json` åŒ…å«æ•æ„Ÿè³‡è¨Šï¼Œéœ€è¦å®‰å…¨å‚³è¼¸
- âš ï¸ ä¼ºæœå™¨ä¸Šçš„æœå‹™åç¨±å¯èƒ½éœ€è¦èª¿æ•´ï¼ˆå®¹å™¨åç¨±å¯èƒ½ä¸åŒï¼‰

---

## ğŸš€ åŒæ­¥æ­¥é©Ÿ

### æ­¥é©Ÿ 1ï¼šæº–å‚™ä¼ºæœå™¨é…ç½®æª”æ¡ˆ

**æª¢æŸ¥ä¼ºæœå™¨ä¸Šçš„å®¹å™¨åç¨±**ï¼š
- æœ¬åœ°ï¼š`wuchangv510-caddy-1`
- ä¼ºæœå™¨ï¼šå¯èƒ½æ˜¯ `wuchang-caddy-1` æˆ–å…¶ä»–åç¨±

**éœ€è¦ç¢ºèª**ï¼š
- ä¼ºæœå™¨ä¸Šçš„ Docker å®¹å™¨åç¨±
- ä¼ºæœå™¨ä¸Šçš„ç¶²è·¯é…ç½®

### æ­¥é©Ÿ 2ï¼šä½¿ç”¨æª”æ¡ˆåŒæ­¥è…³æœ¬

**ä½¿ç”¨ `dual_j_file_sync_with_dns_replace.py`**ï¼š

```powershell
python dual_j_file_sync_with_dns_replace.py
```

**æˆ–ä½¿ç”¨ `safe_sync_push.py`**ï¼ˆæ›´å®‰å…¨ï¼‰ï¼š

```powershell
python safe_sync_push.py --profile cloudflared --health-url "https://wuchang.life/health"
```

### æ­¥é©Ÿ 3ï¼šåœ¨ä¼ºæœå™¨ä¸Šé…ç½®å®¹å™¨

**SSH åˆ°ä¼ºæœå™¨å¾ŒåŸ·è¡Œ**ï¼š

```bash
# 1. ç¢ºèªæª”æ¡ˆå·²åŒæ­¥
ls -la cloudflared/

# 2. åœæ­¢ç¾æœ‰å®¹å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
docker stop wuchang-cloudflared 2>/dev/null || true
docker rm wuchang-cloudflared 2>/dev/null || true

# 3. å•Ÿå‹•æ–°å®¹å™¨
docker run -d \
  --name wuchang-cloudflared \
  --restart unless-stopped \
  -v "$PWD/cloudflared/config.yml:/etc/cloudflared/config.yml:ro" \
  -v "$PWD/cloudflared/credentials.json:/etc/cloudflared/credentials.json:ro" \
  --network wuchang-network \
  cloudflare/cloudflared:latest tunnel run

# 4. æª¢æŸ¥æ—¥èªŒ
docker logs wuchang-cloudflared --tail 30
```

---

## âš ï¸ é‡è¦æ³¨æ„äº‹é …

### 1. å®¹å™¨åç¨±å·®ç•°

**æœ¬åœ°é…ç½®**ï¼š
```yaml
service: http://wuchangv510-caddy-1:80
```

**ä¼ºæœå™¨å¯èƒ½éœ€è¦**ï¼š
```yaml
service: http://wuchang-caddy-1:80
```

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
- åœ¨åŒæ­¥å‰æª¢æŸ¥ä¼ºæœå™¨ä¸Šçš„å®¹å™¨åç¨±
- æˆ–ä½¿ç”¨ç’°å¢ƒè®Šæ•¸ä¾†å‹•æ…‹é…ç½®

### 2. æ†‘è­‰æª”æ¡ˆå®‰å…¨

**`credentials.json` åŒ…å«æ•æ„Ÿè³‡è¨Š**ï¼š
- ä¸è¦æäº¤åˆ° Git
- ä½¿ç”¨å®‰å…¨çš„æ–¹å¼å‚³è¼¸ï¼ˆSSHã€åŠ å¯†å‚³è¼¸ç­‰ï¼‰
- ç¢ºä¿ä¼ºæœå™¨ä¸Šçš„æª”æ¡ˆæ¬Šé™æ­£ç¢ºï¼ˆ600ï¼‰

### 3. ç¶²è·¯é…ç½®

**ç¢ºä¿ä¼ºæœå™¨ä¸Šçš„ Docker ç¶²è·¯é…ç½®æ­£ç¢º**ï¼š
- å®¹å™¨éœ€è¦èƒ½å¤ è¨ªå•å…¶ä»–æœå‹™å®¹å™¨
- æª¢æŸ¥ `docker-compose.yml` ä¸­çš„ç¶²è·¯è¨­å®š

---

## ğŸ“ è‡ªå‹•åŒ–è…³æœ¬

### å»ºç«‹ä¼ºæœå™¨éƒ¨ç½²è…³æœ¬

```python
# deploy_cloudflared_to_server.py
import subprocess
import os

def deploy_to_server():
    # 1. åŒæ­¥æª”æ¡ˆ
    subprocess.run(["python", "dual_j_file_sync_with_dns_replace.py"])
    
    # 2. SSH åˆ°ä¼ºæœå™¨ä¸¦åŸ·è¡Œéƒ¨ç½²å‘½ä»¤
    # ï¼ˆéœ€è¦é…ç½® SSH é‡‘é‘°ï¼‰
    pass
```

---

## âœ… é©—è­‰æ­¥é©Ÿ

### 1. æª¢æŸ¥æª”æ¡ˆåŒæ­¥

åœ¨ä¼ºæœå™¨ä¸Šç¢ºèªï¼š
```bash
ls -la cloudflared/
# æ‡‰è©²çœ‹åˆ° config.yml å’Œ credentials.json
```

### 2. æª¢æŸ¥å®¹å™¨ç‹€æ…‹

```bash
docker ps --filter "name=cloudflared"
# æ‡‰è©²çœ‹åˆ°é‹è¡Œä¸­çš„å®¹å™¨
```

### 3. æª¢æŸ¥æ—¥èªŒ

```bash
docker logs wuchang-cloudflared --tail 50
# æ‡‰è©²çœ‹åˆ° "Registered tunnel connection"
```

### 4. æ¸¬è©¦ HTTPS è¨ªå•

åœ¨ç€è¦½å™¨è¨ªå•ï¼š
- https://wuchang.life
- https://www.wuchang.life

---

## ğŸ”§ æ•…éšœæ’é™¤

### å•é¡Œ 1ï¼šå®¹å™¨ç„¡æ³•å•Ÿå‹•

**æª¢æŸ¥**ï¼š
- æª”æ¡ˆè·¯å¾‘æ˜¯å¦æ­£ç¢º
- æª”æ¡ˆæ¬Šé™æ˜¯å¦æ­£ç¢º
- Docker ç¶²è·¯æ˜¯å¦é…ç½®

### å•é¡Œ 2ï¼šç„¡æ³•é€£æ¥åˆ°æœå‹™

**æª¢æŸ¥**ï¼š
- å®¹å™¨åç¨±æ˜¯å¦æ­£ç¢º
- æœå‹™æ˜¯å¦æ­£åœ¨é‹è¡Œ
- ç¶²è·¯é…ç½®æ˜¯å¦æ­£ç¢º

### å•é¡Œ 3ï¼šæ†‘è­‰éŒ¯èª¤

**æª¢æŸ¥**ï¼š
- `credentials.json` æ˜¯å¦æ­£ç¢ºåŒæ­¥
- æª”æ¡ˆå…§å®¹æ˜¯å¦å®Œæ•´
- Tunnel ID æ˜¯å¦æ­£ç¢º

---

**å»ºç«‹æ™‚é–“**ï¼š2026-01-22
