# 五常路由器管理模組

## 📋 概述

此模組將路由器納管於 Odoo 系統，提供完整的路由器資產管理、連接設備追蹤、網路配置管理和伺服器雙身份管理功能。

---

## 🎯 功能

### 1. 路由器資產管理
- 路由器基本資訊（型號、IP、DDNS）
- 路由器狀態監控（在線/離線）
- 系統資訊（韌體版本、運行時間、CPU/記憶體使用率）
- 網路資訊（WAN IP、WAN 狀態）

### 2. 連接設備管理
- 自動從路由器同步設備列表
- 設備資訊（名稱、IP、MAC、類型）
- 自動識別伺服器身份
- 設備狀態追蹤（在線/離線）

### 3. 端口轉發規則管理
- 端口轉發規則列表
- 規則應用（直接應用到路由器）
- 規則同步（從路由器同步）

### 4. 伺服器雙身份管理
- **身份 1**：Wistron Neweb Corporation（有線網卡，IP: 192.168.50.249）
- **身份 2**：Wistron Neweb Corporation 2（WiFi 網卡，IP: 待確認）
- 身份與設備關聯
- Cloudflare Tunnel 配置管理

---

## 📦 安裝

### 前置需求

1. **Odoo 17.0** 或更高版本
2. **路由器模組**（在專案根目錄）：
   - `router_integration.py`
   - `router_full_control.py`

### 安裝步驟

1. **確認模組位置**
   ```
   wuchang_os/addons/wuchang_router_management/
   ```

2. **在 Odoo 中安裝**
   - 登入 Odoo
   - 前往：應用程式 → 更新應用程式清單
   - 搜尋 "五常路由器管理" 或 "wuchang_router_management"
   - 點擊「安裝」

3. **設定路由器認證**
   - 前往：路由器管理 → 路由器
   - 建立新記錄或編輯現有記錄
   - 填入路由器資訊：
     - 名稱：ASUS RT-BE86U
     - 內部 IP：192.168.50.84
     - 端口：8443
     - 用戶名和密碼

---

## 🚀 使用方式

### 1. 建立路由器記錄

1. 前往：**路由器管理 → 路由器**
2. 點擊「建立」
3. 填入資訊：
   - 名稱：ASUS RT-BE86U
   - 型號：ASUS RT-BE86U
   - 內部 IP：192.168.50.84
   - 外部 IP：220.135.21.74
   - DDNS：coffeeLofe.asuscomm.com
   - 端口：8443
   - 用戶名和密碼

### 2. 同步設備列表

1. 在路由器記錄中點擊「同步設備」
2. 系統會自動：
   - 從路由器 API 取得設備列表
   - 建立設備記錄
   - **自動識別伺服器身份**：
     - 名稱包含 "Wistron Neweb Corporation 2" → 身份 2（WiFi）
     - 名稱包含 "Wistron Neweb Corporation"（不含 2）→ 身份 1（有線）
     - IP 為 192.168.50.249 → 身份 1

### 3. 管理伺服器身份

1. 前往：**路由器管理 → 伺服器身份**
2. 點擊「建立預設身份」按鈕（自動建立兩個身份）
3. 或手動建立：
   - **身份 1**：
     - 名稱：Wistron Neweb Corporation
     - 類型：有線網卡
     - IP：192.168.50.249
     - 主要身份：是
   - **身份 2**：
     - 名稱：Wistron Neweb Corporation 2
     - 類型：WiFi 網卡
     - IP：（待確認）
     - 主要身份：否

### 4. 管理端口轉發規則

1. 前往：**路由器管理 → 端口轉發**
2. 在路由器記錄中點擊「同步端口轉發」
3. 或手動建立規則：
   - 規則名稱
   - 外部端口
   - 內部 IP（可選擇伺服器身份）
   - 內部端口
   - 協議（TCP/UDP/BOTH）

---

## 🔌 API 整合

### 整合現有路由器模組

模組會自動嘗試載入專案根目錄的：
- `router_integration.py` - 設備同步
- `router_full_control.py` - 端口轉發控制

如果模組未找到，相關功能將無法使用（會顯示錯誤訊息）。

### API 端點

模組提供以下 API 端點（需要登入）：

- `GET /api/router/status` - 取得路由器狀態
- `GET /api/router/devices` - 取得連接設備列表
- `GET /api/router/server_identities` - 取得伺服器身份列表

---

## 📋 伺服器身份自動識別

### 識別規則

1. **根據設備名稱**：
   - 包含 "Wistron Neweb Corporation 2" → 身份 2（WiFi）
   - 包含 "Wistron Neweb Corporation"（不含 2）→ 身份 1（有線）

2. **根據 IP 地址**：
   - IP = 192.168.50.249 → 身份 1（有線）

3. **手動設定**：
   - 在設備記錄中手動選擇伺服器身份

---

## 🔧 技術細節

### 模型

- `router.router` - 路由器模型
- `router.device` - 連接設備模型
- `router.port.forwarding` - 端口轉發規則模型
- `server.identity` - 伺服器身份模型

### 視圖

- 路由器：列表視圖、表單視圖
- 連接設備：列表視圖、表單視圖
- 伺服器身份：列表視圖、表單視圖
- 端口轉發：列表視圖、表單視圖

### 權限

所有已登入用戶都可以：
- 讀取、建立、編輯、刪除路由器相關記錄

---

## 📝 注意事項

1. **路由器認證**：確保路由器用戶名和密碼正確
2. **網路連線**：確保 Odoo 可以連接到路由器內部 IP
3. **模組路徑**：確保 `router_integration.py` 和 `router_full_control.py` 在專案根目錄
4. **身份 2 IP**：WiFi 網卡的 IP 需要手動確認並更新

---

## 🐛 疑難排解

### 無法同步設備

1. 檢查路由器認證資訊
2. 檢查網路連線
3. 檢查路由器模組是否載入（查看日誌）

### 無法識別伺服器身份

1. 確認設備名稱包含正確的關鍵字
2. 手動在設備記錄中設定伺服器身份

### 模組未載入路由器模組

- 確認 `router_integration.py` 和 `router_full_control.py` 在專案根目錄
- 檢查 Python 路徑設定

---

**建立時間**：2026-01-22  
**版本**：1.0.0
