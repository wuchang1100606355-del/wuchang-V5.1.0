# 兩機（本機/伺服器）風險動作 SOP（必讀）

更新時間：2026-01-15

> 定位：本文件與 **Google for Nonprofits 帳號/資源**同級，屬於「最高優先級保護資產」。  
> 規則：任何資料推送、索引重建、清理緩存、部署、重啟、網路/防火牆改動等「風險動作」，**每次執行前必須先檢視本 SOP 的檢核表**，並留下稽核紀錄。

---

## 0) 兩機定義

- **本機（Local）**：現場端/操作者端（例如 POS、門口端、開發/維運機、店內 PC）
- **伺服器（Server）**：棟伺服器或雲端伺服器（提供 API、索引、資料庫、稽核、通知、看板）

---

## 1) 風險動作的定義（只要符合任一項＝必走 SOP）

- **資料面**：覆蓋/搬移/刪除資料檔、批次匯入、資料推送、schema/欄位調整
- **索引面**：重建索引、切換索引版本、清理索引中間產物
- **快取面**：清理 cache/temp、刪除 blobs、清理 docker volume 內可疑檔
- **服務面**：重啟服務/容器、改設定、改環境變數、升級套件、改排程（cron/worker）
- **網路面**：路由/防火牆/ACL/port mapping/反代規則/DNS/憑證
- **安全面**：權限/角色/金鑰/Token、對外公開等級、稽核規則

---

## 2) 核心原則（不可違反）

- **2.0 無回應＝禁止高風險作業**：只要出現任一「關鍵確認」無回應/無法驗證（例如：伺服器健康檢查不可達、維護/降載模式不可確認、備份位置/校驗不可取得、版本輸出結果不可驗證），**立即中止**；不得以「先做再說」方式硬上。
- **2.1 先停後動**：只要會影響「正在讀/正在寫/正在同步」，先讓伺服器進入維護/降載模式（drain）。
- **2.2 版本化輸出**：新資料與新索引先落到「新版本目錄」，不覆蓋舊版本。
- **2.3 原子切換**：最後只做一次「指向切換」（例如切換 symlink/設定參數/檔名交換），縮短停機窗口。
- **2.4 可回滾**：必須能回到上一版（資料、索引、設定）。
- **2.5 稽核不可抵賴**：風險動作必須留下「誰、何時、做了什麼、為何、影響、結果」。

---

## 3) 標準流程（Start → Execute → Verify → Resume）

### 3.1 Start（事前告警/降載）

- **S1 維護宣告**：對內/對外公告「維護中」或「只讀模式」（視影響範圍）。
- **S2 伺服器進入維護模式**（drain）：
  - 暫停：索引/同步/排程/背景任務
  - 降載：拒絕寫入、只允許讀取（如可行）
- **S3 快照/備份**：
  - 備份：原始資料、舊索引、設定檔（最少三件）
  - 記錄：備份位置與校驗（hash/大小/時間）

### 3.2 Execute（執行風險動作）

- **E1 寫新版本**：資料/索引輸出到新版本路徑（例如 `data_vYYYYMMDD_HHMM` / `index_vYYYYMMDD_HHMM`）。
- **E2 禁止覆蓋舊檔**：除非明確回滾策略已寫好，否則不允許直接覆蓋舊版本。
- **E3 清理緩存**：只清「可再生」快取；禁止刪除原始資料或已驗收的索引成品。

### 3.3 Verify（驗證）

- **V1 完整性**：筆數/檔案數/校驗碼（hash）符合預期。
- **V2 健康檢查**：API/讀取/查詢/索引命中至少做 3 個關鍵用例。
- **V3 公開層驗證**：全球可見頁面是否仍符合去識別/公開規則（無外洩）。

### 3.4 Resume（切換/解除維護）

- **R1 原子切換**：切到新版本（只改一個指向）。
- **R2 恢復任務**：恢復排程、背景 worker、同步作業。
- **R3 解除告警**：發布「維護完成」事件與變更摘要。

---

## 4) 每次必填的「風險動作檢核表」（執行前必檢視）

> 這份清單每次執行前要完整走過一次；沒有全部勾完，不得執行。

- **回應檢核（無回應＝禁止）**
  - [ ] 我已取得「伺服器可達/健康」的回應證據（例如健康檢查/登入頁/狀態頁/可重現的回應碼）
  - [ ] 我已取得「維護/降載模式已生效」的回應證據（例如只讀、拒絕寫入、排程/worker 暫停狀態）
  - [ ] 若任一關鍵確認無回應/不可驗證：我已中止本次高風險作業（不硬上）
- **身份/權限**
  - [ ] 我是授權操作者（管理者/值班/指定角色）
  - [ ] 本次動作已記錄「操作者姓名/帳號/裝置」
- **影響範圍**
  - [ ] 我知道會影響哪些服務/哪些資料夾/哪些端點
  - [ ] 本次動作是否會覆蓋/刪除/搬移？（若是，必須可回滾）
- **伺服器狀態**
  - [ ] 已進入維護/降載模式（drain）
  - [ ] 已暫停索引/同步/排程/背景任務
- **備份/回滾**
  - [ ] 已備份資料/索引/設定（至少三件）
  - [ ] 已寫明回滾策略（回到哪一版、怎麼切回去）
  - [ ] 備份證據可取得（備份路徑/檔案大小或 hash/時間戳）
- **執行方式**
  - [ ] 新版本輸出到新路徑（版本化）
  - [ ] 最後只做一次原子切換
- **驗證**
  - [ ] 已完成完整性檢查（筆數/校驗）
  - [ ] 已完成健康檢查（至少 3 個關鍵用例）
- **稽核**
  - [ ] 已記錄：原因、變更內容、影響範圍、結果、異常處理

---

## 5) 稽核紀錄格式（最小必備欄位）

- `timestamp`
- `actor`（操作者）
- `machines`（local/server）
- `action_type`（data_push / index_rebuild / cache_purge / deploy / restart / firewall_change …）
- `paths`（涉及路徑）
- `services`（涉及服務）
- `reason`（原因）
- `result`（success/failed）
- `rollback_plan`（回滾指引）
- `evidence`（log/截圖/hash）

---

## 6) 最常見的風險動作範例（對照 SOP）

- **資料推送更新**：先維護→備份→新版本輸出→驗證→切換→解除維護
- **索引重建**：先停索引任務→重建到新索引→抽樣驗證→切換指向
- **清理緩存**：只清可再生快取；若不確定是否可再生，視為「資料」不得刪
- **重啟服務/容器**：先 drain（停止寫入）→重啟→健康檢查→恢復

---

## 7) 落地：同步推送必須使用「無回應＝禁止」閘門

- 同步推送（Local → Server）請使用 `safe_sync_push.py`。
- 規則：推送前**一定**先打 `--health-url`，只要無回應/不可驗證就會直接中止，並把過程寫進 `risk_action_audit.jsonl`。

範例（PowerShell）：

- 先確保伺服器有健康檢查端點（例如 `https://<your-domain>/health`）
- 推送到伺服器可讀取的資料夾（例如 SMB 分享）
  - `python safe_sync_push.py --profile rules --health-url "https://<your-domain>/health" --copy-to "\\\\SERVER\\share\\wuchang" --actor "ops"`
  - （或先設定環境變數）`$env:WUCHANG_HEALTH_URL="https://<your-domain>/health"; $env:WUCHANG_COPY_TO="\\\\SERVER\\share\\wuchang"`
